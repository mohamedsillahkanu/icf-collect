<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ICF Collect</title>
<meta name="theme-color" content="#004080">
<link rel="apple-touch-icon" href="https://github.com/mohamedsillahkanu/gdp-dashboard-2/raw/6c7463b0d5c3be150aafae695a4bcbbd8aeb1499/ICF-SL.jpg">
<link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}body{font-family:Oswald,Arial,sans-serif;background:#f5f5f5;min-height:100vh}.auth-container{min-height:100vh;display:flex;justify-content:center;align-items:center;background:linear-gradient(135deg,#004080 0,#001a33 100%);padding:20px}.auth-box{background:#fff;border-radius:12px;width:100%;max-width:420px;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,.3)}.auth-header{background:#004080;color:#fff;padding:25px;text-align:center}.auth-header img{width:80px;border-radius:10px;margin-bottom:12px;display:block;margin-left:auto;margin-right:auto}.auth-header h1{font-size:24px;margin-bottom:5px}.auth-header p{font-size:12px;opacity:.9}.auth-body{padding:25px}.auth-tabs{display:flex;margin-bottom:20px}.auth-tab{flex:1;padding:12px;text-align:center;cursor:pointer;font-weight:700;font-size:13px;border-bottom:3px solid #ddd;transition:all .2s}.auth-tab.active{border-bottom-color:#004080;color:#004080}.auth-form{display:none}.auth-form.active{display:block}.auth-group{margin-bottom:15px}.auth-label{display:block;font-size:11px;font-weight:700;margin-bottom:6px;text-transform:uppercase;color:#333}.auth-input{width:100%;padding:12px;border:2px solid #ddd;border-radius:6px;font-family:Oswald,sans-serif;font-size:14px}.auth-input:focus{outline:0;border-color:#004080}.auth-btn{width:100%;padding:14px;background:#004080;color:#fff;border:none;border-radius:6px;font-family:Oswald,sans-serif;font-weight:700;font-size:14px;cursor:pointer}.auth-error{background:#ffebee;color:#c62828;padding:10px;border-radius:6px;font-size:12px;margin-bottom:15px;display:none}.auth-success{background:#e8f5e9;color:#2e7d32;padding:10px;border-radius:6px;font-size:12px;margin-bottom:15px;display:none}.header{background:linear-gradient(135deg,#004080 0,#002855 100%);color:#fff;padding:12px 20px;display:flex;justify-content:space-between;align-items:center;position:fixed;top:0;left:0;right:0;z-index:1000;box-shadow:0 2px 10px rgba(0,0,0,.3)}.header-brand{display:flex;align-items:center;gap:12px}.header-logo{width:45px;height:45px;border-radius:8px}.header h1{font-size:20px}.header-actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center}.header-user{font-size:12px;background:rgba(255,255,255,.15);padding:6px 12px;border-radius:20px}.header-btn{background:#fff;color:#004080;border:none;padding:10px 16px;border-radius:6px;font-family:Oswald,sans-serif;font-weight:700;font-size:12px;cursor:pointer}.header-btn.primary{background:#ffc107;color:#000}.header-btn.success{background:#28a745;color:#fff}.header-btn.danger{background:#dc3545;color:#fff}.header-btn.dhis2{background:#17a2b8;color:#fff}.header-btn.sheets{background:#0f9d58;color:#fff}.main-container{display:none;margin-top:70px;height:calc(100vh - 100px)}.main-container.show{display:flex}.footer{background:#004080;color:#fff;padding:8px 20px;text-align:center;font-size:11px;position:fixed;bottom:0;left:0;right:0}.sidebar{width:220px;background:#fff;border-right:3px solid #004080;overflow-y:auto;padding:15px}.sidebar-section{margin-bottom:15px}.sidebar-title{font-size:11px;font-weight:700;color:#004080;margin-bottom:10px;padding-bottom:6px;border-bottom:2px solid #004080;text-transform:uppercase}.field-type{background:#f8f9fa;border:2px solid #ddd;border-radius:8px;padding:10px 12px;margin-bottom:6px;cursor:pointer;display:flex;align-items:center;gap:8px;font-size:12px;font-weight:600}.field-type:hover{border-color:#004080;background:#e8f4fc}.field-type.special{background:#e8f4fc;border-color:#17a2b8}.canvas-container{flex:1;display:flex;flex-direction:column;overflow:hidden}.canvas-header{background:#fff;padding:12px 20px;border-bottom:3px solid #004080;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px}.form-title-input{font-size:16px;font-weight:700;border:2px solid #ddd;padding:8px 12px;border-radius:6px;font-family:Oswald,sans-serif;width:300px}.canvas{flex:1;overflow-y:auto;padding:20px;background:#e9ecef}.form-preview{max-width:650px;margin:0 auto;background:#fff;border:4px double #004080;border-radius:12px;min-height:350px}.form-preview-header{background:linear-gradient(135deg,#004080 0,#002855 100%);color:#fff;padding:18px;text-align:center;border-radius:8px 8px 0 0}.form-preview-body{padding:18px;min-height:250px}.drop-zone{border:3px dashed #adb5bd;border-radius:10px;padding:40px;text-align:center;color:#6c757d}.drop-zone.has-fields{border:none;padding:0}.form-field{background:#fff;border:2px solid #dee2e6;border-radius:8px;padding:12px;margin-bottom:10px;cursor:pointer}.form-field:hover{border-color:#004080}.form-field.selected{border-color:#004080;border-width:3px;box-shadow:0 0 0 4px rgba(0,64,128,.2)}.form-field.dhis2-field{background:#e8f4fc;border-color:#17a2b8}.form-field-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}.form-field-label{font-weight:700;font-size:12px;color:#333}.form-field-actions{display:flex;gap:4px}.field-action-btn{background:#e9ecef;border:2px solid #adb5bd;cursor:pointer;font-size:14px;padding:6px 10px;border-radius:6px}.field-action-btn:hover{background:#004080;color:#fff}.field-action-btn.delete{background:#dc3545;color:#fff;border-color:#dc3545}.field-badge{padding:3px 8px;border-radius:12px;font-size:9px;font-weight:700;margin-left:8px}.field-badge.required{background:#f8d7da;color:#721c24}.field-badge.dhis2{background:#d1ecf1;color:#0c5460}.field-badge.aggregate{background:#d4edda;color:#155724}.field-badge.cascade{background:#e8f4fc;color:#004080}.field-badge.calc{background:#fff3cd;color:#856404}.form-field.cascade-field{border-left:3px solid #17a2b8}.section-divider{background:linear-gradient(135deg,#004080 0,#002855 100%);color:#fff;padding:12px 16px;margin:15px 0;border-radius:8px;font-weight:700;display:flex;justify-content:space-between;align-items:center;cursor:pointer}.properties-panel{width:340px;background:#fff;border-left:3px solid #004080;overflow-y:auto;padding:15px}.properties-title{font-size:12px;font-weight:700;color:#004080;margin-bottom:15px;padding-bottom:8px;border-bottom:2px solid #004080}.property-group{margin-bottom:12px}.property-label{display:block;font-size:10px;font-weight:700;color:#333;margin-bottom:5px;text-transform:uppercase}.property-input,.property-select{width:100%;padding:8px 10px;border:2px solid #dee2e6;border-radius:6px;font-family:Oswald,sans-serif;font-size:12px}.property-textarea{width:100%;padding:8px 10px;border:2px solid #dee2e6;border-radius:6px;font-family:Oswald,sans-serif;font-size:11px;min-height:60px}.property-checkbox{display:flex;align-items:center;gap:8px;cursor:pointer;font-size:11px;padding:6px 0}.property-checkbox input{width:18px;height:18px}.no-selection{text-align:center;color:#868e96;padding:40px 15px}.prop-section{background:#f8f9fa;border:2px solid #e9ecef;border-radius:8px;padding:12px;margin-bottom:15px}.prop-section-title{font-size:11px;font-weight:700;color:#004080;margin-bottom:10px}.logic-rule{background:#fff;border:2px solid #dee2e6;border-radius:6px;padding:10px;margin-bottom:8px;position:relative}.logic-rule.show{border-color:#28a745;background:#f0fff4}.logic-rule.hide{border-color:#dc3545;background:#fff5f5}.logic-rule-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}.logic-rule-type{font-size:10px;font-weight:700;padding:3px 8px;border-radius:4px}.logic-rule-type.show{background:#28a745;color:#fff}.logic-rule-type.hide{background:#dc3545;color:#fff}.logic-rule-delete{background:0 0;border:none;color:#dc3545;cursor:pointer;font-size:14px;padding:2px 6px}.logic-rule-row{display:flex;gap:6px;align-items:center;margin-bottom:6px;flex-wrap:wrap}.logic-select{padding:6px 8px;border:1px solid #dee2e6;border-radius:4px;font-size:11px;font-family:Oswald,sans-serif}.logic-input{padding:6px 8px;border:1px solid #dee2e6;border-radius:4px;font-size:11px;width:70px;font-family:Oswald,sans-serif}.logic-add-btn{background:#004080;color:#fff;border:none;padding:6px 12px;border-radius:4px;font-size:10px;cursor:pointer;font-family:Oswald,sans-serif;font-weight:700}.logic-add-btn:hover{background:#036}.logic-add-condition{background:#6c757d;color:#fff;border:none;padding:4px 8px;border-radius:4px;font-size:9px;cursor:pointer;margin-top:5px}.logic-connector{font-size:10px;font-weight:700;color:#6c757d;padding:2px 6px;background:#e9ecef;border-radius:3px}.validation-rule{background:#fff3cd;border:2px solid #ffc107;border-radius:6px;padding:10px;margin-bottom:8px}.validation-msg{font-size:10px;color:#856404;margin-top:5px}.field-hidden{display:none!important}.section-hidden{display:none!important}.calc-op-btn{background:#004080;color:#fff;border:none;padding:8px 14px;border-radius:6px;font-size:14px;font-weight:700;cursor:pointer;min-width:36px}.calc-op-btn:hover{background:#002855}.calc-num-btn{background:#6c757d;color:#fff;border:none;padding:6px 12px;border-radius:4px;font-size:11px;cursor:pointer}.calc-num-btn:hover{background:#545b62}.field-error input,.field-error select,.field-error textarea{border-color:#dc3545!important}.field-error-msg{color:#dc3545;font-size:10px;margin-top:4px}.modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.6);display:none;justify-content:center;align-items:center;z-index:2000;padding:20px;overflow-y:auto}.modal-overlay.show{display:flex}.modal{background:#fff;border-radius:12px;max-width:750px;width:100%;border:4px double #004080;max-height:90vh;overflow-y:auto}.modal-header{background:linear-gradient(135deg,#17a2b8 0,#138496 100%);color:#fff;padding:15px 20px;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:10}.modal-header.sheets{background:linear-gradient(135deg,#0f9d58 0,#0b8043 100%)}.modal-header.primary{background:linear-gradient(135deg,#004080 0,#002855 100%)}.modal-close{background:0 0;border:none;color:#fff;font-size:24px;cursor:pointer}.modal-body{padding:20px}.modal-btn{padding:12px 24px;border-radius:6px;font-family:Oswald,sans-serif;font-weight:700;font-size:13px;cursor:pointer;border:none}.modal-btn.primary{background:#004080;color:#fff}.modal-btn.success{background:#28a745;color:#fff}.modal-btn.danger{background:#dc3545;color:#fff}.modal-btn.dhis2{background:#17a2b8;color:#fff}.modal-btn.sheets{background:#0f9d58;color:#fff}.modal-btn.purple{background:#6f42c1;color:#fff}.modal-btn.orange{background:#fd7e14;color:#fff}.config-section{background:#f8f9fa;border:2px solid #e9ecef;border-radius:8px;padding:15px;margin-bottom:15px}.config-section.dhis2{background:#e8f4fc;border-color:#17a2b8}.config-section.sheets{background:#e6f4ea;border-color:#0f9d58}.config-title{font-size:13px;font-weight:700;margin-bottom:12px;display:flex;align-items:center;gap:8px}.config-title.dhis2{color:#17a2b8}.config-title.sheets{color:#0f9d58}.config-input{width:100%;padding:10px 12px;border:2px solid #dee2e6;border-radius:6px;font-family:Oswald,sans-serif;font-size:13px;margin-bottom:10px}.config-input:focus{outline:0;border-color:#004080}.config-label{display:block;font-size:10px;font-weight:700;color:#333;margin-bottom:5px;text-transform:uppercase}.config-row{display:grid;grid-template-columns:1fr 1fr;gap:10px}.help-text{font-size:10px;color:#666;margin-top:3px;font-style:italic}.status-badge{padding:12px 15px;border-radius:6px;font-size:12px;margin-bottom:15px;display:flex;align-items:center;gap:10px;font-weight:600}.status-badge.connected{background:#d4edda;color:#155724;border:2px solid #28a745}.status-badge.disconnected{background:#f8d7da;color:#721c24;border:2px solid #dc3545}.status-badge.syncing{background:#fff3cd;color:#856404;border:2px solid #ffc107}.sync-log{background:#1e1e1e;color:#0f0;padding:15px;border-radius:8px;font-family:monospace;font-size:11px;max-height:200px;overflow-y:auto;margin-top:15px}.log-entry{padding:3px 0;border-bottom:1px solid #333}.log-entry.error{color:#ff6b6b}.log-entry.success{color:#51cf66}.log-entry.warning{color:#ffd43b}.log-entry.info{color:#74c0fc}.qr-container{text-align:center;padding:20px}.qr-url{background:#f8f9fa;padding:12px;border-radius:6px;font-size:10px;word-break:break-all;margin-top:15px;max-height:80px;overflow-y:auto;font-family:monospace}.qr-actions{display:flex;gap:10px;justify-content:center;margin-top:15px}.notification{position:fixed;top:70px;right:20px;background:#28a745;color:#fff;padding:12px 20px;border-radius:8px;font-weight:700;font-size:12px;z-index:3000;display:none;max-width:350px}.notification.show{display:block}.notification.error{background:#dc3545}.notification.info{background:#17a2b8}.notification.warning{background:#ffc107;color:#333}.viewer-container{display:none;min-height:100vh;background:#e9ecef}.viewer-container.show{display:block}.viewer-nav{background:linear-gradient(135deg,#004080 0,#002855 100%);padding:12px 20px;display:flex;gap:8px;flex-wrap:wrap;align-items:center;position:sticky;top:0;z-index:100}.viewer-back-btn{background:#dc3545;color:#fff;border:none;padding:10px 18px;border-radius:6px;font-family:Oswald,sans-serif;font-weight:700;font-size:12px;cursor:pointer;margin-right:10px}.viewer-nav-btn{padding:10px 18px;border-radius:6px;font-family:Oswald,sans-serif;font-size:12px;font-weight:700;cursor:pointer;border:none}.viewer-nav-btn.active{box-shadow:0 0 0 3px rgba(255,255,255,.5)}.connection-status{padding:6px 12px;border-radius:20px;font-size:10px;font-weight:700;display:flex;align-items:center;gap:5px;margin-left:auto}.connection-status.online{background:#28a745;color:#fff}.connection-status.offline{background:#dc3545;color:#fff}.viewer-tab{display:none;padding:20px}.viewer-tab.active{display:block}.viewer-form{max-width:650px;margin:0 auto}.viewer-form-box{background:#fff;border:4px double #004080;border-radius:12px;overflow:hidden;box-shadow:0 4px 20px rgba(0,0,0,.15)}.viewer-header{background:linear-gradient(135deg,#004080 0,#002855 100%);color:#fff;padding:25px;text-align:center}.viewer-header img{width:70px;border-radius:10px;margin-bottom:10px;box-shadow:0 2px 10px rgba(0,0,0,.3)}.viewer-header h1{font-size:20px;margin-bottom:5px}.viewer-header p{font-size:12px;opacity:.9}.viewer-body{padding:25px}.viewer-field{margin-bottom:18px}.viewer-field-label{display:block;font-size:12px;font-weight:700;margin-bottom:6px;text-transform:uppercase;color:#333}.viewer-input{width:100%;padding:12px;border:2px solid #004080;border-radius:6px;font-family:Oswald,sans-serif;font-size:13px}.viewer-input:focus{outline:0;box-shadow:0 0 0 3px rgba(0,64,128,.2)}.viewer-radio-group{display:flex;flex-direction:column;gap:8px}.viewer-radio-option{display:flex;align-items:center;gap:6px;padding:10px 14px;border:2px solid #dee2e6;border-radius:6px;cursor:pointer;font-size:12px}.viewer-radio-option:hover{border-color:#004080;background:#e8f4fc}.page-header{background:#e8f4fc;margin:-25px -25px 20px -25px;padding:15px 25px;border-bottom:2px solid #004080}.page-indicator{display:inline-block;background:#004080;color:#fff;padding:4px 12px;border-radius:20px;font-size:10px;font-weight:700;margin-bottom:8px}.page-title{font-size:16px;color:#004080;font-weight:700;margin:0}.page-navigation{display:flex;justify-content:space-between;margin-top:25px;padding-top:20px;border-top:2px solid #e9ecef;gap:10px;flex-wrap:wrap}.nav-btn{padding:14px 28px;border:none;border-radius:6px;font-family:Oswald,sans-serif;font-size:14px;font-weight:700;cursor:pointer}.back-btn{background:#6c757d;color:#fff}.next-btn{background:#004080;color:#fff}.submit-btn{background:#28a745;color:#fff}.draft-actions-bar{display:flex;gap:10px;margin-top:20px;padding-top:15px;border-top:2px dashed #dee2e6;flex-wrap:wrap}.draft-save-btn,.draft-toggle-btn{padding:10px 16px;border:2px solid #6f42c1;border-radius:6px;font-family:Oswald,sans-serif;font-size:12px;cursor:pointer;display:flex;align-items:center;gap:6px}.draft-save-btn{background:#6f42c1;color:#fff}.draft-save-btn:hover{background:#5a32a3}.draft-toggle-btn{background:#fff;color:#6f42c1}.draft-toggle-btn:hover{background:#f3f0ff}.drafts-panel-wrapper{margin-top:15px;border:2px solid #6f42c1;border-radius:8px;background:#f8f9fa}.drafts-panel-header{display:flex;justify-content:space-between;align-items:center;padding:10px 15px;background:linear-gradient(135deg,#6f42c1 0,#5a32a3 100%);color:#fff;font-size:12px;font-weight:700;border-radius:6px 6px 0 0}.drafts-list{max-height:250px;overflow-y:auto}.draft-item{display:flex;justify-content:space-between;align-items:center;padding:12px 15px;border-bottom:1px solid #dee2e6;gap:10px}.draft-item:last-child{border-bottom:none}.draft-item:hover{background:#e9ecef}.draft-info{flex:1;min-width:0}.draft-preview{font-size:11px;font-weight:600;color:#333;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.draft-date{font-size:9px;color:#868e96;margin-top:2px}.draft-actions{display:flex;gap:6px}.draft-btn{padding:6px 10px;border:none;border-radius:4px;cursor:pointer;display:flex;align-items:center;justify-content:center}.draft-btn.load{background:#17a2b8;color:#fff}.draft-btn.load:hover{background:#138496}.draft-btn.delete{background:#dc3545;color:#fff}.draft-btn.delete:hover{background:#c82333}.cascade-container{display:flex;flex-direction:column;gap:12px}.cascade-level{display:flex;flex-direction:column;gap:4px}.cascade-label{font-size:10px;font-weight:600;color:#004080;text-transform:uppercase}.cascade-select{padding:10px 12px}.cascade-select:disabled{background:#e9ecef;cursor:not-allowed;opacity:.7}.data-table{width:100%;border-collapse:collapse;font-size:11px;margin-top:15px}.data-table td,.data-table th{border:1px solid #dee2e6;padding:10px;text-align:left}.data-table th{background:#004080;color:#fff;font-weight:700;font-size:10px;position:sticky;top:0}.data-table tr:nth-child(2n){background:#f8f9fa}.data-table tr:hover{background:#e8f4fc}.sync-badge{display:inline-block;padding:4px 10px;border-radius:12px;font-size:10px;font-weight:700}.sync-badge.synced{background:#d4edda;color:#155724}.sync-badge.pending{background:#fff3cd;color:#856404}.sync-badge.failed{background:#f8d7da;color:#721c24}.filter-panel{background:linear-gradient(135deg,#004080 0,#002855 100%);padding:15px;border-radius:8px;margin-bottom:20px}.filter-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}.filter-title{color:#fff;font-size:14px;font-weight:700}.filter-toggle{background:rgba(255,255,255,.2);color:#fff;border:none;padding:6px 12px;border-radius:6px;cursor:pointer;font-family:Oswald,sans-serif;font-size:11px}.filter-controls{display:flex;flex-wrap:wrap;gap:12px;align-items:flex-end}.filter-group{display:flex;flex-direction:column;gap:4px;min-width:140px;position:relative}.filter-group.with-arrows{padding-left:18px;padding-right:18px}.filter-arrow-btn{position:absolute;top:50%;transform:translateY(-50%);background:rgba(255,255,255,.2);border:none;border-radius:3px;cursor:pointer;padding:4px 3px;color:#fff;font-size:10px;line-height:1}.filter-arrow-btn:hover{background:rgba(255,255,255,.4)}.filter-arrow-btn.left{left:0}.filter-arrow-btn.right{right:0}.filter-label{color:rgba(255,255,255,.9);font-size:9px;font-weight:700;text-transform:uppercase}.filter-input,.filter-select{padding:8px 10px;border:none;border-radius:6px;font-family:Oswald,sans-serif;font-size:11px}.filter-btn{padding:8px 16px;border:none;border-radius:6px;font-family:Oswald,sans-serif;font-weight:700;font-size:11px;cursor:pointer}.filter-btn.apply{background:#28a745;color:#fff}.filter-btn.clear{background:#dc3545;color:#fff}.filter-count{background:#ffc107;color:#000;padding:3px 8px;border-radius:12px;font-size:10px;font-weight:700;margin-left:8px}.data-view-tabs{display:flex;gap:0;margin-bottom:20px}.data-view-tab{flex:1;padding:15px;text-align:center;cursor:pointer;font-weight:700;font-size:13px;border:2px solid #dee2e6;background:#f8f9fa}.data-view-tab:first-child{border-radius:8px 0 0 8px}.data-view-tab:last-child{border-radius:0 8px 8px 0}.data-view-tab.active{background:#004080;color:#fff;border-color:#004080}.data-view-tab.active.aggregate{background:#28a745;border-color:#28a745}.dashboard-container{max-width:1100px;margin:0 auto}.dashboard-header{background:linear-gradient(135deg,#004080 0,#002855 100%);color:#fff;padding:20px;border-radius:12px;margin-bottom:20px;text-align:center}.dashboard-header img{width:60px;border-radius:8px;margin-bottom:10px}.dashboard-header h2{font-size:18px;margin-bottom:5px}.dashboard-stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:15px;margin-bottom:20px}.stat-card{background:linear-gradient(135deg,#004080 0,#002855 100%);color:#fff;padding:20px;border-radius:10px;text-align:center;box-shadow:0 2px 10px rgba(0,0,0,.1)}.stat-card.success{background:linear-gradient(135deg,#28a745 0,#218838 100%)}.stat-card.warning{background:linear-gradient(135deg,#ffc107 0,#e0a800 100%);color:#000}.stat-card.info{background:linear-gradient(135deg,#17a2b8 0,#138496 100%)}.stat-card.purple{background:linear-gradient(135deg,#6f42c1 0,#59359a 100%)}.stat-card .stat-value{font-size:28px;font-weight:700}.stat-card .stat-label{font-size:10px;opacity:.9;margin-top:5px}.chart-container{background:#fff;border-radius:12px;padding:20px;margin-bottom:20px;box-shadow:0 2px 10px rgba(0,0,0,.1);border:2px solid #e9ecef}.chart-container h4{color:#004080;font-size:14px;margin-bottom:15px;padding-bottom:8px;border-bottom:2px solid #004080}.chart-wrapper{display:flex;gap:20px;flex-wrap:wrap;justify-content:center}.chart-box{flex:1;min-width:280px;max-width:400px}.aggregate-table{width:100%;border-collapse:collapse;font-size:12px}.aggregate-table th{background:#28a745;color:#fff;padding:12px;text-align:left;font-size:11px}.aggregate-table td{border:1px solid #dee2e6;padding:10px}.aggregate-table tr:nth-child(2n){background:#f8f9fa}.aggregate-table tr:hover{background:#e8f4fc}.inline-icon{display:inline-flex;align-items:center;vertical-align:middle;margin-right:4px}.inline-icon svg{display:block}.spinner{display:inline-block;width:16px;height:16px;border:2px solid #004080;border-radius:50%;border-top-color:transparent;animation:spin .8s linear infinite;vertical-align:middle;margin-right:8px}@keyframes spin{to{transform:rotate(360deg)}}.aggregate-value{font-weight:700;color:#004080}.sync-mode-selector{display:flex;gap:10px;margin-bottom:15px}.sync-mode-option{flex:1;padding:15px;border:3px solid #dee2e6;border-radius:8px;cursor:pointer;text-align:center}.sync-mode-option:hover{border-color:#004080}.sync-mode-option.selected{border-color:#004080;background:#e8f4fc}.sync-mode-option.selected.tracker{border-color:#6f42c1;background:#f3e8ff}.sync-mode-option h4{font-size:13px;margin-bottom:5px}.sync-mode-option p{font-size:10px;color:#666}@media (max-width:768px){.main-container{flex-direction:column}.properties-panel,.sidebar{width:100%;max-height:200px}.header{flex-wrap:wrap;padding:10px 15px}.header h1{font-size:16px}.form-title-input{width:100%}.config-row{grid-template-columns:1fr}.dashboard-stats{grid-template-columns:repeat(2,1fr)}.chart-box{min-width:100%}.filter-controls{flex-direction:column}.filter-group{width:100%}}</style></head>
<body>
    <!-- Auth Container -->
    <div class="auth-container" id="authContainer">
        <div class="auth-box">
            <div class="auth-header">
                <img src="https://github.com/mohamedsillahkanu/gdp-dashboard-2/raw/6c7463b0d5c3be150aafae695a4bcbbd8aeb1499/ICF-SL.jpg" alt="ICF-SL">
                <h1>ICF Collect</h1>
                <p>DHIS2 & Google Sheets Integration</p>
            </div>
            <div class="auth-body">
                <div class="auth-tabs">
                    <div class="auth-tab active" data-tab="login">Login</div>
                    <div class="auth-tab" data-tab="signup">Sign Up</div>
                </div>
                <div class="auth-error" id="authError"></div>
                <div class="auth-success" id="authSuccess"></div>
                <div class="auth-loading" id="authLoading" style="display:none;text-align:center;padding:10px;color:#004080;">
                    <span class="spinner"></span> Please wait...
                </div>
                <form class="auth-form active" id="loginForm">
                    <div class="auth-group">
                        <label class="auth-label">Email / Username</label>
                        <input type="text" class="auth-input" id="loginEmail" required placeholder="your@email.com or username">
                    </div>
                    <div class="auth-group">
                        <label class="auth-label">Password</label>
                        <input type="password" class="auth-input" id="loginPassword" required placeholder="Enter password">
                    </div>
                    <button type="submit" class="auth-btn"><span data-icon="unlock" data-size="14"></span> Login</button>
                    <div style="text-align:center;margin-top:12px;">
                        <a href="#" onclick="showForgotPassword()" style="color:#004080;font-size:12px;text-decoration:none;">Forgot Password?</a>
                    </div>
                </form>
                <form class="auth-form" id="signupForm">
                    <div class="auth-group">
                        <label class="auth-label">Full Name</label>
                        <input type="text" class="auth-input" id="signupName" required placeholder="John Doe">
                    </div>
                    <div class="auth-group">
                        <label class="auth-label">Email / Username</label>
                        <input type="text" class="auth-input" id="signupEmail" required placeholder="your@email.com or username">
                    </div>
                    <div class="auth-group">
                        <label class="auth-label">Password</label>
                        <input type="password" class="auth-input" id="signupPassword" required minlength="6" placeholder="Min 6 characters">
                    </div>
                    <button type="submit" class="auth-btn"><span data-icon="user-plus" data-size="14"></span> Create Account</button>
                </form>
                <form class="auth-form" id="forgotForm">
                    <div class="auth-group">
                        <label class="auth-label">Enter your email/username</label>
                        <input type="text" class="auth-input" id="forgotEmail" required placeholder="your@email.com or username">
                    </div>
                    <button type="submit" class="auth-btn" style="background:#28a745;"><span data-icon="mail" data-size="14"></span> Send Password</button>
                    <div style="text-align:center;margin-top:12px;">
                        <a href="#" onclick="switchAuthTab('login')" style="color:#004080;font-size:12px;text-decoration:none;">Back to Login</a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="header">
        <div class="header-brand">
            <img src="https://github.com/mohamedsillahkanu/gdp-dashboard-2/raw/6c7463b0d5c3be150aafae695a4bcbbd8aeb1499/ICF-SL.jpg" alt="ICF-SL" class="header-logo">
            <h1><span data-icon="clipboard-list" data-size="24"></span> ICF Collect</h1>
        </div>
        <div class="header-actions">
            <span class="header-user" id="headerUser"><span data-icon="user" data-size="14"></span> User</span>
            <button class="header-btn" onclick="showHome()"><span data-icon="home" data-size="14"></span> Home</button>
            <button class="header-btn success" onclick="newForm()"><span data-icon="file-plus" data-size="14"></span> New</button>
            <button class="header-btn" onclick="saveCurrentForm()"><span data-icon="save" data-size="14"></span> Save</button>
            <button class="header-btn" onclick="previewForm()"><span data-icon="eye" data-size="14"></span> Preview</button>
            <button class="header-btn dhis2" onclick="openDhis2Config()"><span data-icon="link" data-size="14"></span> DHIS2</button>
            <button class="header-btn primary" onclick="shareForm()"><span data-icon="share-2" data-size="14"></span> Share</button>
            <button class="header-btn danger" onclick="logout()"><span data-icon="log-out" data-size="14"></span> Logout</button>
        </div>
    </header>

    <!-- Main Container -->
    <div class="main-container" id="mainContainer">
        <div class="sidebar">
            <div class="sidebar-section">
                <h3 class="sidebar-title"><span data-icon="link" data-size="14"></span> DHIS2 Fields</h3>
                <div class="field-type special" data-type="period"><span data-icon="calendar-days" data-size="14"></span> Period (YYYYMM)</div>
            </div>
            <div class="sidebar-section">
                <h3 class="sidebar-title"><span data-icon="edit-3" data-size="14"></span> Basic Fields</h3>
                <div class="field-type" data-type="text"><span data-icon="type" data-size="14"></span> Text Input</div>
                <div class="field-type" data-type="number"><span data-icon="hash" data-size="14"></span> Number</div>
                <div class="field-type" data-type="calculation"><span data-icon="calculator" data-size="14"></span> Calculation</div>
                <div class="field-type" data-type="date"><span data-icon="calendar" data-size="14"></span> Date</div>
                <div class="field-type" data-type="time"><span data-icon="clock" data-size="14"></span> Time</div>
                <div class="field-type" data-type="email"><span data-icon="mail" data-size="14"></span> Email</div>
                <div class="field-type" data-type="phone"><span data-icon="phone" data-size="14"></span> Phone</div>
                <div class="field-type" data-type="textarea"><span data-icon="align-left" data-size="14"></span> Long Text</div>
            </div>
            <div class="sidebar-section">
                <h3 class="sidebar-title"><span data-icon="check-square" data-size="14"></span> Selection Fields</h3>
                <div class="field-type" data-type="select"><span data-icon="chevron-down-square" data-size="14"></span> Dropdown</div>
                <div class="field-type" data-type="radio"><span data-icon="circle-dot" data-size="14"></span> Radio Buttons</div>
                <div class="field-type" data-type="checkbox"><span data-icon="check-square" data-size="14"></span> Checkboxes</div>
                <div class="field-type" data-type="yesno"><span data-icon="toggle-left" data-size="14"></span> Yes / No</div>
            </div>
            <div class="sidebar-section">
                <h3 class="sidebar-title"><span data-icon="sparkles" data-size="14"></span> Special Fields</h3>
                <div class="field-type" data-type="gps"><span data-icon="map-pin" data-size="14"></span> GPS Location</div>
                <div class="field-type" data-type="qrcode"><span data-icon="qr-code" data-size="14"></span> QR/Barcode Scanner</div>
                <div class="field-type" data-type="cascade"><span data-icon="git-branch" data-size="14"></span> Cascading Dropdown</div>
                <div class="field-type" data-type="rating"><span data-icon="star" data-size="14"></span> Rating</div>
            </div>
            <div class="sidebar-section">
                <h3 class="sidebar-title"><span data-icon="layout" data-size="14"></span> Structure</h3>
                <div class="field-type" data-type="section"><span data-icon="folder" data-size="14"></span> Section / Page</div>
            </div>
        </div>

        <div class="canvas-container">
            <div class="canvas-header">
                <input type="text" class="form-title-input" id="formTitle" value="My Data Collection Form" placeholder="Form Title...">
                <span style="color:#666;font-size:12px;font-weight:600;" id="fieldCount"><span data-icon="bar-chart-3" data-size="12"></span> 0 fields</span>
            </div>
            <div class="canvas">
                <div class="form-preview">
                    <div class="form-preview-header">
                        <h2 id="previewTitle">My Data Collection Form</h2>
                        <p>ICF-SL Data Collection System</p>
                    </div>
                    <div class="form-preview-body">
                        <div class="drop-zone" id="dropZone">
                            <p style="font-size:48px;margin-bottom:12px;"><span data-icon="mouse-pointer-click" data-size="48"></span></p>
                            <p style="font-weight:600;">Click field types to add them</p>
                            <p style="font-size:11px;color:#868e96;margin-top:10px;">Add Period + Org Unit fields for DHIS2 sync</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="properties-panel" id="propertiesPanel">
            <h3 class="properties-title"><span data-icon="settings" data-size="16"></span> Field Properties</h3>
            <div id="propertiesContent">
                <div class="no-selection">
                    <p style="font-size:32px;margin-bottom:12px;"><span data-icon="mouse-pointer-click" data-size="32"></span></p>
                    <p>Select a field to edit</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Viewer Container -->
    <div class="viewer-container" id="viewerContainer"></div>
    <div class="viewer-container" id="homeContainer"></div>
    
    <!-- Footer -->
    <footer class="footer">© 2025 Informatics Consultancy Firm - Sierra Leone (ICF-SL) | ICF Collect v3</footer>

    <!-- DHIS2 Configuration Modal -->
    <div class="modal-overlay" id="dhis2Modal">
        <div class="modal">
            <div class="modal-header">
                <h3><span data-icon="link" data-size="18"></span> DHIS2 Configuration</h3>
                <button class="modal-close" onclick="closeModal('dhis2Modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div id="dhis2Status" class="status-badge disconnected">
                    <span data-icon="x-circle" data-size="14"></span> <span>Not Connected</span>
                </div>
                
                <div class="config-section dhis2">
                    <div class="config-title dhis2"><span data-icon="globe" data-size="14"></span> Server Connection</div>
                    <label class="config-label">DHIS2 Server URL</label>
                    <input type="url" class="config-input" id="dhis2Url" placeholder="https://your-dhis2-instance.org">
                    
                    <div class="config-row">
                        <div>
                            <label class="config-label">Username</label>
                            <input type="text" class="config-input" id="dhis2Username" placeholder="Username">
                        </div>
                        <div>
                            <label class="config-label">Password</label>
                            <input type="password" class="config-input" id="dhis2Password" placeholder="Password">
                        </div>
                    </div>
                </div>
                
                <div class="config-section">
                    <div class="config-title"><span data-icon="refresh-cw" data-size="14"></span> Sync Mode</div>
                    <div class="sync-mode-selector">
                        <div class="sync-mode-option selected" data-mode="aggregate" onclick="selectSyncMode('aggregate')">
                            <h4><span data-icon="bar-chart-3" data-size="16"></span> Aggregate</h4>
                            <p>Creates Dataset + Data Elements</p>
                            <p style="font-size:9px;color:#004080;margin-top:4px;">Syncs summarized data by Facility/Period</p>
                        </div>
                        <div class="sync-mode-option" data-mode="tracker" onclick="selectSyncMode('tracker')">
                            <h4><span data-icon="clipboard-list" data-size="16"></span> Event Program</h4>
                            <p>Creates Program + Data Elements</p>
                            <p style="font-size:9px;color:#6f42c1;margin-top:4px;">Syncs each record as individual event</p>
                        </div>
                    </div>
                    
                    <div id="aggregateConfig">
                        <div class="config-row">
                            <div>
                                <label class="config-label">Period Column</label>
                                <select class="config-input" id="dhis2PeriodColumn">
                                    <option value="">-- Select field --</option>
                                </select>
                                <p class="help-text" style="font-size:10px;color:#666;margin-top:4px;">Field with period (YYYYMM)</p>
                            </div>
                            <div>
                                <label class="config-label">Org Unit Column</label>
                                <select class="config-input" id="dhis2OrgUnitColumn">
                                    <option value="">-- Select field --</option>
                                </select>
                                <p class="help-text" style="font-size:10px;color:#666;margin-top:4px;">Field with facility/org unit name</p>
                            </div>
                        </div>
                        <div class="config-row">
                            <div>
                                <label class="config-label">Org Unit Level</label>
                                <select class="config-input" id="dhis2OrgLevel">
                                    <option value="1">Level 1 (National)</option>
                                    <option value="2">Level 2 (Region)</option>
                                    <option value="3">Level 3 (District)</option>
                                    <option value="4">Level 4 (Chiefdom)</option>
                                    <option value="5" selected>Level 5 (Facility)</option>
                                    <option value="6">Level 6</option>
                                </select>
                            </div>
                            <div>
                                <label class="config-label">Period Type</label>
                                <select class="config-input" id="dhis2PeriodType">
                                    <option value="Monthly" selected>Monthly</option>
                                    <option value="Weekly">Weekly</option>
                                    <option value="Daily">Daily</option>
                                    <option value="Quarterly">Quarterly</option>
                                    <option value="Yearly">Yearly</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div id="trackerConfig" style="display:none;">
                        <label class="config-label">Program ID</label>
                        <input type="text" class="config-input" id="dhis2ProgramId" placeholder="Leave empty to auto-create, or enter existing Program ID">
                        <p class="help-text">Leave empty: Setup will create a new Event Program. Or enter an existing Program UID to use it.</p>
                    </div>
                </div>
                
                <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:15px;">
                    <button class="modal-btn dhis2" onclick="testDhis2Connection()"><span data-icon="search" data-size="14"></span> Test Connection</button>
                    <button class="modal-btn primary" onclick="saveDhis2Config()"><span data-icon="save" data-size="14"></span> Save Config</button>
                </div>
                
                <div class="config-section">
                    <div class="config-title"><span data-icon="rocket" data-size="14"></span> Setup & Sync Actions</div>
                    <p style="font-size:11px;color:#666;margin-bottom:15px;">
                        <strong>Setup DHIS2:</strong> Creates Dataset/Program and Data Elements<br>
                        <strong>Sync Case-Based:</strong> Pushes individual records as Events (Tracker)<br>
                        <strong>Sync Aggregate:</strong> Pushes aggregated data values (DataSets)
                    </p>
                    <div style="display:flex;gap:10px;flex-wrap:wrap;">
                        <button class="modal-btn success" onclick="setupDhis2()" style="flex:1;"><span data-icon="settings" data-size="14"></span> Setup DHIS2</button>
                    </div>
                    <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;">
                        <button class="modal-btn purple" onclick="syncCaseBased()" style="flex:1;"><span data-icon="list" data-size="14"></span> Sync Case-Based</button>
                        <button class="modal-btn" onclick="syncAggregate()" style="flex:1;background:#17a2b8;color:#fff;"><span data-icon="bar-chart-3" data-size="14"></span> Sync Aggregate</button>
                    </div>
                </div>
                
                <div class="sync-log" id="syncLog">
                    <div class="log-entry info">Ready...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Share Modal -->
    <div class="modal-overlay" id="shareModal">
        <div class="modal">
            <div class="modal-header primary">
                <h3><span data-icon="share-2" data-size="18"></span> Share Form</h3>
                <button class="modal-close" onclick="closeModal('shareModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="qr-container">
                    <div style="font-weight:700;color:#004080;margin-bottom:10px;"><span data-icon="link" data-size="14"></span> Share Link</div>
                    <div class="qr-url" id="shareUrl"></div>
                    <div class="qr-actions">
                        <button class="modal-btn primary" onclick="copyShareUrl()"><span data-icon="copy" data-size="14"></span> Copy URL</button>
                    </div>
                </div>
                
                <div style="background:#e3f2fd;padding:15px;border-radius:8px;margin-top:20px;">
                    <h4 style="color:#1565c0;margin:0 0 10px 0;"><span data-icon="info" data-size="14"></span> What's included in the shared link</h4>
                    <ul style="margin:0;padding-left:20px;font-size:12px;color:#333;">
                        <li>✓ Form fields and configuration</li>
                        <li>✓ Automatic Google Sheets sync (sheet = form name)</li>
                        <li>✓ DHIS2 connection & credentials (if configured)</li>
                        <li>✓ Full sync capability to DHIS2</li>
                    </ul>
                </div>
                
                <div style="background:#fff3cd;padding:15px;border-radius:8px;margin-top:10px;">
                    <h4 style="color:#856404;margin:0 0 5px 0;"><span data-icon="alert-triangle" data-size="14"></span> Security Note</h4>
                    <p style="margin:0;font-size:12px;color:#856404;">DHIS2 credentials are embedded in the link. Only share with trusted users.</p>
                </div>
            </div>
        </div>
    </div>

    <div class="notification" id="notification"></div>
    
    <!-- Offline Indicator -->
    <div id="offlineIndicator" style="display:none;position:fixed;top:0;left:0;right:0;background:#dc3545;color:white;padding:8px;text-align:center;font-size:12px;font-weight:600;z-index:10000;">
        ⚠️ You are offline - Data will sync when back online
    </div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
const icons={"clipboard-list":'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="M12 11h4"/><path d="M12 16h4"/><path d="M8 11h.01"/><path d="M8 16h.01"/></svg>',home:'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>',"file-plus":'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="12" y1="18" x2="12" y2="12"/><line x1="9" y1="15" x2="15" y2="15"/></svg>',save:'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>',eye:'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>',link:'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>',"share-2":'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg>',"log-out":'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>',user:'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>',"user-plus":'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></svg>',unlock:'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 9.9-1"/></svg>',calendar:'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>',"calendar-days":'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/><path d="M8 14h.01"/><path d="M12 14h.01"/><path d="M16 14h.01"/><path d="M8 18h.01"/><path d="M12 18h.01"/><path d="M16 18h.01"/></svg>',type:'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="4 7 4 4 20 4 20 7"/><line x1="9" y1="20" x2="15" y2="20"/><line x1="12" y1="4" x2="12" y2="20"/></svg>',hash:'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="4" y1="9" x2="20" y2="9"/><line x1="4" y1="15" x2="20" y2="15"/><line x1="10" y1="3" x2="8" y2="21"/><line x1="16" y1="3" x2="14" y2="21"/></svg>',clock:'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>',mail:'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>',phone:'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>',"align-left":'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="17" y1="10" x2="3" y2="10"/><line x1="21" y1="6" x2="3" y2="6"/><line x1="21" y1="14" x2="3" y2="14"/><line x1="17" y1="18" x2="3" y2="18"/></svg>',"chevron-down-square":'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><polyline points="8 10 12 14 16 10"/></svg>',"circle-dot":'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="1"/></svg>',"check-square":'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>',"toggle-left":'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="5" width="22" height="14" rx="7" ry="7"/><circle cx="8" cy="12" r="3"/></svg>',"map-pin":'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>',star:'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>',folder:'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>',"text-cursor-input":'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 4h1a3 3 0 0 1 3 3 3 3 0 0 1 3-3h1"/><path d="M13 20h-1a3 3 0 0 1-3-3 3 3 0 0 1-3 3H5"/><path d="M5 16H4a2 2 0 0 1-2-2v-4a2 2 0 0 1 2-2h1"/><path d="M13 8h7a2 2 0 0 1 2 2v4a2 2 0 0 1-2 2h-7"/><path d="M9 7v10"/></svg>',sparkles:'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M19 17v4"/><path d="M3 5h4"/><path d="M17 19h4"/></svg>',layout:'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="9" y1="21" x2="9" y2="9"/></svg>',download:'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>',settings:'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>',"mouse-pointer-click":'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 9 5 12 1.8-5.2L21 14Z"/><path d="M7.2 2.2 8 5.1"/><path d="m5.1 8-2.9-.8"/><path d="M14 4.1 12 6"/><path d="m6 12-1.9 2"/></svg>',"chevron-up":'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="18 15 12 9 6 15"/></svg>',"chevron-down":'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>',"trash-2":'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>',globe:'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>',"git-branch":'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="6" y1="3" x2="6" y2="15"/><circle cx="18" cy="6" r="3"/><circle cx="6" cy="18" r="3"/><path d="M18 9a9 9 0 0 1-9 9"/></svg>',"flask-conical":'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 2v7.527a2 2 0 0 1-.211.896L4.72 20.55a1 1 0 0 0 .9 1.45h12.76a1 1 0 0 0 .9-1.45l-5.069-10.127A2 2 0 0 1 14 9.527V2"/><path d="M8.5 2h7"/><path d="M7 16h10"/></svg>',rocket:'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4.5 16.5c-1.5 1.26-2 5-2 5s3.74-.5 5-2c.71-.84.7-2.13-.09-2.91a2.18 2.18 0 0 0-2.91-.09z"/><path d="m12 15-3-3a22 22 0 0 1 2-3.95A12.88 12.88 0 0 1 22 2c0 2.72-.78 7.5-6 11a22.35 22.35 0 0 1-4 2z"/><path d="M9 12H4s.55-3.03 2-4c1.62-1.08 5 0 5 0"/><path d="M12 15v5s3.03-.55 4-2c1.08-1.62 0-5 0-5"/></svg>',"refresh-cw":'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 2v6h-6"/><path d="M3 12a9 9 0 0 1 15-6.7L21 8"/><path d="M3 22v-6h6"/><path d="M21 12a9 9 0 0 1-15 6.7L3 16"/></svg>',smartphone:'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="5" y="2" width="14" height="20" rx="2" ry="2"/><line x1="12" y1="18" x2="12.01" y2="18"/></svg>',copy:'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>',"check-circle":'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>',cloud:'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.5 19H9a7 7 0 1 1 6.71-9h1.79a4.5 4.5 0 1 1 0 9Z"/></svg>',info:'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>',"alert-triangle":'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg>',"x-circle":'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>',loader:'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="2" x2="12" y2="6"/><line x1="12" y1="18" x2="12" y2="22"/><line x1="4.93" y1="4.93" x2="7.76" y2="7.76"/><line x1="16.24" y1="16.24" x2="19.07" y2="19.07"/><line x1="2" y1="12" x2="6" y2="12"/><line x1="18" y1="12" x2="22" y2="12"/><line x1="4.93" y1="19.07" x2="7.76" y2="16.24"/><line x1="16.24" y1="7.76" x2="19.07" y2="4.93"/></svg>',database:'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg>',"building-2":'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 22V4a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v18Z"/><path d="M6 12H4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h2"/><path d="M18 9h2a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2h-2"/><path d="M10 6h4"/><path d="M10 10h4"/><path d="M10 14h4"/><path d="M10 18h4"/></svg>',"bar-chart-3":'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></svg>',inbox:'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 16 12 14 15 10 15 8 12 2 12"/><path d="M5.45 5.11 2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89A2 2 0 0 0 16.76 4H7.24a2 2 0 0 0-1.79 1.11z"/></svg>',plus:'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>',pencil:'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>',"file-text":'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>',"arrow-left":'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>',"arrow-right":'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>',table:'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="3" y1="15" x2="21" y2="15"/><line x1="9" y1="3" x2="9" y2="21"/><line x1="15" y1="3" x2="15" y2="21"/></svg>',"bar-chart-2":'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>',wifi:'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12.55a11 11 0 0 1 14.08 0"/><path d="M1.42 9a16 16 0 0 1 21.16 0"/><path d="M8.53 16.11a6 6 0 0 1 6.95 0"/><line x1="12" y1="20" x2="12.01" y2="20"/></svg>',"wifi-off":'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="1" y1="1" x2="23" y2="23"/><path d="M16.72 11.06A10.94 10.94 0 0 1 19 12.55"/><path d="M5 12.55a10.94 10.94 0 0 1 5.17-2.39"/><path d="M10.71 5.05A16 16 0 0 1 22.58 9"/><path d="M1.42 9a15.91 15.91 0 0 1 4.7-2.88"/><path d="M8.53 16.11a6 6 0 0 1 6.95 0"/><line x1="12" y1="20" x2="12.01" y2="20"/></svg>',check:'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>',x:'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>',search:'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>',"trending-up":'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>',"edit-3":'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>',list:'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>',upload:'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>',filter:'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>',layers:'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 2 7 12 12 22 7 12 2"/><polyline points="2 17 12 22 22 17"/><polyline points="2 12 12 17 22 12"/></svg>',activity:'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>',"file-spreadsheet":'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="M8 13h2"/><path d="M8 17h2"/><path d="M14 13h2"/><path d="M14 17h2"/></svg>',code:'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg>',"qr-code":'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="3" height="3"/><rect x="18" y="14" width="3" height="3"/><rect x="14" y="18" width="3" height="3"/><rect x="18" y="18" width="3" height="3"/></svg>',scan:'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 7V5a2 2 0 0 1 2-2h2"/><path d="M17 3h2a2 2 0 0 1 2 2v2"/><path d="M21 17v2a2 2 0 0 1-2 2h-2"/><path d="M7 21H5a2 2 0 0 1-2-2v-2"/><line x1="7" y1="12" x2="17" y2="12"/></svg>',"git-branch":'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="6" y1="3" x2="6" y2="15"/><circle cx="18" cy="6" r="3"/><circle cx="6" cy="18" r="3"/><path d="M18 9a9 9 0 0 1-9 9"/></svg>',calculator:'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="4" y="2" width="16" height="20" rx="2"/><line x1="8" y1="6" x2="16" y2="6"/><line x1="8" y1="10" x2="8" y2="10"/><line x1="12" y1="10" x2="12" y2="10"/><line x1="16" y1="10" x2="16" y2="10"/><line x1="8" y1="14" x2="8" y2="14"/><line x1="12" y1="14" x2="12" y2="14"/><line x1="16" y1="14" x2="16" y2="14"/><line x1="8" y1="18" x2="8" y2="18"/><line x1="12" y1="18" x2="12" y2="18"/><line x1="16" y1="18" x2="16" y2="18"/></svg>',"file-edit":'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 13.5V4a2 2 0 0 1 2-2h8.5L20 7.5V20a2 2 0 0 1-2 2h-5.5"/><polyline points="14 2 14 8 20 8"/><path d="M10.42 12.61a2.1 2.1 0 1 1 2.97 2.97L7.95 21 4 22l1-3.95 5.42-5.44Z"/></svg>',"copy-check":'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 15 2 2 4-4"/><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>'};function getIcon(e,t=16){return(icons[e]||icons["file-text"]).replace(/width="24"/g,`width="${t}"`).replace(/height="24"/g,`height="${t}"`)}function initIcons(){document.querySelectorAll("[data-icon]").forEach(e=>{const t=e.getAttribute("data-icon"),n=e.getAttribute("data-size")||16;e.innerHTML=getIcon(t,n)})}const CONFIG={PROXY_URL:"https://script.google.com/macros/s/AKfycbwC9lJdYj4askujDNO2GfK-Rqq02VBcr90NXhifgvpawboEK1YCyUfbi2GA2hFL2UghkA/exec",AUTH_SCRIPT_URL:"https://script.google.com/macros/s/AKfycbwC9lJdYj4askujDNO2GfK-Rqq02VBcr90NXhifgvpawboEK1YCyUfbi2GA2hFL2UghkA/exec",LOGO_URL:"https://github.com/mohamedsillahkanu/gdp-dashboard-2/raw/6c7463b0d5c3be150aafae695a4bcbbd8aeb1499/ICF-SL.jpg"},PROXIES=[{name:"Direct",url:"",type:"direct"},{name:"GAS Proxy",url:"https://script.google.com/macros/s/AKfycbwC9lJdYj4askujDNO2GfK-Rqq02VBcr90NXhifgvpawboEK1YCyUfbi2GA2hFL2UghkA/exec",type:"gas"},{name:"CORS Proxy 1",url:"https://corsproxy.io/?",type:"cors"},{name:"CORS Proxy 2",url:"https://api.allorigins.win/raw?url=",type:"cors"},{name:"CORS Proxy 3",url:"https://cors-anywhere.herokuapp.com/",type:"cors"}];function buildProxyUrl(e,t,n,a){if("direct"===e.type)return t;if("gas"===e.type){let o=e.url+"?url="+encodeURIComponent(t);return n&&(o+="&auth="+encodeURIComponent(n)),a&&"GET"!==a&&(o+="&method="+a),o}return e.url+encodeURIComponent(t)}const state={user:null,fields:[],selectedFieldId:null,fieldCounter:0,isSharedMode:!1,settings:{title:"My Data Collection Form",logo:CONFIG.LOGO_URL,aggregateColumn:""},sheets:{scriptUrl:CONFIG.AUTH_SCRIPT_URL,sheetId:"",connected:!0},dhis2:{url:"",username:"",password:"",syncMode:"aggregate",orgUnitLevel:5,periodType:"Monthly",periodColumn:"",orgUnitColumn:"",programId:"",connected:!1,datasetId:null,dataElements:{},orgUnits:[],orgUnitMap:{}},collectedData:[],filters:{},filterOrder:[],dateFilter:{start:"",end:""},currentDataView:"case",chartInstances:{}},fieldDefs={period:{label:"Period",icon:"calendar-days",defaultLabel:"Reporting Period",valueType:"TEXT",isDhis2:!0,category:"dhis2"},text:{label:"Text",icon:"type",defaultLabel:"Text Field",valueType:"TEXT",category:"text"},number:{label:"Number",icon:"hash",defaultLabel:"Number Field",valueType:"NUMBER",category:"numeric"},calculation:{label:"Calculation",icon:"calculator",defaultLabel:"Calculated Field",valueType:"NUMBER",category:"numeric"},date:{label:"Date",icon:"calendar",defaultLabel:"Date Field",valueType:"DATE",category:"date"},time:{label:"Time",icon:"clock",defaultLabel:"Time Field",valueType:"TIME",category:"time"},email:{label:"Email",icon:"mail",defaultLabel:"Email Address",valueType:"TEXT",category:"text"},phone:{label:"Phone",icon:"phone",defaultLabel:"Phone Number",valueType:"TEXT",category:"text"},textarea:{label:"Long Text",icon:"align-left",defaultLabel:"Long Text",valueType:"LONG_TEXT",category:"text"},select:{label:"Dropdown",icon:"chevron-down-square",defaultLabel:"Dropdown",valueType:"TEXT",category:"categorical",options:["Option 1","Option 2","Option 3"]},radio:{label:"Radio",icon:"circle-dot",defaultLabel:"Radio Choice",valueType:"TEXT",category:"categorical",options:["Option 1","Option 2","Option 3"]},checkbox:{label:"Checkbox",icon:"check-square",defaultLabel:"Checkbox",valueType:"TRUE_ONLY",category:"categorical",options:["Option 1","Option 2"]},yesno:{label:"Yes/No",icon:"toggle-left",defaultLabel:"Yes/No Question",valueType:"BOOLEAN",category:"categorical"},gps:{label:"GPS",icon:"map-pin",defaultLabel:"GPS Location",valueType:"TEXT",category:"text"},qrcode:{label:"QR Code",icon:"qr-code",defaultLabel:"QR/Barcode Scanner",valueType:"TEXT",category:"text"},cascade:{label:"Cascade",icon:"git-branch",defaultLabel:"Cascading Dropdown",valueType:"TEXT",category:"categorical",cascadeData:[],cascadeColumns:[]},rating:{label:"Rating",icon:"star",defaultLabel:"Rating",valueType:"INTEGER",category:"categorical",max:5},section:{label:"Section",icon:"folder",defaultLabel:"New Section",valueType:null,category:"structure"}};function generatePeriods(){const e=[];for(let t=2020;t<=2026;t++)for(let n=1;n<=12;n++)e.push(`${t}${String(n).padStart(2,"0")}`);return e}const PERIODS=generatePeriods();function init(){const e=new URLSearchParams(window.location.search).get("d");if(e)try{const t=atob(decodeURIComponent(e)).split("").map(e=>e.charCodeAt(0)),n=new Uint8Array(t),a=pako.inflate(n,{to:"string"}),o=JSON.parse(a),s="shared_form_"+window.location.search.substring(0,100);try{localStorage.setItem(s,a),console.log("Shared form cached for offline use")}catch(e){console.log("Could not cache form data")}return state.isSharedMode=!0,void renderSharedForm(o)}catch(e){if(console.error("Decode error:",e),!navigator.onLine){const e="shared_form_"+window.location.search.substring(0,100),t=localStorage.getItem(e);if(t)try{const e=JSON.parse(t);return console.log("Loaded form from offline cache"),state.isSharedMode=!0,void renderSharedForm(e)}catch(e){console.error("Cache parse error:",e)}}}loadFromStorage(),loadConfigs(),setupEventListeners(),checkAuth()}function setupEventListeners(){document.querySelectorAll(".auth-tab").forEach(e=>e.addEventListener("click",()=>switchAuthTab(e.dataset.tab))),document.getElementById("loginForm").addEventListener("submit",handleLogin),document.getElementById("signupForm").addEventListener("submit",handleSignup),document.getElementById("forgotForm").addEventListener("submit",handleForgotPassword),document.querySelectorAll(".field-type").forEach(e=>e.addEventListener("click",()=>addField(e.dataset.type))),document.getElementById("formTitle").addEventListener("input",e=>{state.settings.title=e.target.value,document.getElementById("previewTitle").textContent=e.target.value,saveToStorage()}),document.querySelectorAll(".modal-overlay").forEach(e=>{e.addEventListener("click",t=>{t.target===e&&e.classList.remove("show")})})}async function submitToGoogleSheets(e){const t=CONFIG.AUTH_SCRIPT_URL;if(!t)return console.log("No script URL configured"),saveOffline(e),{success:!1,offline:!0};if(!navigator.onLine)return console.log("Browser reports offline"),saveOffline(e),{success:!1,offline:!0};console.log("Submitting to Google Sheets...",{formTitle:state.settings.title});const n=state.fields.filter(e=>"section"!==e.type).map(e=>({label:e.label,name:e.name}));n.unshift({label:"Record ID",name:"_id"},{label:"Timestamp",name:"_timestamp"},{label:"Synced",name:"_synced"});try{const a={action:"submit",formTitle:state.settings.title,fields:n,data:e};console.log("Payload:",a);const o=await fetch(t,{method:"POST",headers:{"Content-Type":"text/plain"},body:JSON.stringify(a)});console.log("Response status:",o.status);const s=await o.text();let i;console.log("Response text:",s);try{i=JSON.parse(s)}catch(t){return console.error("Failed to parse response:",s),saveOffline(e),{success:!1,offline:!0,error:"Invalid response from server"}}return console.log("Parsed result:",i),i.success?(e._synced=!0,e._syncedAt=(new Date).toISOString(),console.log("✓ Submitted successfully"),{success:!0,offline:!1}):(console.error("Sheets submission failed:",i.error),saveOffline(e),{success:!1,offline:!0,error:i.error})}catch(t){return console.error("Sheets submission error:",t),saveOffline(e),{success:!1,offline:!0,error:t.message}}}async function loadFromGoogleSheets(){const e=CONFIG.AUTH_SCRIPT_URL;if(!e)return console.log("No script URL configured"),[];const t=`${e}?action=getData&formTitle=${encodeURIComponent(state.settings.title)}&limit=1000`;console.log("Fetching from:",t);try{const e=await fetch(t),n=await e.text();console.log("Response:",n.substring(0,200));const a=JSON.parse(n);return a.success&&a.data?(console.log("✓ Loaded",a.data.length,"records from Google Sheets"),a.data):(console.log("No data or error:",a.error||a.message),[])}catch(e){return console.error("Load error:",e),[]}}function saveOffline(e){e._offline=!0;const t=state.fields.filter(e=>"section"!==e.type).map(e=>({label:e.label,name:e.name}));t.unshift({label:"Record ID",name:"_id"},{label:"Timestamp",name:"_timestamp"},{label:"Synced",name:"_synced"});const n=JSON.parse(localStorage.getItem("icfOfflineData")||"[]");n.push({formTitle:state.settings.title,fields:t,data:e}),localStorage.setItem("icfOfflineData",JSON.stringify(n))}async function syncOfflineData(){if(!navigator.onLine)return void notify("No internet connection","error");const e=JSON.parse(localStorage.getItem("icfOfflineData")||"[]");if(0===e.length)return void notify("No offline data to sync","info");notify(`Syncing ${e.length} offline records...`,"info");let t=0,n=0;const a=[];for(const o of e)try{const e=await fetch(CONFIG.AUTH_SCRIPT_URL,{method:"POST",headers:{"Content-Type":"text/plain"},body:JSON.stringify({action:"submit",formTitle:o.formTitle,fields:o.fields,data:o.data})});if((await e.json()).success){t++;const e=state.collectedData.find(e=>e._id===o.data._id);e&&(e._synced=!0,e._syncedAt=(new Date).toISOString(),delete e._offline)}else n++,a.push(o)}catch(e){n++,a.push(o)}localStorage.setItem("icfOfflineData",JSON.stringify(a)),saveToStorage(),t>0&&notify(`Synced ${t} records to Google Sheets!`,"success"),n>0&&notify(`${n} records failed to sync`,"error"),loadViewerData()}function getOfflineCount(){return JSON.parse(localStorage.getItem("icfOfflineData")||"[]").length}function updateConnectionStatus(){const e=document.getElementById("connectionStatus");if(!e)return;const t=getOfflineCount(),n=navigator.onLine;e.className="connection-status "+(n?"online":"offline"),n?t>0?(e.innerHTML=`<span class="inline-icon" style="color:#ffc107;">${getIcon("wifi",14)}</span> Online (${t} pending)`,e.style.background="#ffc107",e.style.color="#000"):(e.innerHTML=`<span class="inline-icon">${getIcon("wifi",14)}</span> Online`,e.style.background="#28a745",e.style.color="#fff"):(e.innerHTML=`<span class="inline-icon">${getIcon("wifi-off",14)}</span> Offline`,e.style.background="#dc3545",e.style.color="#fff")}async function dhis2Request(e,t="GET",n=null){const{url:a,username:o,password:s}=state.dhis2;if(!a||!o||!s)throw new Error("DHIS2 not configured");const i=`${a.replace(/\/$/,"")}/api/${e}`,r=btoa(`${o}:${s}`);let l=null;for(let e=0;e<PROXIES.length;e++){const a=PROXIES[e],o=buildProxyUrl(a,i,r,t),s={method:t,headers:{"Content-Type":"application/json",Accept:"application/json"}};"direct"!==a.type&&"cors"!==a.type||(s.headers.Authorization="Basic "+r),"gas"===a.type&&"GET"!==t&&(s.method="POST"),n&&"GET"!==t&&(s.body=JSON.stringify(n));try{const e=await fetch(o,s),t=await e.text();let n;try{n=JSON.parse(t)}catch(e){n=t}if(n&&n.error){if("object"==typeof n.error&&(502===n.error.status||500===n.error.status)){l=`${a.name}: ${n.error.message||"Proxy error"}`;continue}if("string"==typeof n.error&&(n.error.includes("Exception")||n.error.includes("fetch"))){l=`${a.name}: ${n.error}`;continue}}if("direct"===a.type&&"string"==typeof n&&""===n){l="Direct: CORS blocked";continue}if(n&&("Unauthorized"===n.httpStatus||401===n.httpStatusCode))return{success:!1,status:401,error:"Unauthorized - check credentials",data:n};if(n&&("Not Found"===n.httpStatus||404===n.httpStatusCode))return{success:!1,status:404,error:"Not found",data:n};if(n&&n.httpStatusCode&&n.httpStatusCode>=400)return{success:!1,status:n.httpStatusCode,error:n.message||"Request failed",data:n};if(n&&("Created"===n.httpStatus||"OK"===n.httpStatus||200===n.httpStatusCode||201===n.httpStatusCode||n.response?.uid||"OK"===n.status||"SUCCESS"===n.status||"object"==typeof n&&!n.error&&!n.httpStatus||Array.isArray(n)||void 0!==n.organisationUnits||void 0!==n.dataSets||void 0!==n.dataElements||void 0!==n.programs||void 0!==n.systemName))return{success:!0,status:n.httpStatusCode||200,data:n};if(n&&"object"==typeof n)return{success:!0,status:200,data:n};l=`${a.name}: Invalid response`}catch(e){l=`${a.name}: ${e.message}`;continue}}return{success:!1,status:0,error:"All proxies failed: "+l}}async function testDhis2Connection(){const e=document.getElementById("dhis2Url").value.trim(),t=document.getElementById("dhis2Username").value.trim(),n=document.getElementById("dhis2Password").value;if(e&&t&&n){state.dhis2.url=e,state.dhis2.username=t,state.dhis2.password=n,updateDhis2Status("syncing","Testing connection..."),addLog("info","Connecting to DHIS2...");try{const e=await dhis2Request("system/info.json");e.success&&e.data?.systemName?(state.dhis2.connected=!0,updateDhis2Status("connected",`Connected to ${e.data.systemName}`),addLog("success",`✓ Connected: ${e.data.systemName} v${e.data.version||""}`),"aggregate"===state.dhis2.syncMode&&await fetchOrgUnits(),saveDhis2Config(),notify("Connected to DHIS2!")):(state.dhis2.connected=!1,updateDhis2Status("disconnected","Connection failed"),addLog("error",`✗ Failed: ${e.error||"Could not connect"}`),notify("Connection failed. Check URL and credentials.","error"))}catch(e){state.dhis2.connected=!1,updateDhis2Status("disconnected","Connection error"),addLog("error",`✗ Error: ${e.message}`),notify("Connection error: "+e.message,"error")}}else notify("Please fill server URL, username and password","error")}async function fetchOrgUnits(){const e=state.dhis2.orgUnitLevel;addLog("info",`Fetching org units at level ${e}...`);const t=await dhis2Request(`organisationUnits.json?fields=id,name,displayName,code&filter=level:eq:${e}&paging=false`);t.success&&t.data?.organisationUnits?(state.dhis2.orgUnits=t.data.organisationUnits,state.dhis2.orgUnitMap={},t.data.organisationUnits.forEach(e=>{[e.displayName?.toLowerCase().trim(),e.name?.toLowerCase().trim(),e.code?.toLowerCase().trim()].filter(Boolean).forEach(t=>{state.dhis2.orgUnitMap[t]=e.id})}),addLog("success",`✓ Loaded ${state.dhis2.orgUnits.length} org units at level ${e}`)):addLog("warning",`⚠ Could not load org units: ${t.error||"Unknown error"}`)}function selectSyncMode(e){state.dhis2.syncMode=e,document.querySelectorAll(".sync-mode-option").forEach(t=>{t.classList.remove("selected"),t.dataset.mode===e&&t.classList.add("selected")}),document.getElementById("aggregateConfig").style.display="aggregate"===e?"block":"none",document.getElementById("trackerConfig").style.display="tracker"===e?"block":"none"}function saveDhis2Config(){state.dhis2.url=document.getElementById("dhis2Url").value.trim(),state.dhis2.username=document.getElementById("dhis2Username").value.trim(),state.dhis2.password=document.getElementById("dhis2Password").value,state.dhis2.orgUnitLevel=parseInt(document.getElementById("dhis2OrgLevel").value),state.dhis2.periodType=document.getElementById("dhis2PeriodType").value,state.dhis2.programId=document.getElementById("dhis2ProgramId").value.trim(),state.dhis2.periodColumn=document.getElementById("dhis2PeriodColumn").value,state.dhis2.orgUnitColumn=document.getElementById("dhis2OrgUnitColumn").value,localStorage.setItem("icfDhis2Config",JSON.stringify({url:state.dhis2.url,username:state.dhis2.username,password:state.dhis2.password,syncMode:state.dhis2.syncMode,orgUnitLevel:state.dhis2.orgUnitLevel,periodType:state.dhis2.periodType,periodColumn:state.dhis2.periodColumn,orgUnitColumn:state.dhis2.orgUnitColumn,programId:state.dhis2.programId})),notify("DHIS2 config saved!")}function updateDhis2Status(e,t){const n=document.getElementById("dhis2Status");if(!n)return;n.className=`status-badge ${e}`;const a="connected"===e?"✓":"syncing"===e?"⋯":"✗";n.innerHTML=`${a} <span>${t}</span>`}function addLog(e,t){const n=document.getElementById("syncLog");if(!n)return;const a=(new Date).toLocaleTimeString();n.innerHTML+=`<div class="log-entry ${e}">[${a}] ${t}</div>`,n.scrollTop=n.scrollHeight}function clearLog(){const e=document.getElementById("syncLog");e&&(e.innerHTML="")}async function setupDhis2(){if(!state.dhis2.connected)return void notify("Connect to DHIS2 first","error");const e=state.dhis2.periodColumn,t=state.dhis2.orgUnitColumn;clearLog(),addLog("info",`Setting up DHIS2 (${state.dhis2.syncMode} mode)...`),addLog("info",`Period column: ${e||"Not set"}`),addLog("info",`Org Unit column: ${t||"Not set"} (will be used for assignment, not as data element)`),updateDhis2Status("syncing","Setting up...");const n=[e,t].filter(Boolean),a=state.fields.filter(e=>"section"!==e.type&&!n.includes(e.name));if(0!==a.length){addLog("info",`Data fields to create: ${a.map(e=>e.label).join(", ")}`),0===state.dhis2.orgUnits.length&&await fetchOrgUnits();try{addLog("info","Creating Data Elements...");const e=[],t=["select","radio","yesno","checkbox"],n=["phone","gps","email","text","textarea"];if("tracker"===state.dhis2.syncMode)for(const t of a){const n=t.name.toUpperCase().replace(/[^A-Z0-9_]/g,"_"),a=t.label.replace(/[<>]/g,"");let o=!1;const s=await dhis2Request(`dataElements.json?filter=code:eq:${n}&fields=id,name`);if(s.success&&s.data?.dataElements?.length>0){const n=s.data.dataElements[0];state.dhis2.dataElements[t.name]=n.id,e.push({id:n.id,name:t.label}),addLog("info",`  ↳ Already exists: ${t.label}`),o=!0}if(!o){const n=await dhis2Request(`dataElements.json?filter=name:eq:${encodeURIComponent(a)}&fields=id,name`);if(n.success&&n.data?.dataElements?.length>0){const a=n.data.dataElements[0];state.dhis2.dataElements[t.name]=a.id,e.push({id:a.id,name:t.label}),addLog("info",`  ↳ Already exists: ${t.label}`),o=!0}}if(!o){let o="TEXT";"number"===t.type?o="NUMBER":"date"===t.type&&(o="DATE");const s={name:a,shortName:a.substring(0,50),code:n,domainType:"TRACKER",valueType:o,aggregationType:"NONE"},i=await dhis2Request("dataElements","POST",s),r=i.data?.response?.uid||i.data?.uid||"OK"===i.data?.status&&i.data?.response?.uid;if(i.success&&r)state.dhis2.dataElements[t.name]=r,e.push({id:r,name:t.label}),addLog("success",`  ✓ Created: ${t.label}`);else{const n=await dhis2Request(`dataElements.json?filter=name:ilike:${encodeURIComponent(a)}&fields=id,name`);if(n.success&&n.data?.dataElements?.length>0){const a=n.data.dataElements[0];state.dhis2.dataElements[t.name]=a.id,e.push({id:a.id,name:t.label}),addLog("info",`  ↳ Already exists: ${t.label}`)}else addLog("info",`  ⊘ Skipped: ${t.label} (may exist with different type)`)}}await sleep(200)}else for(const o of a)if(n.includes(o.type))addLog("info",`  ⊘ Skipped: ${o.label} (${o.type} cannot be aggregated)`);else if(t.includes(o.type)){const t="yesno"===o.type?["Yes","No"]:o.options||[];for(const n of t){const t=`${o.name}_${n}`,a=t.toUpperCase().replace(/[^A-Z0-9_]/g,"_"),s=`${o.label} (${n})`,i=s.replace(/[<>]/g,"");let r=!1;const l=await dhis2Request(`dataElements.json?filter=code:eq:${a}&fields=id,name`);if(l.success&&l.data?.dataElements?.length>0){const n=l.data.dataElements[0];state.dhis2.dataElements[t]=n.id,e.push({id:n.id,name:s}),addLog("info",`  ↳ Already exists: ${s}`),r=!0}if(!r){const n=await dhis2Request(`dataElements.json?filter=name:eq:${encodeURIComponent(i)}&fields=id,name`);if(n.success&&n.data?.dataElements?.length>0){const a=n.data.dataElements[0];state.dhis2.dataElements[t]=a.id,e.push({id:a.id,name:s}),addLog("info",`  ↳ Already exists: ${s}`),r=!0}}if(!r){const n={name:i,shortName:i.substring(0,50),code:a,domainType:"AGGREGATE",valueType:"INTEGER",aggregationType:"SUM"},o=await dhis2Request("dataElements","POST",n),r=o.data?.response?.uid||o.data?.uid||"OK"===o.data?.status&&o.data?.response?.uid;if(o.success&&r)state.dhis2.dataElements[t]=r,e.push({id:r,name:s}),addLog("success",`  ✓ Created: ${s}`);else{const n=await dhis2Request(`dataElements.json?filter=name:ilike:${encodeURIComponent(i)}&fields=id,name`);if(n.success&&n.data?.dataElements?.length>0){const a=n.data.dataElements[0];state.dhis2.dataElements[t]=a.id,e.push({id:a.id,name:s}),addLog("info",`  ↳ Already exists: ${s}`)}else addLog("info",`  ⊘ Skipped: ${s} (may exist with different type)`)}}await sleep(200)}}else if("number"===o.type){const t=o.name.toUpperCase().replace(/[^A-Z0-9_]/g,"_"),n=o.label.replace(/[<>]/g,"");let a=!1;const s=await dhis2Request(`dataElements.json?filter=code:eq:${t}&fields=id,name`);if(s.success&&s.data?.dataElements?.length>0){const t=s.data.dataElements[0];state.dhis2.dataElements[o.name]=t.id,e.push({id:t.id,name:o.label}),addLog("info",`  ↳ Already exists: ${o.label}`),a=!0}if(!a){const t=await dhis2Request(`dataElements.json?filter=name:eq:${encodeURIComponent(n)}&fields=id,name`);if(t.success&&t.data?.dataElements?.length>0){const n=t.data.dataElements[0];state.dhis2.dataElements[o.name]=n.id,e.push({id:n.id,name:o.label}),addLog("info",`  ↳ Already exists: ${o.label}`),a=!0}}if(!a){const a={name:n,shortName:n.substring(0,50),code:t,domainType:"AGGREGATE",valueType:"NUMBER",aggregationType:"SUM"},s=await dhis2Request("dataElements","POST",a),i=s.data?.response?.uid||s.data?.uid||"OK"===s.data?.status&&s.data?.response?.uid;if(s.success&&i)state.dhis2.dataElements[o.name]=i,e.push({id:i,name:o.label}),addLog("success",`  ✓ Created: ${o.label}`);else{const t=await dhis2Request(`dataElements.json?filter=name:ilike:${encodeURIComponent(n)}&fields=id,name`);if(t.success&&t.data?.dataElements?.length>0){const n=t.data.dataElements[0];state.dhis2.dataElements[o.name]=n.id,e.push({id:n.id,name:o.label}),addLog("info",`  ↳ Already exists: ${o.label}`)}else addLog("info",`  ⊘ Skipped: ${o.label} (may exist with different type)`)}}await sleep(200)}else addLog("info",`  ⊘ Skipped: ${o.label} (${o.type} not supported in aggregate)`);addLog("success",`✓ ${e.length} data elements ready`),"aggregate"===state.dhis2.syncMode?await setupAggregateDataset(e):await setupTrackerProgram(e),updateDhis2Status("connected","Setup complete!"),addLog("success","DHIS2 SETUP COMPLETE!"),saveToStorage(),saveDhis2Config(),notify("DHIS2 setup complete!")}catch(e){updateDhis2Status("disconnected","Setup failed"),addLog("error","✗ Error: "+e.message),notify("Setup failed","error")}}else notify("Add data fields first","error")}async function setupTrackerProgram(e){0===state.dhis2.orgUnits.length&&await fetchOrgUnits();const t=state.settings.title,n=t.toUpperCase().replace(/[^A-Z0-9]/g,"_").substring(0,30),a=document.getElementById("dhis2ProgramId").value.trim();let o=null,s=null;if(a){addLog("info",`Checking existing Program: ${a}...`);const e=await dhis2Request(`programs/${a}.json?fields=id,name,programStages[id]`);e.success&&e.data?.id?(o=e.data.id,s=e.data.programStages?.[0]?.id,state.dhis2.programId=o,addLog("info",`  ↳ Using existing Program: ${e.data.name}`)):addLog("info",`  Program not found: ${a}, will create new...`)}if(!o){addLog("info",`Setting up Event Program: ${t}...`);const e=await dhis2Request(`programs.json?filter=code:eq:${n}&fields=id,name,programStages[id]`);if(e.success&&e.data?.programs?.length>0){const t=e.data.programs[0];o=t.id,s=t.programStages?.[0]?.id,state.dhis2.programId=o,addLog("info",`  ↳ Program already exists: ${t.name} (will add data elements to it)`)}else{const e=await dhis2Request(`programs.json?filter=name:eq:${encodeURIComponent(t)}&fields=id,name,programStages[id]`);if(e.success&&e.data?.programs?.length>0){const t=e.data.programs[0];o=t.id,s=t.programStages?.[0]?.id,state.dhis2.programId=o,addLog("info",`  ↳ Program already exists: ${t.name} (will add data elements to it)`)}else{const e={name:t,shortName:t.substring(0,50),code:n,programType:"WITHOUT_REGISTRATION",organisationUnits:state.dhis2.orgUnits.map(e=>({id:e.id}))},a=await dhis2Request("programs","POST",e);if(a.success&&a.data?.response?.uid){o=a.data.response.uid,state.dhis2.programId=o,addLog("success",`  ✓ Program created: ${t}`),await sleep(300);const e={name:t+" - Data Entry",program:{id:o},sortOrder:1},n=await dhis2Request("programStages","POST",e);n.success&&n.data?.response?.uid?(s=n.data.response.uid,addLog("success","  ✓ Program Stage created")):addLog("warning","  ⚠ Could not create Program Stage")}else{const e=await dhis2Request(`programs.json?filter=name:eq:${encodeURIComponent(t)}&fields=id,name,programStages[id]`);if(e.success&&e.data?.programs?.length>0){const t=e.data.programs[0];o=t.id,s=t.programStages?.[0]?.id,state.dhis2.programId=o,addLog("info",`  ↳ Program already exists: ${t.name} (will add data elements to it)`)}else{const e=await dhis2Request(`programs.json?filter=name:ilike:${encodeURIComponent(t)}&fields=id,name,programStages[id]`);if(e.success&&e.data?.programs?.length>0){const t=e.data.programs[0];o=t.id,s=t.programStages?.[0]?.id,state.dhis2.programId=o,addLog("info",`  ↳ Program already exists: ${t.name} (will add data elements to it)`)}else{const e=await dhis2Request("programs.json?fields=id,name,programStages[id]&pageSize=100");if(!(e.success&&e.data?.programs?.length>0))return void addLog("info","  ⊘ Program could not be created (may need manual creation in DHIS2)");{const n=t.toLowerCase(),a=e.data.programs.find(e=>e.name.toLowerCase().includes(n)||n.includes(e.name.toLowerCase()));if(!a)return void addLog("info","  ⊘ Program could not be created (may need manual creation in DHIS2)");o=a.id,s=a.programStages?.[0]?.id,state.dhis2.programId=o,addLog("info",`  ↳ Program found: ${a.name} (will add data elements to it)`)}}}}}}}if(o&&!s){addLog("info","  Creating Program Stage for existing program...");const e={name:t+" - Data Entry",program:{id:o},sortOrder:1},n=await dhis2Request("programStages","POST",e);if(n.success&&n.data?.response?.uid)s=n.data.response.uid,addLog("success","  ✓ Program Stage created");else{const e=await dhis2Request(`programStages.json?filter=program.id:eq:${o}&fields=id,name`);e.success&&e.data?.programStages?.length>0?(s=e.data.programStages[0].id,addLog("info","  ↳ Program Stage already exists")):addLog("warning","  ⚠ Could not create or find Program Stage")}}if(s&&e.length>0){addLog("info",`Adding ${e.length} data elements to Program Stage...`);const t=await dhis2Request(`programStages/${s}.json?fields=:owner`);if(t.success&&t.data){const n=t.data,a=new Set((n.programStageDataElements||[]).map(e=>e.dataElement?.id).filter(Boolean)),o=e.map(e=>e.id),i=[...a].filter(e=>!o.includes(e)),r=[...o,...i],l=r.map((e,t)=>({dataElement:{id:e},compulsory:!1,sortOrder:t+1}));n.programStageDataElements=l;if((await dhis2Request(`programStages/${s}`,"PUT",n)).success){addLog("success",`  ✓ Program Stage updated: ${o.filter(e=>!a.has(e)).length} new elements added, ${r.length} total`)}else addLog("warning","  ⚠ Could not update Program Stage")}else addLog("warning","  ⚠ Could not load Program Stage data")}else s?0===e.length&&addLog("info","  ⊘ No data elements to add to Program Stage"):addLog("warning","  ⚠ No Program Stage available - data elements not assigned");document.getElementById("dhis2ProgramId")&&(document.getElementById("dhis2ProgramId").value=o),addLog("success",`Event Program ready: ${t}`)}async function setupAggregateDataset(e){if(0===state.dhis2.orgUnits.length&&await fetchOrgUnits(),0===e.length)return void addLog("warning","⚠ No data elements to add to dataset");const t=state.settings.title,n=t.toUpperCase().replace(/[^A-Z0-9]/g,"_").substring(0,30);addLog("info",`Setting up Dataset: ${t}...`);let a=null;const o=await dhis2Request(`dataSets.json?filter=code:eq:${n}&fields=id,name,dataSetElements[dataElement[id]]`);if(o.success&&o.data?.dataSets?.length>0)a=o.data.dataSets[0].id,addLog("info",`  ↳ Dataset already exists: ${t}`);else{const e=await dhis2Request(`dataSets.json?filter=name:eq:${encodeURIComponent(t)}&fields=id,name,dataSetElements[dataElement[id]]`);e.success&&e.data?.dataSets?.length>0&&(a=e.data.dataSets[0].id,addLog("info",`  ↳ Dataset already exists: ${t}`))}if(a){state.dhis2.datasetId=a,addLog("info","  Merging data elements into dataset...");const t=await dhis2Request(`dataSets/${a}.json?fields=:owner`);if(t.success&&t.data){const n=new Set((t.data.dataSetElements||[]).map(e=>e.dataElement?.id).filter(Boolean)),o=e.map(e=>e.id),s=[...new Set([...n,...o])],i={...t.data,dataSetElements:s.map(e=>({dataSet:{id:a},dataElement:{id:e}})),organisationUnits:state.dhis2.orgUnits.map(e=>({id:e.id}))},r=await dhis2Request(`dataSets/${a}`,"PUT",i);if(r.success){addLog("success",`  ✓ Dataset updated: ${o.filter(e=>!n.has(e)).length} new elements added, ${s.length} total elements`)}else{addLog("warning",`  ⚠ Could not update dataset: ${r.data?.message||r.error||JSON.stringify(r.data)}`)}}}else{const a={name:t,shortName:t.substring(0,50),code:n,periodType:state.dhis2.periodType,dataSetElements:e.map(e=>({dataElement:{id:e.id}})),organisationUnits:state.dhis2.orgUnits.map(e=>({id:e.id}))};addLog("info",`  Creating dataset with ${e.length} elements...`);const o=await dhis2Request("dataSets","POST",a),s=o.data?.response?.uid||o.data?.uid;if(o.success&&s)state.dhis2.datasetId=s,addLog("success",`  ✓ Dataset created: ${t}`);else{const n=await dhis2Request(`dataSets.json?filter=name:eq:${encodeURIComponent(t)}&fields=id,name`);if(n.success&&n.data?.dataSets?.length>0){state.dhis2.datasetId=n.data.dataSets[0].id,addLog("info",`  ↳ Dataset already exists: ${t}`);const a=await dhis2Request(`dataSets/${state.dhis2.datasetId}.json?fields=:owner`);if(a.success&&a.data){const t=new Set((a.data.dataSetElements||[]).map(e=>e.dataElement?.id).filter(Boolean)),n=[...new Set([...t,...e.map(e=>e.id)])],o={...a.data,dataSetElements:n.map(e=>({dataSet:{id:state.dhis2.datasetId},dataElement:{id:e}})),organisationUnits:state.dhis2.orgUnits.map(e=>({id:e.id}))};(await dhis2Request(`dataSets/${state.dhis2.datasetId}`,"PUT",o)).success&&addLog("success",`  ✓ Dataset updated with ${e.length} elements`)}}else{const e=await dhis2Request(`dataSets.json?filter=name:ilike:${encodeURIComponent(t)}&fields=id,name`);e.success&&e.data?.dataSets?.length>0?(state.dhis2.datasetId=e.data.dataSets[0].id,addLog("info",`  ↳ Dataset already exists: ${e.data.dataSets[0].name}`)):addLog("info","  ⊘ Dataset setup skipped (may need manual creation)")}}}}async function syncToDhis2(){state.dhis2.url&&state.dhis2.username?(state.dhis2.connected=!0,clearLog(),"aggregate"===state.dhis2.syncMode?await syncAggregateData():await syncTrackerData()):notify("DHIS2 not configured","error")}async function syncAggregateData(){if(addLog("info","Syncing AGGREGATE data to DHIS2..."),updateDhis2Status("syncing","Syncing..."),!state.dhis2.periodColumn||!state.dhis2.orgUnitColumn)return addLog("error","Period Column and Org Unit Column must be set in DHIS2 settings"),notify("Set Period Column and Org Unit Column in DHIS2 settings first","error"),void updateDhis2Status("disconnected","Config needed");const e=calculateAggregateData();if(0===e.length)return notify("No data to sync","info"),void addLog("info","No aggregate data to sync");const t=state.dhis2.periodColumn,n=state.dhis2.orgUnitColumn,a=state.settings.aggregateColumn||n;let o=0,s=0;for(const n of e){const e=n._period,i=n._group,r=state.dhis2.orgUnitMap[i?.toLowerCase().trim()];if(!r){addLog("error",`  ✗ No org unit match: ${i}`),s++;continue}const l=[],d=["phone","gps","email","text","textarea","date","time"],c=state.fields.filter(e=>"section"!==e.type&&e.name!==t&&e.name!==a&&!d.includes(e.type)),p=["select","radio","yesno","checkbox"];if(c.forEach(t=>{t.type;if(p.includes(t.type)){("yesno"===t.type?["Yes","No"]:t.options||[]).forEach(a=>{const o=`${t.name}_${a}`,s=state.dhis2.dataElements[o],i=n[o];s&&null!=i&&l.push({dataElement:s,value:String(i),period:e,orgUnit:r})})}else if("number"===t.type){const a=state.dhis2.dataElements[t.name],o=n[t.name];a&&null!=o&&""!==o&&l.push({dataElement:a,value:String(o),period:e,orgUnit:r})}}),0===l.length)continue;(await dhis2Request("dataValueSets","POST",{dataValues:l})).success?(o++,addLog("success",`  ✓ Synced: ${orgUnitName} / ${e}`)):(s++,addLog("error",`  ✗ Failed: ${orgUnitName} / ${e}`)),await sleep(300)}updateDhis2Status("connected","Sync complete"),addLog("info",`Sync complete: ${o} success, ${s} failed`),notify(`Synced ${o} records to DHIS2!`)}async function syncTrackerData(){addLog("info","Syncing TRACKER/EVENT data to DHIS2..."),updateDhis2Status("syncing","Syncing...");let e=state.dhis2.programId;if(!e){addLog("info","No Program ID saved, searching for existing program...");const t=state.settings.title,n=t.toUpperCase().replace(/[^A-Z0-9]/g,"_").substring(0,30),a=await dhis2Request(`programs.json?filter=code:eq:${n}&fields=id,name,programStages[id]`);if(a.success&&a.data?.programs?.length>0){const t=a.data.programs[0];e=t.id,state.dhis2.programId=e,addLog("info",`  ↳ Found program: ${t.name}`),document.getElementById("dhis2ProgramId")&&(document.getElementById("dhis2ProgramId").value=e),saveToStorage(),saveDhis2Config()}else{const n=await dhis2Request(`programs.json?filter=name:eq:${encodeURIComponent(t)}&fields=id,name,programStages[id]`);if(n.success&&n.data?.programs?.length>0){const t=n.data.programs[0];e=t.id,state.dhis2.programId=e,addLog("info",`  ↳ Found program: ${t.name}`),document.getElementById("dhis2ProgramId")&&(document.getElementById("dhis2ProgramId").value=e),saveToStorage(),saveDhis2Config()}else{const n=await dhis2Request(`programs.json?filter=name:ilike:${encodeURIComponent(t)}&fields=id,name,programStages[id]`);if(n.success&&n.data?.programs?.length>0){const t=n.data.programs[0];e=t.id,state.dhis2.programId=e,addLog("info",`  ↳ Found program: ${t.name}`),document.getElementById("dhis2ProgramId")&&(document.getElementById("dhis2ProgramId").value=e),saveToStorage(),saveDhis2Config()}}}}if(!e)return notify("Run Setup DHIS2 first to create the Program","error"),void addLog("info","⊘ No Program found - run Setup first to create it");0===state.dhis2.orgUnits.length&&await fetchOrgUnits();const t=state.collectedData.filter(e=>!e._synced);if(0===t.length)return notify("No pending data to sync","info"),void addLog("info","No pending data to sync");const n=state.dhis2.periodColumn,a=state.dhis2.orgUnitColumn;addLog("info",`Syncing ${t.length} events...`);let o=0,s=0;for(const i of t){const t=a?i[a]:"";let r=state.dhis2.orgUnitMap[t?.toLowerCase().trim()];if(!r&&t){const e=t.toLowerCase().trim();for(const[t,n]of Object.entries(state.dhis2.orgUnitMap))if(t.includes(e)||e.includes(t)){r=n;break}}if(!r){if(r=state.dhis2.orgUnits[0]?.id,!r){addLog("error",`  ✗ No org unit: ${t}`),s++;continue}addLog("warning",`  ⚠ Using default org unit for: ${t}`)}let l=i._timestamp?.split("T")[0]||(new Date).toISOString().split("T")[0];if(n&&i[n]){const e=i[n];6===e.length&&(l=`${e.substring(0,4)}-${e.substring(4,6)}-01`)}const d=[];if(state.fields.filter(e=>"section"!==e.type&&e.name!==n&&e.name!==a).forEach(e=>{const t=state.dhis2.dataElements[e.id],n=i[e.name];t&&null!=n&&""!==n&&d.push({dataElement:t,value:String(n)})}),0===d.length){addLog("warning","  ⚠ No data values in record"),s++;continue}const c={program:e,orgUnit:r,eventDate:l,status:"COMPLETED",dataValues:d},p=await dhis2Request("events","POST",c);p.success&&(p.data?.response?.imported>0||p.data?.response?.importSummaries)?(i._synced=!0,i._syncedAt=(new Date).toISOString(),delete i._syncError,o++,addLog("success",`  ✓ Event synced: ${t||"record"}`)):(i._syncError=p.error||JSON.stringify(p.data?.message||p.data?.response?.importSummaries?.[0]?.description)||"Unknown error",s++,addLog("error",`  ✗ Event failed: ${i._syncError}`)),await sleep(300)}updateDhis2Status("connected","Sync complete"),addLog("info",`Sync complete: ${o} success, ${s} failed`),saveToStorage(),saveFormToList(),o>0&&notify(`Synced ${o} events to DHIS2!`),s>0&&notify(`${s} events failed`,"error")}function sleep(e){return new Promise(t=>setTimeout(t,e))}function calculateAggregateData(){const e=state.dhis2.periodColumn,t=state.dhis2.orgUnitColumn,n=state.settings.aggregateColumn||t,a=!n&&!e,o={},s=getFilteredData();if(0===s.length)return[];const i=[e,n].filter(Boolean),r=["phone","gps","email","text","textarea","date","time"];return s.forEach(t=>{let s,l,d;if(a){const e=t._timestamp?new Date(t._timestamp):new Date;s=`${e.getFullYear()}${String(e.getMonth()+1).padStart(2,"0")}`,l="All",d=`${l}|||${s}`}else{if(e&&t[e])s=t[e];else{const e=t._timestamp?new Date(t._timestamp):new Date;s=`${e.getFullYear()}${String(e.getMonth()+1).padStart(2,"0")}`}l=n?t[n]||"Unknown":"All",d=`${l}|||${s}`}o[d]||(o[d]={_group:l,_period:s,_count:0}),o[d]._count++,state.fields.forEach(e=>{if("section"===e.type)return;if(i.includes(e.name))return;if(r.includes(e.type))return;const n=t[e.name],a=fieldDefs[e.type];if("numeric"===a?.category||"number"===e.type){const t=parseFloat(n)||0;o[d][e.name]=(o[d][e.name]||0)+t}else if(("categorical"===a?.category||"yesno"===e.type)&&"text"!==e.type){const t="yesno"===e.type?["Yes","No"]:e.options||[];if(t.forEach(t=>{const n=`${e.name}_${t}`;void 0===o[d][n]&&(o[d][n]=0)}),n&&t.includes(n)){const t=`${e.name}_${n}`;o[d][t]=(o[d][t]||0)+1}}})}),Object.values(o)}function getFilterableFields(){const e=["select","radio","yesno","checkbox","rating"];return state.fields.filter(t=>e.includes(t.type))}function getFilteredData(){let e=[...state.collectedData];return(state.dateFilter.start||state.dateFilter.end)&&(e=e.filter(e=>{const t=e._timestamp;if(!t)return!0;const n=new Date(t);if(state.dateFilter.start&&n<new Date(state.dateFilter.start))return!1;if(state.dateFilter.end){const e=new Date(state.dateFilter.end);if(e.setHours(23,59,59,999),n>e)return!1}return!0})),Object.keys(state.filters).forEach(t=>{const n=state.filters[t];n&&(e=e.filter(e=>{const a=e[t];return a&&a.toString().trim()===n}))}),e}function getOrderedFilterFields(){const e=getFilterableFields();if(0===state.filterOrder.length)return e;const t=[];return state.filterOrder.forEach(n=>{const a=e.find(e=>e.name===n);a&&t.push(a)}),e.forEach(e=>{t.find(t=>t.name===e.name)||t.push(e)}),t}function applyFilters(){renderDataContent(),renderDashboard()}function openDhis2Config(){document.getElementById("dhis2Url").value=state.dhis2.url||"",document.getElementById("dhis2Username").value=state.dhis2.username||"",document.getElementById("dhis2Password").value=state.dhis2.password||"",document.getElementById("dhis2OrgLevel").value=state.dhis2.orgUnitLevel||5,document.getElementById("dhis2PeriodType").value=state.dhis2.periodType||"Monthly",document.getElementById("dhis2ProgramId").value=state.dhis2.programId||"",selectSyncMode(state.dhis2.syncMode||"aggregate");const e=document.getElementById("dhis2PeriodColumn"),t=document.getElementById("dhis2OrgUnitColumn");e.innerHTML='<option value="">-- Select field --</option>',t.innerHTML='<option value="">-- Select field --</option>',state.fields.filter(e=>"section"!==e.type).forEach(n=>{const a=document.createElement("option");a.value=n.name,a.textContent=n.label,e.appendChild(a);const o=document.createElement("option");o.value=n.name,o.textContent=n.label,t.appendChild(o)}),state.dhis2.periodColumn&&(e.value=state.dhis2.periodColumn),state.dhis2.orgUnitColumn&&(t.value=state.dhis2.orgUnitColumn),document.getElementById("dhis2Modal").classList.add("show")}function closeModal(e){document.getElementById(e).classList.remove("show")}function compressCascadeData(e,t){if(!e||!Array.isArray(e)||0===e.length)return console.log("compressCascadeData: No data or empty array"),null;if(!t||!Array.isArray(t)||0===t.length)return console.log("compressCascadeData: No columns or empty array"),null;try{console.log(`Compressing ${e.length} rows with ${t.length} columns:`,t);const n=e.map((e,n)=>e&&"object"==typeof e?t.map((t,a)=>{try{const n=e[t];return null==n?"":String(n).replace(/\|/g,"¦")}catch(e){return console.error(`Error at row ${n}, col ${a} (${t}):`,e),""}}).join("|"):(console.log(`Row ${n} is invalid:`,e),t.map(()=>"").join("|"))).join("||");return console.log(`Compressed to ${n.length} characters`),n}catch(e){return console.error("Compress cascade error:",e),null}}function decompressCascadeData(e,t){if(!e||"string"!=typeof e)return[];if(!t||!Array.isArray(t)||0===t.length)return[];try{return e.split("||").map(e=>{const n=e.split("|"),a={};return t.forEach((e,t)=>{a[e]=(n[t]||"").replace(/¦/g,"|")}),a}).filter(e=>Object.values(e).some(e=>e))}catch(e){return console.error("Decompress cascade error:",e),[]}}function notify(e,t="success"){const n=document.getElementById("notification");n.textContent=e,n.className="notification show"+("error"===t?" error":"info"===t?" info":"warning"===t?" warning":""),setTimeout(()=>n.classList.remove("show"),4e3)}function escapeHtml(e){return e?String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;"):""}function checkAuth(){const e=localStorage.getItem("icfCollectUser");e&&(state.user=JSON.parse(e),showBuilder())}function switchAuthTab(e){document.querySelectorAll(".auth-tab").forEach(e=>e.classList.remove("active")),document.querySelectorAll(".auth-form").forEach(e=>e.classList.remove("active")),document.querySelector(`.auth-tab[data-tab="${e}"]`)?.classList.add("active"),document.getElementById(e+"Form")?.classList.add("active")}function showForgotPassword(){document.querySelectorAll(".auth-form").forEach(e=>e.classList.remove("active")),document.querySelectorAll(".auth-tab").forEach(e=>e.classList.remove("active")),document.getElementById("forgotForm").classList.add("active"),document.getElementById("authError").style.display="none",document.getElementById("authSuccess").style.display="none"}function showAuthLoading(e){document.getElementById("authLoading").style.display=e?"block":"none",document.querySelectorAll(".auth-btn").forEach(t=>t.disabled=e)}async function handleLogin(e){e.preventDefault();const t=document.getElementById("loginEmail").value.trim(),n=document.getElementById("loginPassword").value;document.getElementById("authError").style.display="none",showAuthLoading(!0);try{const e=await fetch(CONFIG.AUTH_SCRIPT_URL,{method:"POST",headers:{"Content-Type":"text/plain"},body:JSON.stringify({action:"login",email:t,password:n})}),a=await e.json();showAuthLoading(!1),a.success&&a.user?(state.user=a.user,localStorage.setItem("icfCollectUser",JSON.stringify(a.user)),showBuilder()):(document.getElementById("authError").style.display="block",document.getElementById("authError").textContent=a.error||"Invalid credentials")}catch(e){showAuthLoading(!1);const a=JSON.parse(localStorage.getItem("icfCollectUsers")||"[]").find(e=>e.email===t&&e.password===n);a?(state.user=a,localStorage.setItem("icfCollectUser",JSON.stringify(a)),showBuilder()):(document.getElementById("authError").style.display="block",document.getElementById("authError").textContent="Connection error. Please try again.")}}async function handleSignup(e){e.preventDefault();const t=document.getElementById("signupName").value.trim(),n=document.getElementById("signupEmail").value.trim(),a=document.getElementById("signupPassword").value;document.getElementById("authError").style.display="none",document.getElementById("authSuccess").style.display="none",showAuthLoading(!0);try{const e=await fetch(CONFIG.AUTH_SCRIPT_URL,{method:"POST",headers:{"Content-Type":"text/plain"},body:JSON.stringify({action:"signup",name:t,email:n,password:a})}),o=await e.json();if(showAuthLoading(!1),o.success){const e=JSON.parse(localStorage.getItem("icfCollectUsers")||"[]");e.find(e=>e.email===n)||(e.push({id:o.user?.id||Date.now().toString(),name:t,email:n,password:a}),localStorage.setItem("icfCollectUsers",JSON.stringify(e))),document.getElementById("authSuccess").style.display="block",document.getElementById("authSuccess").textContent="Account created! Please login.",setTimeout(()=>switchAuthTab("login"),1500)}else document.getElementById("authError").style.display="block",document.getElementById("authError").textContent=o.error||"Registration failed"}catch(e){showAuthLoading(!1),document.getElementById("authError").style.display="block",document.getElementById("authError").textContent="Connection error. Please try again."}}async function handleForgotPassword(e){e.preventDefault();const t=document.getElementById("forgotEmail").value.trim();document.getElementById("authError").style.display="none",document.getElementById("authSuccess").style.display="none",showAuthLoading(!0);try{const e=await fetch(CONFIG.AUTH_SCRIPT_URL+"?action=forgotPassword&email="+encodeURIComponent(t)),n=await e.json();showAuthLoading(!1),n.success?(document.getElementById("authSuccess").style.display="block",document.getElementById("authSuccess").textContent="Password sent to your email!",setTimeout(()=>switchAuthTab("login"),2e3)):(document.getElementById("authError").style.display="block",document.getElementById("authError").textContent=n.message||"Email not found")}catch(e){showAuthLoading(!1),document.getElementById("authError").style.display="block",document.getElementById("authError").textContent="Connection error. Please try again."}}function showBuilder(){document.getElementById("authContainer").style.display="none",document.getElementById("mainContainer").classList.add("show"),document.getElementById("headerUser").innerHTML='<span data-icon="user" data-size="14"></span> '+(state.user?.name||"User"),renderFields(),initIcons()}function logout(){state.user=null,localStorage.removeItem("icfCollectUser"),document.getElementById("mainContainer").classList.remove("show"),document.getElementById("authContainer").style.display="flex"}function addField(e){const t=fieldDefs[e];if(!t)return;if("period"===e&&state.fields.find(e=>"period"===e.type))return void notify("Period field already exists","error");state.fieldCounter++;const n={id:"field_"+state.fieldCounter,type:e,label:t.defaultLabel,name:e+"_"+state.fieldCounter,required:!0,options:t.options?[...t.options]:[],max:t.max||5};"period"===e&&(n.name="period",n.label="Reporting Period"),state.fields.push(n),renderFields(),selectField(n.id),saveToStorage()}function removeField(e){event?.stopPropagation(),confirm("Delete field?")&&(state.fields=state.fields.filter(t=>t.id!==e),state.selectedFieldId===e&&(state.selectedFieldId=null,renderProperties()),renderFields(),saveToStorage())}function moveField(e,t){event?.stopPropagation();const n=state.fields.findIndex(t=>t.id===e);if(n<0)return;const a="up"===t?n-1:n+1;a<0||a>=state.fields.length||([state.fields[n],state.fields[a]]=[state.fields[a],state.fields[n]],renderFields(),saveToStorage())}function selectField(e){state.selectedFieldId=e,renderFields(),renderProperties()}function updateField(e,t){const n=state.fields.find(e=>e.id===state.selectedFieldId);n&&(n[e]=t,renderFields(),saveToStorage())}function renderFields(){const e=document.getElementById("dropZone"),t=state.fields.filter(e=>"section"!==e.type).length;if(document.getElementById("fieldCount").innerHTML=`<span data-icon="bar-chart-3" data-size="12"></span> ${t} fields`,initIcons(),0===state.fields.length)return e.classList.remove("has-fields"),void(e.innerHTML='<p style="font-size:48px;margin-bottom:12px;"><span class="inline-icon">'+getIcon("inbox",48)+'</span></p><p style="font-weight:600;">Click field types to add them</p><p style="font-size:11px;color:#868e96;margin-top:10px;">Add Period + Org Unit fields for DHIS2 sync</p>');e.classList.add("has-fields"),e.innerHTML=state.fields.map(e=>{if("section"===e.type)return`<div class="section-divider ${e.id===state.selectedFieldId?"selected":""}" data-id="${e.id}">\n                        <span><span class="inline-icon">${getIcon("folder",14)}</span> ${e.label.toUpperCase()}</span>\n                        <div style="display:flex;gap:5px;">\n                            <button class="field-action-btn" onclick="moveField('${e.id}','up')"><span class="inline-icon">${getIcon("chevron-up",12)}</span></button>\n                            <button class="field-action-btn" onclick="moveField('${e.id}','down')"><span class="inline-icon">${getIcon("chevron-down",12)}</span></button>\n                            <button class="field-action-btn delete" onclick="removeField('${e.id}')"><span class="inline-icon">${getIcon("trash-2",12)}</span></button>\n                        </div>\n                    </div>`;const t=fieldDefs[e.type],n="period"===e.type,a="number"===e.type,o=e.cascadeGroup,s="calculation"===e.type;return`<div class="form-field ${e.id===state.selectedFieldId?"selected":""} ${n?"dhis2-field":""} ${o?"cascade-field":""}" data-id="${e.id}">\n                    <div class="form-field-header">\n                        <span class="form-field-label"><span class="inline-icon">${getIcon(t?.icon||"file-text",14)}</span> ${e.label}</span>\n                        <div class="form-field-actions">\n                            <button class="field-action-btn" onclick="moveField('${e.id}','up')"><span class="inline-icon">${getIcon("chevron-up",12)}</span></button>\n                            <button class="field-action-btn" onclick="moveField('${e.id}','down')"><span class="inline-icon">${getIcon("chevron-down",12)}</span></button>\n                            <button class="field-action-btn delete" onclick="removeField('${e.id}')"><span class="inline-icon">${getIcon("trash-2",12)}</span></button>\n                        </div>\n                    </div>\n                    <div style="font-size:10px;color:#868e96;">\n                        Code: <code>${e.name}</code>\n                        ${e.required?'<span class="field-badge required">Required</span>':""}\n                        ${n?'<span class="field-badge dhis2">DHIS2</span>':""}\n                        ${a?'<span class="field-badge aggregate">SUM</span>':""}\n                        ${o?`<span class="field-badge cascade">Cascade L${(e.cascadeLevel||0)+1}</span>`:""}\n                        ${s?'<span class="field-badge calc">CALC</span>':""}\n                    </div>\n                </div>`}).join(""),e.querySelectorAll(".form-field, .section-divider").forEach(e=>{e.addEventListener("click",t=>{t.target.closest(".field-action-btn")||selectField(e.dataset.id)})})}function renderProperties(){const e=document.getElementById("propertiesContent");if(!state.selectedFieldId)return void(e.innerHTML='<div class="no-selection"><p style="font-size:32px;margin-bottom:12px;"><span data-icon="chevron-up" data-size="32"></span></p><p>Select a field to edit</p></div>');const t=state.fields.find(e=>e.id===state.selectedFieldId);if(!t)return;t.showLogic||(t.showLogic=[]),t.validation||(t.validation=[]);let n=`\n                <div class="prop-section">\n                    <div class="prop-section-title"><span data-icon="edit-3" data-size="12"></span> Field Settings</div>\n                    <div class="property-group">\n                        <label class="property-label">Label</label>\n                        <input type="text" class="property-input" id="propLabel" value="${escapeHtml(t.label)}">\n                    </div>\n                    <div class="property-group">\n                        <label class="property-label">Code / Name</label>\n                        <input type="text" class="property-input" id="propName" value="${escapeHtml(t.name)}">\n                    </div>\n                    ${"section"!==t.type?`\n                        <div class="property-group">\n                            <label class="property-checkbox">\n                                <input type="checkbox" id="propRequired" ${t.required?"checked":""}>\n                                <span>Required Field</span>\n                            </label>\n                        </div>\n                        <div class="property-group">\n                            <label class="property-checkbox">\n                                <input type="checkbox" id="propCheckDuplicate" ${t.checkDuplicate?"checked":""}>\n                                <span>Check for Duplicates</span>\n                            </label>\n                            <p style="font-size:9px;color:#868e96;margin-top:4px;">Block submission if this value already exists in Google Sheets</p>\n                        </div>\n                    `:""}\n                </div>\n            `;if(["select","radio","checkbox"].includes(t.type)&&!t.cascadeGroup&&(n+=`\n                    <div class="prop-section">\n                        <div class="prop-section-title"><span data-icon="list" data-size="12"></span> Options (one per line)</div>\n                        <textarea class="property-textarea" id="propOptions">${(t.options||[]).join("\n")}</textarea>\n                    </div>\n                `),"calculation"===t.type){const e=state.fields.filter(e=>"number"===e.type&&e.id!==t.id);n+=`\n                    <div class="prop-section">\n                        <div class="prop-section-title"><span data-icon="calculator" data-size="12"></span> Formula Builder</div>\n                        \n                        <div class="property-group">\n                            <label class="property-label">Formula</label>\n                            <input type="text" class="property-input" id="propFormula" value="${escapeHtml(t.formula||"")}" placeholder="Click fields and operators below">\n                        </div>\n                        \n                        \x3c!-- Operator Buttons --\x3e\n                        <div style="margin:10px 0;">\n                            <div style="font-size:10px;font-weight:700;color:#004080;margin-bottom:6px;">Operators:</div>\n                            <div style="display:flex;flex-wrap:wrap;gap:4px;">\n                                <button type="button" onclick="insertFormulaText(' + ')" class="calc-op-btn">+</button>\n                                <button type="button" onclick="insertFormulaText(' - ')" class="calc-op-btn">−</button>\n                                <button type="button" onclick="insertFormulaText(' * ')" class="calc-op-btn">×</button>\n                                <button type="button" onclick="insertFormulaText(' / ')" class="calc-op-btn">÷</button>\n                                <button type="button" onclick="insertFormulaText('(')" class="calc-op-btn">(</button>\n                                <button type="button" onclick="insertFormulaText(')')" class="calc-op-btn">)</button>\n                                <button type="button" onclick="insertFormulaText(' % ')" class="calc-op-btn">%</button>\n                            </div>\n                        </div>\n                        \n                        \x3c!-- Number Fields --\x3e\n                        ${e.length>0?`\n                            <div style="background:#d4edda;padding:10px;border-radius:6px;margin-top:10px;border:1px solid #c3e6cb;">\n                                <div style="font-size:10px;font-weight:700;color:#155724;margin-bottom:8px;"><span data-icon="hash" data-size="10"></span> Click to Insert Number Fields:</div>\n                                <div style="display:flex;flex-direction:column;gap:6px;">\n                                    ${e.map(e=>`\n                                        <div onclick="insertFieldRef('${e.name}')" style="background:white;padding:8px 10px;border-radius:6px;cursor:pointer;border:2px solid #28a745;display:flex;justify-content:space-between;align-items:center;" onmouseover="this.style.background='#e8f5e9'" onmouseout="this.style.background='white'">\n                                            <span style="font-weight:600;font-size:11px;color:#155724;">${escapeHtml(e.label)}</span>\n                                            <code style="background:#28a745;color:white;padding:2px 8px;border-radius:4px;font-size:10px;">{${e.name}}</code>\n                                        </div>\n                                    `).join("")}\n                                </div>\n                            </div>\n                        `:'\n                            <div style="background:#fff3cd;padding:12px;border-radius:6px;font-size:11px;color:#856404;margin-top:10px;border:1px solid #ffeeba;">\n                                <span data-icon="alert-triangle" data-size="12"></span> <strong>No number fields available.</strong><br>\n                                Add Number fields to your form first, then use them in calculations.\n                            </div>\n                        '}\n                        \n                        \x3c!-- Quick Numbers --\x3e\n                        <div style="margin-top:10px;">\n                            <div style="font-size:10px;font-weight:700;color:#004080;margin-bottom:6px;">Quick Numbers:</div>\n                            <div style="display:flex;flex-wrap:wrap;gap:4px;">\n                                ${[0,1,2,5,10,100,.5,.1].map(e=>`<button type="button" onclick="insertFormulaText('${e}')" class="calc-num-btn">${e}</button>`).join("")}\n                            </div>\n                        </div>\n                        \n                        \x3c!-- Formula Preview --\x3e\n                        <div style="background:#f8f9fa;padding:10px;border-radius:6px;margin-top:10px;border:1px solid #dee2e6;">\n                            <div style="font-size:10px;font-weight:700;color:#666;margin-bottom:4px;">Formula Preview:</div>\n                            <div id="formulaPreview" style="font-family:monospace;font-size:12px;color:#004080;word-break:break-all;">${escapeHtml(t.formula||"(empty)")}</div>\n                        </div>\n                        \n                        \x3c!-- Clear Button --\x3e\n                        <button type="button" onclick="clearFormula()" style="margin-top:10px;padding:6px 12px;background:#dc3545;color:white;border:none;border-radius:4px;font-size:11px;cursor:pointer;width:100%;">\n                            <span data-icon="trash-2" data-size="10"></span> Clear Formula\n                        </button>\n                    </div>\n                `}if("cascade"===t.type){const e=t.cascadeColumns||[],a=(t.cascadeData||[]).length;n+=`\n                    <div class="prop-section">\n                        <div class="prop-section-title"><span data-icon="git-branch" data-size="12"></span> Cascade Data</div>\n                        <p style="font-size:10px;color:#666;margin-bottom:10px;">Upload Excel file with hierarchical data. Each column = dropdown level.</p>\n                        \n                        <div style="background:#f8f9fa;padding:10px;border-radius:6px;margin-bottom:12px;border:1px dashed #dee2e6;">\n                            <div style="font-size:10px;font-weight:700;color:#004080;margin-bottom:6px;"><span data-icon="info" data-size="10"></span> Excel Format:</div>\n                            <p style="font-size:9px;color:#666;margin-bottom:8px;">Row 1 = Column headers (dropdown labels)<br>Row 2+ = Data rows (each row = one complete path)</p>\n                            <button class="logic-add-btn" style="background:#6c757d;" onclick="downloadCascadeTemplate()">\n                                <span data-icon="download" data-size="10"></span> Download Sample Template\n                            </button>\n                        </div>\n                        \n                        <div style="margin-bottom:12px;">\n                            <input type="file" id="cascadeFileInput" accept=".xlsx,.xls" style="display:none;" onchange="handleCascadeUpload(this)">\n                            <button class="logic-add-btn" style="background:#17a2b8;" onclick="document.getElementById('cascadeFileInput').click()">\n                                <span data-icon="upload" data-size="10"></span> Upload Excel File\n                            </button>\n                        </div>\n                        \n                        ${e.length>0?`\n                            <div style="background:#e8f4fc;padding:10px;border-radius:6px;margin-bottom:10px;">\n                                <div style="font-size:10px;font-weight:700;color:#004080;margin-bottom:6px;">Loaded Columns:</div>\n                                <div style="display:flex;flex-wrap:wrap;gap:6px;">\n                                    ${e.map((e,t)=>`<span style="background:#004080;color:white;padding:3px 8px;border-radius:12px;font-size:10px;">${t+1}. ${e}</span>`).join("")}\n                                </div>\n                                <div style="font-size:9px;color:#666;margin-top:6px;">${a} rows loaded</div>\n                            </div>\n                            \n                            <div class="property-group">\n                                <label class="property-label">Store Value From Column</label>\n                                <select class="property-input" id="propCascadeValueColumn" onchange="updateField('cascadeValueColumn', this.value)">\n                                    ${e.map(e=>`<option value="${e}" ${t.cascadeValueColumn===e?"selected":""}>${e}</option>`).join("")}\n                                </select>\n                                <p style="font-size:9px;color:#868e96;margin-top:4px;">Which column value to save (usually last column or UID)</p>\n                            </div>\n                        `:'\n                            <div style="background:#fff3cd;padding:10px;border-radius:6px;font-size:11px;color:#856404;">\n                                <span data-icon="alert-triangle" data-size="12"></span> No data loaded. Upload an Excel file with cascading data.\n                            </div>\n                        '}\n                    </div>\n                `}const a=state.fields.filter(e=>e.id!==t.id&&"section"!==e.type);n+=`\n                <div class="prop-section">\n                    <div class="prop-section-title"><span data-icon="eye" data-size="12"></span> Show/Hide Logic</div>\n                    <p style="font-size:10px;color:#666;margin-bottom:10px;">Show or hide this field based on other field values</p>\n                    \n                    <div id="logicRulesContainer">\n                        ${renderLogicRules(t.showLogic,a)}\n                    </div>\n                    \n                    <div style="display:flex;gap:8px;margin-top:10px;">\n                        <button class="logic-add-btn" onclick="addLogicRule('show')"><span data-icon="eye" data-size="10"></span> Add SHOW Rule</button>\n                        <button class="logic-add-btn" style="background:#dc3545;" onclick="addLogicRule('hide')"><span data-icon="eye-off" data-size="10"></span> Add HIDE Rule</button>\n                    </div>\n                </div>\n            `;if(["number","text","textarea","email","phone","date","time"].includes(t.type)){let e="";"number"===t.type?e=`\n                        <p style="font-size:10px;color:#666;margin-bottom:10px;">Set numeric constraints</p>\n                        <div id="validationRulesContainer">\n                            ${renderNumericValidation(t.validation)}\n                        </div>\n                        <button class="logic-add-btn" style="background:#ffc107;color:#000;" onclick="addValidationRule('number')"><span data-icon="plus" data-size="10"></span> Add Rule</button>\n                    `:"text"===t.type||"textarea"===t.type?e=`\n                        <p style="font-size:10px;color:#666;margin-bottom:10px;">Set character limits</p>\n                        <div class="validation-rule">\n                            <div class="logic-rule-row">\n                                <span style="font-size:10px;font-weight:700;">Min characters:</span>\n                                <input type="number" class="logic-input" min="0" value="${t.minLength||""}" onchange="updateFieldValidation('minLength', this.value)">\n                            </div>\n                            <div class="logic-rule-row" style="margin-top:8px;">\n                                <span style="font-size:10px;font-weight:700;">Max characters:</span>\n                                <input type="number" class="logic-input" min="0" value="${t.maxLength||""}" onchange="updateFieldValidation('maxLength', this.value)">\n                            </div>\n                            <div class="logic-rule-row" style="margin-top:8px;">\n                                <span style="font-size:10px;font-weight:700;">Exact length:</span>\n                                <input type="number" class="logic-input" min="0" value="${t.exactLength||""}" onchange="updateFieldValidation('exactLength', this.value)" placeholder="e.g. 10">\n                            </div>\n                        </div>\n                    `:"email"===t.type?e='\n                        <p style="font-size:10px;color:#666;margin-bottom:10px;">Email validation is automatic (must contain @)</p>\n                        <div class="validation-rule" style="background:#d4edda;border-color:#28a745;">\n                            <div style="font-size:11px;color:#155724;">✓ Email format validation enabled (requires @)</div>\n                        </div>\n                    ':"phone"===t.type?e=`\n                        <p style="font-size:10px;color:#666;margin-bottom:10px;">Set phone number format</p>\n                        <div class="validation-rule">\n                            <div class="logic-rule-row">\n                                <span style="font-size:10px;font-weight:700;">Exact digits:</span>\n                                <input type="number" class="logic-input" min="1" max="20" value="${t.exactDigits||""}" onchange="updateFieldValidation('exactDigits', this.value)" placeholder="e.g. 8">\n                                <span style="font-size:9px;color:#666;">digits only</span>\n                            </div>\n                            <div class="logic-rule-row" style="margin-top:8px;">\n                                <span style="font-size:10px;font-weight:700;">Min digits:</span>\n                                <input type="number" class="logic-input" min="1" value="${t.minDigits||""}" onchange="updateFieldValidation('minDigits', this.value)">\n                            </div>\n                            <div class="logic-rule-row" style="margin-top:8px;">\n                                <span style="font-size:10px;font-weight:700;">Max digits:</span>\n                                <input type="number" class="logic-input" min="1" value="${t.maxDigits||""}" onchange="updateFieldValidation('maxDigits', this.value)">\n                            </div>\n                        </div>\n                    `:"date"===t.type?e=`\n                        <p style="font-size:10px;color:#666;margin-bottom:10px;">Set date restrictions</p>\n                        <div class="validation-rule">\n                            <div class="logic-rule-row">\n                                <label class="property-checkbox" style="padding:0;">\n                                    <input type="checkbox" ${t.noFutureDates?"checked":""} onchange="updateFieldValidation('noFutureDates', this.checked)">\n                                    <span style="font-size:10px;">No future dates (today or before)</span>\n                                </label>\n                            </div>\n                            <div class="logic-rule-row" style="margin-top:8px;">\n                                <label class="property-checkbox" style="padding:0;">\n                                    <input type="checkbox" ${t.noPastDates?"checked":""} onchange="updateFieldValidation('noPastDates', this.checked)">\n                                    <span style="font-size:10px;">No past dates (today or after)</span>\n                                </label>\n                            </div>\n                            <div class="logic-rule-row" style="margin-top:8px;">\n                                <span style="font-size:10px;font-weight:700;">Not before:</span>\n                                <input type="date" class="logic-input" style="width:auto;" value="${t.minDate||""}" onchange="updateFieldValidation('minDate', this.value)">\n                            </div>\n                            <div class="logic-rule-row" style="margin-top:8px;">\n                                <span style="font-size:10px;font-weight:700;">Not after:</span>\n                                <input type="date" class="logic-input" style="width:auto;" value="${t.maxDate||""}" onchange="updateFieldValidation('maxDate', this.value)">\n                            </div>\n                        </div>\n                    `:"time"===t.type&&(e=`\n                        <p style="font-size:10px;color:#666;margin-bottom:10px;">Time field settings</p>\n                        <div class="validation-rule" style="background:#e8f4fc;border-color:#17a2b8;">\n                            <div class="logic-rule-row">\n                                <label class="property-checkbox" style="padding:0;">\n                                    <input type="checkbox" ${!1!==t.autoTime?"checked":""} onchange="updateFieldValidation('autoTime', this.checked)">\n                                    <span style="font-size:10px;">Auto-fill with current time</span>\n                                </label>\n                            </div>\n                        </div>\n                    `),n+=`\n                    <div class="prop-section">\n                        <div class="prop-section-title"><span data-icon="check-circle" data-size="12"></span> Validation Rules</div>\n                        ${e}\n                    </div>\n                `}e.innerHTML=n,initIcons(),document.getElementById("propLabel")?.addEventListener("change",e=>updateField("label",e.target.value)),document.getElementById("propName")?.addEventListener("change",e=>updateField("name",e.target.value)),document.getElementById("propRequired")?.addEventListener("change",e=>updateField("required",e.target.checked)),document.getElementById("propCheckDuplicate")?.addEventListener("change",e=>updateField("checkDuplicate",e.target.checked)),document.getElementById("propOptions")?.addEventListener("change",e=>updateField("options",e.target.value.split("\n").filter(e=>e.trim()))),document.getElementById("propFormula")?.addEventListener("input",e=>{updateField("formula",e.target.value),updateFormulaPreview(e.target.value)})}function updateFormulaPreview(e){const t=document.getElementById("formulaPreview");t&&(t.textContent=e||"(empty)")}function renderLogicRules(e,t){if(!e||0===e.length)return'<p style="font-size:10px;color:#868e96;text-align:center;padding:10px;">No logic rules. Field always visible.</p>';const n=["select","radio","yesno","checkbox"];return e.map((e,a)=>{const o=e.conditions||[];return`\n                    <div class="logic-rule ${e.action}">\n                        <div class="logic-rule-header">\n                            <span class="logic-rule-type ${e.action}">${e.action.toUpperCase()} this field when:</span>\n                            <button class="logic-rule-delete" onclick="deleteLogicRule(${a})" title="Delete rule">✕</button>\n                        </div>\n                        \n                        ${o.map((o,s)=>{const i=t.find(e=>e.name===o.field),r=i&&n.includes(i.type),l=i&&"number"===i.type,d="yesno"===i?.type?["Yes","No"]:i?.options||[];return`\n                                ${s>0?`<div style="text-align:center;margin:5px 0;"><span class="logic-connector">${e.connector||"AND"}</span></div>`:""}\n                                <div class="logic-rule-row">\n                                    <select class="logic-select" style="flex:1;" onchange="updateLogicCondition(${a}, ${s}, 'field', this.value)">\n                                        <option value="">-- Select Field --</option>\n                                        ${t.map(e=>`<option value="${e.name}" ${o.field===e.name?"selected":""}>${e.label}</option>`).join("")}\n                                    </select>\n                                    \n                                    ${r?`\n                                        <select class="logic-select" onchange="updateLogicCondition(${a}, ${s}, 'operator', this.value)">\n                                            <option value="=" ${"="===o.operator?"selected":""}>equals</option>\n                                            <option value="!=" ${"!="===o.operator?"selected":""}>not equals</option>\n                                        </select>\n                                        <select class="logic-select" style="flex:1;" onchange="updateLogicCondition(${a}, ${s}, 'value', this.value)">\n                                            <option value="">-- Select Value --</option>\n                                            ${d.map(e=>`<option value="${e}" ${o.value===e?"selected":""}>${e}</option>`).join("")}\n                                        </select>\n                                    `:l?`\n                                        <select class="logic-select" onchange="updateLogicCondition(${a}, ${s}, 'operator', this.value)">\n                                            <option value="=" ${"="===o.operator?"selected":""}>=</option>\n                                            <option value="!=" ${"!="===o.operator?"selected":""}>≠</option>\n                                            <option value=">" ${">"===o.operator?"selected":""}>&gt;</option>\n                                            <option value=">=" ${">="===o.operator?"selected":""}>≥</option>\n                                            <option value="<" ${"<"===o.operator?"selected":""}>&lt;</option>\n                                            <option value="<=" ${"<="===o.operator?"selected":""}>≤</option>\n                                            <option value="between" ${"between"===o.operator?"selected":""}>between</option>\n                                        </select>\n                                        ${"between"===o.operator?`\n                                            <input type="number" class="logic-input" placeholder="min" value="${o.min||""}" onchange="updateLogicCondition(${a}, ${s}, 'min', this.value)">\n                                            <span style="font-size:10px;">and</span>\n                                            <input type="number" class="logic-input" placeholder="max" value="${o.max||""}" onchange="updateLogicCondition(${a}, ${s}, 'max', this.value)">\n                                        `:`\n                                            <input type="number" class="logic-input" placeholder="value" value="${o.value||""}" onchange="updateLogicCondition(${a}, ${s}, 'value', this.value)">\n                                        `}\n                                    `:'\n                                        <span style="font-size:10px;color:#868e96;">Select a field first</span>\n                                    '}\n                                    \n                                    <button class="logic-rule-delete" onclick="deleteLogicCondition(${a}, ${s})" title="Remove condition">✕</button>\n                                </div>\n                            `}).join("")}\n                        \n                        <div style="display:flex;gap:8px;margin-top:8px;">\n                            <button class="logic-add-condition" onclick="addLogicCondition(${a}, 'AND')">+ AND</button>\n                            <button class="logic-add-condition" onclick="addLogicCondition(${a}, 'OR')">+ OR</button>\n                        </div>\n                    </div>\n                `}).join("")}function renderNumericValidation(e){return e&&0!==e.length?e.map((e,t)=>`\n                <div class="validation-rule">\n                    <div class="logic-rule-row">\n                        <span style="font-size:10px;font-weight:700;">Value must be</span>\n                        <select class="logic-select" onchange="updateValidationRule(${t}, 'operator', this.value)">\n                            <option value=">" ${">"===e.operator?"selected":""}>&gt;</option>\n                            <option value=">=" ${">="===e.operator?"selected":""}>≥</option>\n                            <option value="<" ${"<"===e.operator?"selected":""}>&lt;</option>\n                            <option value="<=" ${"<="===e.operator?"selected":""}>≤</option>\n                            <option value="=" ${"="===e.operator?"selected":""}>=</option>\n                            <option value="!=" ${"!="===e.operator?"selected":""}>≠</option>\n                            <option value="between" ${"between"===e.operator?"selected":""}>between</option>\n                        </select>\n                        ${"between"===e.operator?`\n                            <input type="number" class="logic-input" placeholder="min" value="${e.min||""}" onchange="updateValidationRule(${t}, 'min', this.value)">\n                            <span style="font-size:10px;">and</span>\n                            <input type="number" class="logic-input" placeholder="max" value="${e.max||""}" onchange="updateValidationRule(${t}, 'max', this.value)">\n                        `:`\n                            <input type="number" class="logic-input" placeholder="value" value="${e.value||""}" onchange="updateValidationRule(${t}, 'value', this.value)">\n                        `}\n                        <button class="logic-rule-delete" onclick="deleteValidationRule(${t})">✕</button>\n                    </div>\n                    <div class="validation-msg">\n                        <input type="text" class="property-input" style="font-size:10px;padding:5px;" placeholder="Error message (optional)" value="${e.message||""}" onchange="updateValidationRule(${t}, 'message', this.value)">\n                    </div>\n                </div>\n            `).join(""):'<p style="font-size:10px;color:#868e96;text-align:center;padding:10px;">No validation rules.</p>'}function evaluateFieldLogic(e,t){if(!e.showLogic||0===e.showLogic.length)return{visible:!0,valid:!0,errorMessage:""};let n=null,a=!1;for(const o of e.showLogic){const e=evaluateRule(o,t);"show"===o.action?(null===n&&(n=!1),e&&(n=!0)):"hide"===o.action&&e&&(a=!0)}return a?{visible:!1,valid:!0,errorMessage:""}:null!==n?{visible:n,valid:!0,errorMessage:""}:{visible:!0,valid:!0,errorMessage:""}}function evaluateRule(e,t){const n=e.conditions||[];if(0===n.length)return!1;const a=n.map(e=>evaluateCondition(e,t));return"OR"===e.connector?a.some(e=>e):a.every(e=>e)}function evaluateCondition(e,t){const n=t[e.field],a=e.operator;if(null==n||""===n)return!1;if("between"===a){const t=parseFloat(n),a=parseFloat(e.min),o=parseFloat(e.max);return!isNaN(t)&&!isNaN(a)&&!isNaN(o)&&t>=a&&t<=o}const o=e.value;if([">",">=","<","<="].includes(a)){const e=parseFloat(n),t=parseFloat(o);if(isNaN(e)||isNaN(t))return!1;switch(a){case">":return e>t;case">=":return e>=t;case"<":return e<t;case"<=":return e<=t}}return"="===a?String(n)===String(o):"!="===a&&String(n)!==String(o)}function validateField(e,t){if(""===t||null==t)return{valid:!0,message:""};if("number"===e.type){const n=parseFloat(t);if(isNaN(n))return{valid:!1,message:"Please enter a valid number"};if(e.validation&&e.validation.length>0)for(const t of e.validation){let e=!0;if("between"===t.operator){const a=parseFloat(t.min),o=parseFloat(t.max);e=!isNaN(a)&&!isNaN(o)&&n>=a&&n<=o}else{const a=parseFloat(t.value);if(!isNaN(a))switch(t.operator){case">":e=n>a;break;case">=":e=n>=a;break;case"<":e=n<a;break;case"<=":e=n<=a;break;case"=":e=n===a;break;case"!=":e=n!==a}}if(!e){const e="between"===t.operator?`Value must be between ${t.min} and ${t.max}`:`Value must be ${t.operator} ${t.value}`;return{valid:!1,message:t.message||e}}}}if("text"===e.type||"textarea"===e.type){const n=t.length;if(e.exactLength&&n!==parseInt(e.exactLength))return{valid:!1,message:`Must be exactly ${e.exactLength} characters`};if(e.minLength&&n<parseInt(e.minLength))return{valid:!1,message:`Minimum ${e.minLength} characters required`};if(e.maxLength&&n>parseInt(e.maxLength))return{valid:!1,message:`Maximum ${e.maxLength} characters allowed`}}if("email"===e.type){if(!t.includes("@")||!t.includes("."))return{valid:!1,message:"Please enter a valid email address"};if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(t))return{valid:!1,message:"Please enter a valid email address"}}if("phone"===e.type){const n=t.replace(/\D/g,"");if(e.exactDigits&&n.length!==parseInt(e.exactDigits))return{valid:!1,message:`Phone number must be exactly ${e.exactDigits} digits`};if(e.minDigits&&n.length<parseInt(e.minDigits))return{valid:!1,message:`Phone number must have at least ${e.minDigits} digits`};if(e.maxDigits&&n.length>parseInt(e.maxDigits))return{valid:!1,message:`Phone number must have at most ${e.maxDigits} digits`}}if("date"===e.type){const n=new Date(t),a=new Date;if(a.setHours(0,0,0,0),e.noFutureDates&&n>a)return{valid:!1,message:"Future dates are not allowed"};if(e.noPastDates&&n<a)return{valid:!1,message:"Past dates are not allowed"};if(e.minDate){if(n<new Date(e.minDate))return{valid:!1,message:`Date must be on or after ${e.minDate}`}}if(e.maxDate){if(n>new Date(e.maxDate))return{valid:!1,message:`Date must be on or before ${e.maxDate}`}}}return{valid:!0,message:""}}function applyFormLogic(){const e=document.getElementById("viewerForm");if(!e)return;const t={};new FormData(e).forEach((e,n)=>{t[n]?t[n]=Array.isArray(t[n])?[...t[n],e]:[t[n],e]:t[n]=e}),e.querySelectorAll("input, select, textarea").forEach(e=>{const n=e.name;n&&("radio"===e.type?e.checked&&(t[n]=e.value):"checkbox"===e.type?e.checked&&!t[n]&&(t[n]=e.value):t[n]||(t[n]=e.value))});const n=new Set;state.fields.forEach(e=>{if("section"!==e.type)return;evaluateFieldLogic(e,t).visible||n.add(e.id)});let a=null;const o={};state.fields.forEach(e=>{"section"===e.type?a=e.id:o[e.id]=a}),state.fields.forEach(e=>{if("section"===e.type){const n=evaluateFieldLogic(e,t),a=document.querySelector(`.form-page[data-section-id="${e.id}"]`);return void(a&&(n.visible?a.classList.remove("section-hidden"):(a.classList.add("section-hidden"),a.querySelectorAll("input, select, textarea").forEach(e=>{"radio"===e.type||"checkbox"===e.type?e.checked=!1:"time"!==e.type&&(e.value="")}))))}const a=document.querySelector(`[data-field-name="${e.name}"]`);if(!a)return;const s=o[e.id],i=s&&n.has(s);if(evaluateFieldLogic(e,t).visible&&!i)a.classList.remove("field-hidden");else{a.classList.add("field-hidden");a.querySelectorAll("input, select, textarea").forEach(e=>{"radio"===e.type||"checkbox"===e.type?e.checked=!1:"time"!==e.type&&(e.value="")})}if(["number","text","textarea","email","phone","date"].includes(e.type)){const t=a.querySelector("input, textarea"),n=a.querySelector(".field-error-msg");if(t&&t.value){const o=validateField(e,t.value);o.valid?(a.classList.remove("field-error"),n&&(n.textContent="")):(a.classList.add("field-error"),n&&(n.textContent=o.message))}else a.classList.remove("field-error"),n&&(n.textContent="")}});let s=null,i=!0;state.fields.forEach((e,t)=>{if("section"===e.type){if(s&&i){const e=document.querySelector(`[data-field-name="${s.name}"]`);e&&e.classList.add("field-hidden")}s=e,i=!0}else if(s){const t=document.querySelector(`[data-field-name="${e.name}"]`);t&&!t.classList.contains("field-hidden")&&(i=!1)}})}function validateAllFields(){const e=document.getElementById("viewerForm");if(!e)return{valid:!0};const t={};new FormData(e).forEach((e,n)=>t[n]=e);for(const e of state.fields){if("section"===e.type)continue;const n=document.querySelector(`[data-field-name="${e.name}"]`);if(!n||n.classList.contains("field-hidden"))continue;if(e.required){const n=t[e.name];if(!n||""===n)return{valid:!1,message:`${e.label} is required`}}if(["number","text","textarea","email","phone","date"].includes(e.type)){const n=t[e.name];if(n){const t=validateField(e,n);if(!t.valid)return{valid:!1,message:`${e.label}: ${t.message}`}}}}return{valid:!0}}function saveToStorage(){localStorage.setItem("icfCollectForm",JSON.stringify({fields:state.fields,settings:state.settings,fieldCounter:state.fieldCounter,collectedData:state.collectedData,filterOrder:state.filterOrder,dhis2:{datasetId:state.dhis2.datasetId,programId:state.dhis2.programId,dataElements:state.dhis2.dataElements}}))}function loadFromStorage(){const e=localStorage.getItem("icfCollectForm");if(e)try{const t=JSON.parse(e);state.fields=t.fields||[],state.settings={...state.settings,...t.settings},state.fieldCounter=t.fieldCounter||0,state.collectedData=t.collectedData||[],state.filterOrder=t.filterOrder||[],t.dhis2&&(state.dhis2.datasetId=t.dhis2.datasetId,state.dhis2.programId=t.dhis2.programId,state.dhis2.dataElements=t.dhis2.dataElements||{}),document.getElementById("formTitle").value=state.settings.title,document.getElementById("previewTitle").textContent=state.settings.title}catch(e){}}function loadConfigs(){const e=localStorage.getItem("icfSheetsConfig");if(e)try{const t=JSON.parse(e);state.sheets={...state.sheets,...t}}catch(e){}const t=localStorage.getItem("icfDhis2Config");if(t)try{const e=JSON.parse(t);state.dhis2||(state.dhis2={dataElements:{},datasetId:null,programId:"",url:"",username:"",password:"",syncMode:"aggregate",orgUnitLevel:5,periodType:"Monthly",periodColumn:"",orgUnitColumn:"",connected:!1,orgUnits:[],orgUnitMap:{}}),state.dhis2={...state.dhis2,...e}}catch(e){}}function newForm(){if(state.fields.length>0&&!confirm("Create new form?"))return;state.fields=[],state.selectedFieldId=null,state.fieldCounter=0,state.dhis2||(state.dhis2={dataElements:{},datasetId:null,programId:"",url:"",username:"",password:"",syncMode:"aggregate",orgUnitLevel:5,periodType:"Monthly",periodColumn:"",orgUnitColumn:"",connected:!1,orgUnits:[],orgUnitMap:{}}),state.dhis2.dataElements={},state.dhis2.datasetId=null,state.collectedData=[];const e=prompt("Form Name:","New Form");e&&(state.settings.title=e,document.getElementById("formTitle").value=e,document.getElementById("previewTitle").textContent=e),saveToStorage(),renderFields(),renderProperties(),notify("New form created!")}function saveCurrentForm(){0!==state.fields.length?(saveToStorage(),saveFormToList(),notify("Form saved!")):notify("Add fields first!","error")}function saveFormToList(){const e=JSON.parse(localStorage.getItem("icfCollectForms")||"[]"),t=e.findIndex(e=>e.title===state.settings.title),n={id:t>=0?e[t].id:"form_"+Date.now(),title:state.settings.title,fieldCount:state.fields.filter(e=>"section"!==e.type).length,updatedAt:(new Date).toISOString(),fields:state.fields,settings:state.settings,collectedData:state.collectedData,dhis2:{datasetId:state.dhis2?.datasetId,programId:state.dhis2?.programId,dataElements:state.dhis2?.dataElements}};t>=0?e[t]=n:e.push(n),localStorage.setItem("icfCollectForms",JSON.stringify(e)),saveFormToCloud(n)}async function saveFormToCloud(e){if(state.sheets.scriptUrl&&state.user)try{const t=await fetch(state.sheets.scriptUrl,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({action:"saveForm",email:state.user.email,formId:e.id,formData:JSON.stringify(e)})});(await t.json()).success&&console.log("Form saved to cloud")}catch(e){console.error("Cloud save error:",e)}}async function loadFormsFromCloud(){if(!state.sheets.scriptUrl||!state.user)return[];try{const e=await fetch(state.sheets.scriptUrl,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({action:"loadForms",email:state.user.email})}),t=await e.json();if(t.success&&t.forms)return t.forms}catch(e){console.error("Cloud load error:",e)}return[]}async function syncForms(){if(!state.user)return;const e=JSON.parse(localStorage.getItem("icfCollectForms")||"[]"),t=await loadFormsFromCloud(),n={};t.forEach(e=>{n[e.id]=e});const a={},o=[];e.forEach(e=>{a[e.id]=e;const t=n[e.id];(!t||new Date(e.updatedAt)>new Date(t.updatedAt))&&o.push(e)}),t.forEach(e=>{(!a[e.id]||new Date(e.updatedAt)>new Date(a[e.id].updatedAt))&&(a[e.id]=e)});const s=Object.values(a);return localStorage.setItem("icfCollectForms",JSON.stringify(s)),o.length>0&&(console.log(`Uploading ${o.length} changed forms...`),await Promise.all(o.map(e=>saveFormToCloud(e)))),s}async function deleteFormFromCloud(e){if(state.sheets.scriptUrl&&state.user)try{await fetch(state.sheets.scriptUrl,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({action:"deleteForm",email:state.user.email,formId:e})})}catch(e){console.error("Cloud delete error:",e)}}async function saveCascadeDataToCloud(e,t,n){const a=CONFIG.AUTH_SCRIPT_URL||state.sheets.scriptUrl;if(!a)throw new Error("No script URL configured");if(console.log("Saving cascade to:",a),console.log("Cascade ID:",e,"Data length:",t.length),t.length>5e6)throw new Error("Cascade data too large (>5MB). Please reduce the number of rows.");try{const o=new URL(a);o.searchParams.set("action","saveCascadeData"),o.searchParams.set("cascadeId",e),o.searchParams.set("columns",JSON.stringify(n)),console.log("Sending POST to:",o.toString());const s=await fetch(o.toString(),{method:"POST",headers:{"Content-Type":"text/plain"},body:t});if(console.log("Response status:",s.status),!s.ok){const e=await s.text();throw console.error("Response text:",e),new Error(`HTTP ${s.status}: ${s.statusText}`)}const i=await s.json();if(console.log("Response result:",i),!i.success)throw new Error(i.error||"Failed to save cascade data");return console.log("Cascade data saved to cloud:",e),!0}catch(e){if(console.error("Cascade cloud save error:",e),"TypeError"===e.name&&"Failed to fetch"===e.message)throw new Error("Network error - check internet connection and that Apps Script is deployed");throw e}}async function loadCascadeDataFromCloud(e,t){const n="cascade_cache_"+e,a=localStorage.getItem(n);if(a)try{const t=JSON.parse(a);return console.log("Cascade data loaded from cache:",e,t.data.length,"rows"),t}catch(e){localStorage.removeItem(n)}const o=CONFIG.AUTH_SCRIPT_URL;if(!o)return console.log("No script URL, cannot load cascade data"),null;try{const a=await fetch(o+"?"+new URLSearchParams({action:"getCascadeData",cascadeId:e})),s=await a.json();if(s.success&&s.data){const a=s.columns||t||[],o=decompressCascadeData(s.data,a);console.log("Cascade data loaded from cloud:",e,o.length,"rows");const i={data:o,columns:a};try{localStorage.setItem(n,JSON.stringify(i)),console.log("Cascade data cached locally")}catch(e){console.log("Could not cache cascade data (localStorage full?)")}return i}}catch(e){console.error("Cascade load error:",e)}return null}function previewForm(){0!==state.fields.length?(state.isSharedMode=!1,document.querySelector(".header").style.display="none",document.getElementById("mainContainer").classList.remove("show"),document.querySelector(".footer").style.display="none",document.getElementById("viewerContainer").classList.add("show"),renderFormViewer()):notify("Add fields!","error")}function closeViewer(){document.getElementById("viewerContainer").classList.remove("show"),document.querySelector(".header").style.display="",document.getElementById("mainContainer").classList.add("show"),document.querySelector(".footer").style.display=""}async function shareForm(){if(0!==state.fields.length){state.settings||(state.settings={title:"Form",logo:CONFIG.LOGO_URL,aggregateColumn:""});try{console.log("Starting shareForm..."),console.log("Fields count:",state.fields.length),state.fields.forEach((e,t)=>{e.cascadeData&&e.cascadeData.length>0&&console.log(`Field ${t} (${e.name}): cascadeData=${e.cascadeData.length} rows, cascadeColumns=`,e.cascadeColumns)});const e={s:{t:state.settings.title||"Form",l:state.settings.logo||CONFIG.LOGO_URL,ac:state.settings.aggregateColumn||""},f:state.fields.map((e,t)=>{try{console.log(`Mapping field ${t}: ${e.name}, type: ${e.type}`);let n=null;e.cascadeData&&Array.isArray(e.cascadeData)&&e.cascadeData.length>0&&e.cascadeColumns&&Array.isArray(e.cascadeColumns)&&e.cascadeColumns.length>0&&(n=e.cascadeDataRef||"csc_"+Date.now()+"_"+Math.random().toString(36).substr(2,6),e.cascadeDataRef=n,console.log(`Cascade field ${t}: ${e.cascadeData.length} rows will be saved with ref: ${n}`));let a=[];return e.options&&(Array.isArray(e.options)?a=e.options:"string"==typeof e.options&&(a=e.options.split("\n").filter(e=>e.trim()))),{i:e.id||"",y:e.type||"",l:e.label||"",n:e.name||"",r:e.required||!1,o:a,mx:e.max||5,sl:Array.isArray(e.showLogic)?e.showLogic:[],v:Array.isArray(e.validation)?e.validation:[],mnl:e.minLength,mxl:e.maxLength,el:e.exactLength,ed:e.exactDigits,mnd:e.minDigits,mxd:e.maxDigits,nfd:e.noFutureDates,npd:e.noPastDates,mid:e.minDate,mxd2:e.maxDate,at:e.autoTime,cd:e.checkDuplicate||!1,cg:e.cascadeGroup||null,cl:"number"==typeof e.cascadeLevel?e.cascadeLevel:null,ccol:e.cascadeColumn||null,cc:Array.isArray(e.cascadeColumns)&&e.cascadeColumns.length>0?e.cascadeColumns:null,cref:n,cvc:e.cascadeValueColumn||null,frm:e.formula||null}}catch(n){throw console.error(`Error mapping field ${t} (${e?.name||"unknown"}):`,n),console.error("Field data:",JSON.stringify(e,null,2)),n}}),d:state.dhis2?.datasetId||state.dhis2?.programId?{id:state.dhis2.datasetId,pid:state.dhis2.programId}:null,h:state.dhis2?.url?{u:state.dhis2.url,n:state.dhis2.username,p:btoa(state.dhis2.password||""),m:state.dhis2.syncMode,ol:state.dhis2.orgUnitLevel,pt:state.dhis2.periodType,pc:state.dhis2.periodColumn,oc:state.dhis2.orgUnitColumn}:null},t=state.fields.filter(e=>e.cascadeData&&e.cascadeData.length>0&&e.cascadeColumns&&e.cascadeColumns.length>0&&e.cascadeDataRef);if(t.length>0){console.log(`Saving ${t.length} cascade datasets to cloud...`),notify("Saving cascade data to cloud...","info");for(const e of t)try{const t=compressCascadeData(e.cascadeData,e.cascadeColumns);await saveCascadeDataToCloud(e.cascadeDataRef,t,e.cascadeColumns),console.log(`Saved cascade data: ${e.cascadeDataRef}`)}catch(e){return console.error("Failed to save cascade data:",e),void notify("Error saving cascade data: "+e.message,"error")}}console.log("Cleaning up form data..."),e.f=e.f.map((e,t)=>{try{const t={};return Object.keys(e).forEach(n=>{null!==e[n]&&void 0!==e[n]&&""!==e[n]&&(t[n]=e[n])}),t}catch(e){throw console.error(`Error cleaning field ${t}:`,e),e}}),console.log("Stringifying form data..."),console.log("Settings size:",JSON.stringify(e.s).length),console.log("DHIS2 d size:",JSON.stringify(e.d).length),console.log("DHIS2 h size:",JSON.stringify(e.h).length),console.log("Fields count:",e.f.length),e.f.forEach((e,t)=>{const n=JSON.stringify(e);console.log(`Field ${t} (${e.n}): ${n.length} chars`),n.length>500&&console.log("Large field keys:",Object.keys(e).filter(t=>JSON.stringify(e[t]).length>100))});const n=JSON.stringify(e);console.log("Total JSON string length:",n.length),console.log("Compressing with pako...");const a=pako.deflate(n);console.log("Compressed length:",a.length),console.log("Converting to base64...");let o="";const s=8192;for(let e=0;e<a.length;e+=s){const t=a.subarray(e,e+s);o+=String.fromCharCode.apply(null,Array.from(t))}const i=btoa(o);console.log("Base64 length:",i.length);const r=window.location.origin+window.location.pathname+"?d="+encodeURIComponent(i),l=r.length;if(console.log("Share URL length:",l,"characters"),l>1e5)return void notify(`URL too large (${Math.round(l/1e3)}KB). Reduce cascade data rows.`,"error");l>5e4?notify(`Large URL (${Math.round(l/1e3)}KB). May not work in all browsers.`,"warning"):l>8e3&&notify(`URL: ${Math.round(l/1e3)}KB - Works in modern browsers`,"info");const d=document.getElementById("shareUrl");d&&(d.textContent=r),saveFormToList();const c=document.getElementById("shareModal");c&&c.classList.add("show")}catch(e){console.error("Share error:",e),notify("Error: "+e.message,"error")}}else notify("Add fields!","error")}function copyShareUrl(){navigator.clipboard.writeText(document.getElementById("shareUrl").textContent).then(()=>notify("Copied to clipboard!")).catch(()=>notify("Copy failed","error"))}async function showHome(){document.querySelector(".header").style.display="none",document.getElementById("mainContainer").classList.remove("show"),document.querySelector(".footer").style.display="none",document.getElementById("homeContainer").classList.add("show"),renderHomeContent(!1),state.user&&syncFormsInBackground()}async function syncFormsInBackground(){try{console.log("Background sync started...");const e=await loadFormsFromCloud();if(e.length>0){const t=JSON.parse(localStorage.getItem("icfCollectForms")||"[]"),n={};t.forEach(e=>{n[e.id]=e}),e.forEach(e=>{(!n[e.id]||new Date(e.updatedAt)>new Date(n[e.id].updatedAt))&&(n[e.id]=e)});const a=Object.values(n);localStorage.setItem("icfCollectForms",JSON.stringify(a)),document.getElementById("homeContainer").classList.contains("show")&&renderHomeContent(!0)}console.log("Background sync complete")}catch(e){console.error("Background sync error:",e)}}function renderHomeContent(e){const t=JSON.parse(localStorage.getItem("icfCollectForms")||"[]"),n=!!state.user;let a=0===t.length?`\n                <div style="text-align:center;padding:60px;color:#868e96;">\n                    <p style="font-size:64px;margin-bottom:12px;"><span class="inline-icon">${getIcon("inbox",64)}</span></p>\n                    <h3 style="color:#004080;">No Forms Yet</h3>\n                    <p style="font-size:12px;margin-top:10px;">Create your first data collection form</p>\n                    <button onclick="closeHome()" style="padding:15px 30px;background:#28a745;color:#fff;border:none;border-radius:8px;cursor:pointer;margin-top:20px;font-weight:bold;"><span class="inline-icon">${getIcon("plus",14)}</span> Create Form</button>\n                </div>\n            `:t.map((e,t)=>`\n                <div style="background:#fff;border-radius:12px;margin-bottom:15px;box-shadow:0 2px 10px rgba(0,0,0,0.1);overflow:hidden;">\n                    <div style="background:linear-gradient(135deg,#004080,#002855);color:#fff;padding:12px 15px;">\n                        <h3 style="margin:0;font-size:14px;"><span class="inline-icon">${getIcon("clipboard-list",14)}</span> ${escapeHtml(e.title)}</h3>\n                    </div>\n                    <div style="padding:12px 15px;">\n                        <div style="font-size:11px;color:#666;margin-bottom:10px;">\n                            <span class="inline-icon">${getIcon("bar-chart-3",12)}</span> ${e.fieldCount} fields | <span class="inline-icon">${getIcon("edit-3",12)}</span> ${(e.collectedData||[]).length} records\n                            ${e.dhis2?.datasetId?'<span style="color:#17a2b8;margin-left:8px;"><span class="inline-icon">'+getIcon("link",12)+"</span> DHIS2</span>":""}\n                        </div>\n                        <div style="display:flex;gap:6px;">\n                            <button onclick="editForm(${t})" style="flex:1;padding:8px;background:#004080;color:#fff;border:none;border-radius:4px;cursor:pointer;font-weight:bold;font-size:11px;"><span class="inline-icon">${getIcon("pencil",12)}</span> Edit</button>\n                            <button onclick="deleteForm(${t})" style="padding:8px 12px;background:#dc3545;color:#fff;border:none;border-radius:4px;cursor:pointer;font-weight:bold;font-size:11px;"><span class="inline-icon">${getIcon("trash-2",12)}</span></button>\n                        </div>\n                    </div>\n                </div>\n            `).join("");const o=n?e?'<span style="color:#28a745;"><span class="inline-icon">'+getIcon("check-circle",12)+"</span> Synced</span>":'<span style="color:#ffc107;"><span class="inline-icon">'+getIcon("loader",12)+"</span> Syncing...</span>":"";document.getElementById("homeContainer").innerHTML=`\n                <div style="max-width:600px;margin:0 auto;padding:20px;">\n                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">\n                        <h2 style="color:#004080;"><span class="inline-icon">${getIcon("home",20)}</span> My Forms</h2>\n                        <div style="display:flex;gap:8px;align-items:center;">\n                            ${o}\n                            ${n?`\n                                <button onclick="syncFormsManually()" style="padding:10px 15px;background:#17a2b8;color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:bold;" title="Sync with Cloud">\n                                    <span class="inline-icon">${getIcon("refresh-cw",14)}</span>\n                                </button>\n                            `:""}\n                            <button onclick="closeHome()" style="padding:10px 20px;background:#28a745;color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:bold;"><span class="inline-icon">${getIcon("plus",14)}</span> New</button>\n                        </div>\n                    </div>\n                    \n                    ${n?`\n                        <div style="background:#d4edda;border:1px solid #c3e6cb;border-radius:8px;padding:10px 15px;margin-bottom:15px;display:flex;align-items:center;gap:10px;">\n                            <span class="inline-icon" style="color:#155724;">${getIcon("cloud",16)}</span>\n                            <span style="font-size:12px;color:#155724;">Signed in as <strong>${escapeHtml(state.user.email)}</strong> - Forms sync across devices</span>\n                        </div>\n                    `:`\n                        <div style="background:#fff3cd;border:1px solid #ffeeba;border-radius:8px;padding:10px 15px;margin-bottom:15px;display:flex;align-items:center;gap:10px;">\n                            <span class="inline-icon" style="color:#856404;">${getIcon("alert-triangle",16)}</span>\n                            <span style="font-size:12px;color:#856404;">Forms are stored locally. Sign in to sync across devices.</span>\n                        </div>\n                    `}\n                    \n                    ${a}\n                </div>\n            `,initIcons()}async function syncFormsManually(){notify("Syncing forms...","info");try{await syncForms(),notify("Forms synced!","success"),renderHomeContent(!0)}catch(e){notify("Sync failed: "+e.message,"error")}}function closeHome(){document.getElementById("homeContainer").classList.remove("show"),document.querySelector(".header").style.display="flex",document.getElementById("mainContainer").classList.add("show"),document.querySelector(".footer").style.display="block"}function editForm(e){const t=JSON.parse(localStorage.getItem("icfCollectForms")||"[]")[e];t&&(state.fields=t.fields||[],state.settings={...state.settings,...t.settings},state.fieldCounter=Math.max(...state.fields.map(e=>parseInt(e.id.replace("field_",""))||0),0)+1,state.collectedData=t.collectedData||[],t.dhis2&&(state.dhis2.datasetId=t.dhis2.datasetId,state.dhis2.dataElements=t.dhis2.dataElements||{}),document.getElementById("formTitle").value=state.settings.title,document.getElementById("previewTitle").textContent=state.settings.title,saveToStorage(),closeHome(),renderFields(),renderProperties(),notify("Form loaded!"))}function deleteForm(e){const t=JSON.parse(localStorage.getItem("icfCollectForms")||"[]"),n=t[e];n&&confirm(`Delete "${n.title}"?`)&&(deleteFormFromCloud(n.id),t.splice(e,1),localStorage.setItem("icfCollectForms",JSON.stringify(t)),showHome(),notify("Deleted"))}async function renderSharedForm(e){document.getElementById("authContainer").style.display="none",document.getElementById("mainContainer").classList.remove("show"),document.querySelector(".header").style.display="none",document.querySelector(".footer").style.display="none",document.getElementById("viewerContainer").classList.add("show"),document.getElementById("viewerContainer").innerHTML='\n                <div style="display:flex;align-items:center;justify-content:center;height:100vh;flex-direction:column;">\n                    <div style="font-size:48px;margin-bottom:20px;">⏳</div>\n                    <div style="color:#004080;font-weight:600;">Loading form...</div>\n                </div>\n            ',state.settings={title:e.s?.t||"Form",logo:e.s?.l||state.settings.logo,aggregateColumn:e.s?.ac||""},state.fields=(e.f||[]).map(e=>({id:e.i,type:e.y,label:e.l,name:e.n,required:e.r||!1,options:e.o||[],max:e.mx||5,showLogic:e.sl||[],validation:e.v||[],minLength:e.mnl,maxLength:e.mxl,exactLength:e.el,exactDigits:e.ed,minDigits:e.mnd,maxDigits:e.mxd,noFutureDates:e.nfd,noPastDates:e.npd,minDate:e.mid,maxDate:e.mxd2,autoTime:!1!==e.at,checkDuplicate:e.cd||!1,cascadeGroup:e.cg||null,cascadeLevel:"number"==typeof e.cl?e.cl:null,cascadeColumn:e.ccol||null,cascadeColumns:e.cc||[],cascadeData:[],cascadeDataRef:e.cref||null,cascadeValueColumn:e.cvc||null,formula:e.frm||""}));const t=state.fields.filter(e=>e.cascadeDataRef&&e.cascadeColumns&&e.cascadeColumns.length>0);if(t.length>0){console.log(`Loading cascade data for ${t.length} fields...`);for(const e of t)try{const t=await loadCascadeDataFromCloud(e.cascadeDataRef,e.cascadeColumns);t&&t.data&&(e.cascadeData=t.data,console.log(`Loaded cascade data for ${e.name}: ${e.cascadeData.length} rows`))}catch(t){console.error("Failed to load cascade data for",e.name,t)}}e.d&&(state.dhis2.datasetId=e.d.id||"",state.dhis2.programId=e.d.pid||"",state.dhis2.dataElements=e.d.de||{}),e.h&&(state.dhis2.url=e.h.u||"",state.dhis2.username=e.h.n||"",state.dhis2.password=e.h.p?atob(e.h.p):"",state.dhis2.syncMode=e.h.m||"aggregate",state.dhis2.orgUnitLevel=e.h.ol||5,state.dhis2.periodType=e.h.pt||"Monthly",state.dhis2.periodColumn=e.h.pc||"",state.dhis2.orgUnitColumn=e.h.oc||"",state.dhis2.connected=!0,state.dhis2.url&&fetchOrgUnits().catch(e=>console.log("Could not fetch org units:",e))),renderFormViewer()}function renderFormViewer(){const e=state.settings;let t=[],n={title:"Page 1",fields:[],sectionId:null};console.log("renderFormViewer - Total fields:",state.fields.length),state.fields.forEach((e,a)=>{console.log(`  Field ${a}: type=${e.type}, label=${e.label}`),"section"===e.type?(n.fields.length>0&&t.push(n),n={title:e.label,fields:[],sectionId:e.id}):n.fields.push(e)}),n.fields.length>0&&t.push(n),0===t.length&&(t=[{title:e.title,fields:state.fields.filter(e=>"section"!==e.type),sectionId:null}]),console.log("renderFormViewer - Pages created:",t.length),t.forEach((e,t)=>console.log(`  Page ${t}: "${e.title}" with ${e.fields.length} fields`));let a=t.map((e,n)=>{let a=e.fields.map(e=>{try{const t=e.required?'<span style="color:#dc3545;">*</span>':"",n=e.required?"required":"";let a="",o="";e.minLength&&(o+=` minlength="${e.minLength}"`),e.maxLength&&(o+=` maxlength="${e.maxLength}"`),e.exactLength&&(o+=` minlength="${e.exactLength}" maxlength="${e.exactLength}"`);let s="";if(e.exactDigits)s=` pattern="[0-9]{${e.exactDigits}}" title="Must be exactly ${e.exactDigits} digits"`;else if(e.minDigits||e.maxDigits){const t=e.minDigits||1,n=e.maxDigits||20;s=` pattern="[0-9]{${t},${n}}" title="Must be ${t}-${n} digits"`}let i="";const r=(new Date).toISOString().split("T")[0];e.noFutureDates&&(i+=` max="${r}"`),e.noPastDates&&(i+=` min="${r}"`),e.minDate&&(i+=` min="${e.minDate}"`),e.maxDate&&(i+=` max="${e.maxDate}"`);const l=(new Date).toTimeString().slice(0,5),d=!1!==e.autoTime?` value="${l}"`:"";switch(e.type){case"period":a=`<select name="${e.name}" class="viewer-input" ${n}>\n                                <option value="">-- Select Period --</option>\n                                ${PERIODS.map(e=>`<option value="${e}">${e.substring(0,4)}-${e.substring(4)}</option>`).join("")}\n                            </select>`;break;case"text":a=`<input type="text" name="${e.name}" class="viewer-input" ${n}${o}>`;break;case"email":a=`<input type="email" name="${e.name}" class="viewer-input" ${n} pattern="[^\\s@]+@[^\\s@]+\\.[^\\s@]+" title="Please enter a valid email (e.g., name@example.com)">`;break;case"phone":a=`<input type="tel" name="${e.name}" class="viewer-input" ${n}${s}>`;break;case"date":a=`<input type="date" name="${e.name}" class="viewer-input" ${n}${i}>`;break;case"time":a=`<input type="time" name="${e.name}" class="viewer-input" ${n}${d} readonly style="background:#f0f0f0;">`;break;case"number":a=`<input type="number" name="${e.name}" class="viewer-input" ${n}>`;break;case"calculation":a=`<input type="text" name="${e.name}" class="viewer-input calculation-field" \n                                data-formula="${escapeHtml(e.formula||"")}" \n                                readonly \n                                style="background:#e9ecef;font-weight:600;color:#004080;">`;break;case"textarea":a=`<textarea name="${e.name}" class="viewer-input" rows="3" ${n}${o}></textarea>`;break;case"select":if(e.cascadeGroup){const t=0===(e.cascadeLevel||0),o=e.cascadeLevel||0;a=`<select name="${e.name}" class="viewer-input cascade-field" \n                                    data-cascade-group="${e.cascadeGroup}" \n                                    data-cascade-level="${o}"\n                                    data-cascade-column="${e.cascadeColumn||""}"\n                                    onchange="handleCascadeChange(this)"\n                                    ${t?"":"disabled"} ${n}>\n                                    <option value="">-- Select ${escapeHtml(e.label)} --</option>\n                                </select>`}else a=`<select name="${e.name}" class="viewer-input" ${n}><option value="">-- Select --</option>${(e.options||[]).map(e=>`<option value="${escapeHtml(e)}">${escapeHtml(e)}</option>`).join("")}</select>`;break;case"radio":case"yesno":a=`<div class="viewer-radio-group">${("yesno"===e.type?["Yes","No"]:e.options||[]).map(t=>`<label class="viewer-radio-option"><input type="radio" name="${e.name}" value="${escapeHtml(t)}" ${n}><span>${escapeHtml(t)}</span></label>`).join("")}</div>`;break;case"checkbox":a=`<div class="viewer-radio-group">${(e.options||[]).map(t=>`<label class="viewer-radio-option"><input type="checkbox" name="${e.name}" value="${escapeHtml(t)}"><span>${escapeHtml(t)}</span></label>`).join("")}</div>`;break;case"gps":a=`<div><button type="button" onclick="captureGPS(this)" style="padding:10px 20px;background:#004080;color:white;border:none;border-radius:6px;cursor:pointer;"><span data-icon="map-pin" data-size="14"></span> Get Location</button><input type="hidden" name="${e.name}"><div class="gps-status" style="margin-top:6px;font-size:11px;"></div>\n                `;break;case"qrcode":a=`<div class="qr-scanner-container">\n                                <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">\n                                    <button type="button" onclick="startQRScanner(this)" style="padding:10px 20px;background:#6f42c1;color:white;border:none;border-radius:6px;cursor:pointer;"><span data-icon="scan" data-size="14"></span> Scan QR/Barcode</button>\n                                    <input type="hidden" name="${e.name}" ${n}>\n                                    <span class="qr-value" style="font-size:12px;color:#28a745;font-weight:600;"></span>\n                                </div>\n                                <div class="qr-preview" style="margin-top:10px;display:none;">\n                                    <video class="qr-video" style="width:100%;max-width:300px;border-radius:8px;"></video>\n                                    <button type="button" onclick="stopQRScanner(this)" style="margin-top:8px;padding:6px 12px;background:#dc3545;color:white;border:none;border-radius:4px;cursor:pointer;">Stop Scanner</button>\n                                </div>\n                                <div class="qr-status" style="margin-top:6px;font-size:11px;"></div>\n                            </div>`;break;case"cascade":const t=e.cascadeColumns||[],r=e.id;a=t.length>0&&e.cascadeData&&e.cascadeData.length>0?`<div class="cascade-container" data-cascade-id="${r}" data-field-name="${e.name}" data-value-column="${e.cascadeValueColumn||t[t.length-1]}">\n                                    ${t.map((e,t)=>`\n                                        <div class="cascade-level" data-level="${t}">\n                                            <label class="cascade-label">${escapeHtml(e)}</label>\n                                            <select class="viewer-input cascade-select" data-column="${e}" data-level="${t}" onchange="handleCascadeSelect(this)" ${0===t?"":"disabled"}>\n                                                <option value="">-- Select ${escapeHtml(e)} --</option>\n                                            </select>\n                                        </div>\n                                    `).join("")}\n                                    <input type="hidden" name="${e.name}" ${n}>\n                                </div>`:'<div style="background:#fff3cd;padding:10px;border-radius:6px;font-size:11px;color:#856404;">\n                                    <span data-icon="alert-triangle" data-size="12"></span> Cascade data not configured. Upload Excel in form builder.\n                                </div>';break;case"rating":a=`<div>${Array(e.max||5).fill().map((e,t)=>`<span onclick="setRating(this,${t+1})" class="rating-star" style="font-size:24px;cursor:pointer;opacity:0.3;color:#ffc107;">★</span>`).join("")}<input type="hidden" name="${e.name}"></div>`;break;default:a=`<input type="text" name="${e.name}" class="viewer-input" ${n}>`}return`<div class="viewer-field" data-field-name="${e.name}" data-field-id="${e.id}"><label class="viewer-field-label">${escapeHtml(e.label)} ${t}</label>${a}<div class="field-error-msg"></div></div>`}catch(t){return console.error("Error rendering field:",e,t),`<div class="viewer-field" style="color:red;">Error rendering field: ${e.label||e.name}</div>`}}).join("");const o=0===n,s=n===t.length-1;return`\n                    <div class="form-page" data-page="${n}" data-section-id="${e.sectionId||""}" style="${0===n?"":"display:none;"}">\n                        ${t.length>1?`<div class="page-header"><span class="page-indicator">Page ${n+1}/${t.length}</span><h3 class="page-title">${escapeHtml(e.title)}</h3></div>`:""}\n                        ${a}\n                        <div class="page-navigation">\n                            ${o?"<div></div>":`<button type="button" class="nav-btn back-btn" onclick="goToPrevPage(${n})"><span class="inline-icon">${getIcon("arrow-left",14)}</span> Back</button>`}\n                            ${s?"":`<button type="button" class="nav-btn next-btn" onclick="goToNextPage(${n})">Next <span class="inline-icon">${getIcon("arrow-right",14)}</span></button>`}\n                            ${s?'<button type="submit" class="nav-btn submit-btn"><span data-icon="check" data-size="14"></span> Submit</button>':""}\n                        </div>\n                    </div>\n                `}).join("");const o=state.isSharedMode?"":'<button class="viewer-back-btn" onclick="closeViewer()"><span class="inline-icon">'+getIcon("arrow-left",14)+"</span> Back</button>";document.getElementById("viewerContainer").innerHTML=`\n                <div class="viewer-nav">\n                    ${o}\n                    <button class="viewer-nav-btn active" style="background:#004080;color:#fff;" onclick="showTab('form',this)"><span data-icon="edit-3" data-size="14"></span> Form</button>\n                    <button class="viewer-nav-btn" style="background:#28a745;color:#fff;" onclick="showTab('data',this)"><span data-icon="table" data-size="14"></span> Data</button>\n                    <button class="viewer-nav-btn" style="background:#17a2b8;color:#fff;" onclick="showTab('dashboard',this)"><span data-icon="bar-chart-2" data-size="14"></span> Dashboard</button>\n                    ${state.dhis2.url?`<div class="connection-status" style="background:#17a2b8;"><span class="inline-icon">${getIcon("link",14)}</span> DHIS2</div>`:""}\n                    <div id="connectionStatus" class="connection-status ${navigator.onLine?"online":"offline"}">\n                        ${navigator.onLine?'<span class="inline-icon" style="color:#28a745;">'+getIcon("wifi",14)+"</span> Online":'<span class="inline-icon" style="color:#dc3545;">'+getIcon("wifi-off",14)+"</span> Offline"}\n                    </div>\n                </div>\n                \n                <div id="tabForm" class="viewer-tab active">\n                    <div class="viewer-form">\n                        <div class="viewer-form-box">\n                            <div class="viewer-header">\n                                <img src="${e.logo}" alt="Logo">\n                                <h1>${escapeHtml(e.title)}</h1>\n                                <p>ICF-SL Data Collection System</p>\n                            </div>\n                            <div class="viewer-body">\n                                <form id="viewerForm">${a}</form>\n                                \n                                \x3c!-- Draft Actions --\x3e\n                                <div class="draft-actions-bar">\n                                    <button type="button" class="draft-save-btn" onclick="saveDraft()">\n                                        <span data-icon="file-edit" data-size="14"></span> Save as Draft\n                                    </button>\n                                    <button type="button" class="draft-toggle-btn" onclick="toggleDraftsPanel()">\n                                        <span data-icon="folder" data-size="14"></span> <span id="draftsCount">Drafts (0)</span>\n                                    </button>\n                                </div>\n                                \n                                \x3c!-- Drafts Panel --\x3e\n                                <div id="draftsPanelWrapper" class="drafts-panel-wrapper" style="display:none;">\n                                    <div class="drafts-panel-header">\n                                        <span><span data-icon="file-edit" data-size="14"></span> Saved Drafts</span>\n                                        <button onclick="toggleDraftsPanel()" style="background:none;border:none;cursor:pointer;color:#666;">✕</button>\n                                    </div>\n                                    <div id="draftsPanel"></div>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n                \n                <div id="tabData" class="viewer-tab">\n                    <div style="max-width:1100px;margin:0 auto;" id="dataContent">\n                        <p style="text-align:center;padding:40px;"><span data-icon="loader" data-size="14"></span> Loading...</p>\n                    </div>\n                </div>\n                \n                <div id="tabDashboard" class="viewer-tab">\n                    <div class="dashboard-container" id="dashboardContent">\n                        <p style="text-align:center;padding:40px;"><span data-icon="loader" data-size="14"></span> Loading...</p>\n                    </div>\n                </div>\n            `,window.totalPages=t.length,setupFormSubmit(),loadViewerData(),initIcons(),setTimeout(()=>{renderDraftsPanel(),updateDraftsCount()},100),setTimeout(()=>{applyFormLogic(),initCascades()},100)}function setupFormSubmit(){const e=document.getElementById("viewerForm");e&&(e.addEventListener("input",()=>{applyFormLogic(),runCalculations()}),e.addEventListener("change",()=>{applyFormLogic(),runCalculations()}),e.onsubmit=async function(t){t.preventDefault();const n=validateAllFields();if(!n.valid)return void notify(n.message,"error");const a={_id:Date.now(),_timestamp:(new Date).toISOString(),_synced:!1};new FormData(e).forEach((e,t)=>a[t]=e);const o=e.querySelector(".submit-btn"),s=o?o.innerHTML:"";o&&(o.innerHTML='<span class="spin" style="display:inline-block;">'+getIcon("loader",14)+"</span> Checking...",o.disabled=!0);const i=state.fields.filter(e=>e.checkDuplicate&&a[e.name]);if(i.length>0){const e=await checkDuplicates(a,i);if(e.hasDuplicate)return o&&(o.innerHTML=s,o.disabled=!1),void notify(`Duplicate found: ${e.field} = "${e.value}" already exists`,"error")}o&&(o.innerHTML='<span class="spin" style="display:inline-block;">'+getIcon("loader",14)+"</span> Submitting...");const r=await submitToGoogleSheets(a);r.success&&!r.offline&&(a._synced=!0),state.collectedData.push(a),saveToStorage(),saveFormToList();const l=e.dataset.draftId?parseInt(e.dataset.draftId):null;l&&(removeDraft(l),delete e.dataset.draftId,updateDraftsCount()),e.reset(),goToPage(0),setTimeout(()=>applyFormLogic(),100),o&&(o.innerHTML=s,o.disabled=!1),r.success&&!r.offline?notify("Submitted to Google Sheets!","success"):r.offline?notify("Saved offline (will sync when online)","info"):notify("Saved locally","info"),loadViewerData()})}async function checkDuplicates(e,t){try{for(const n of t){const t=e[n.name];if(state.collectedData.find(e=>e[n.name]===t))return{hasDuplicate:!0,field:n.label,value:t}}const n=await loadFromGoogleSheets();for(const a of t){const t=e[a.name];if(n.find(e=>e[a.name]===t))return{hasDuplicate:!0,field:a.label,value:t}}return{hasDuplicate:!1}}catch(e){return console.error("Duplicate check error:",e),{hasDuplicate:!1}}}function getDraftStorageKey(){return`icf_drafts_${state.settings.title.replace(/\s+/g,"_")}`}function loadDrafts(){try{return JSON.parse(localStorage.getItem(getDraftStorageKey())||"[]")}catch(e){return[]}}function saveDrafts(e){localStorage.setItem(getDraftStorageKey(),JSON.stringify(e))}function removeDraft(e){if(!e)return;saveDrafts(loadDrafts().filter(t=>t._draftId!==e))}function renderDraftsPanel(){const e=document.getElementById("draftsPanel");if(!e)return;const t=loadDrafts();if(0===t.length)return void(e.innerHTML='<p style="text-align:center;color:#868e96;font-size:11px;padding:10px;">No saved drafts</p>');let n='<div class="drafts-list">';t.forEach(e=>{const t=new Date(e._savedAt).toLocaleString(),a=e._draftName||"Unnamed Draft",o=state.fields.filter(t=>"section"!==t.type&&e[t.name]).slice(0,2).map(t=>String(e[t.name]).substring(0,15)).join(", ")||"";n+=`\n                    <div class="draft-item">\n                        <div class="draft-info">\n                            <div class="draft-preview" style="font-weight:700;">${escapeHtml(a)}</div>\n                            <div class="draft-date">${t}${o?" • "+escapeHtml(o):""}</div>\n                        </div>\n                        <div class="draft-actions">\n                            <button class="draft-btn load" onclick="loadDraft(${e._draftId})" title="Load Draft">\n                                <span data-icon="file-edit" data-size="12"></span>\n                            </button>\n                            <button class="draft-btn delete" onclick="deleteDraft(${e._draftId})" title="Delete Draft">\n                                <span data-icon="trash-2" data-size="12"></span>\n                            </button>\n                        </div>\n                    </div>\n                `}),n+="</div>",e.innerHTML=n,initIcons()}function updateDraftsCount(){const e=document.getElementById("draftsCount");if(e){const t=loadDrafts();e.textContent=`Drafts (${t.length})`}}async function loadViewerData(){const e=document.getElementById("dataContent"),t=document.getElementById("dashboardContent");e&&(e.innerHTML=`<p style="text-align:center;padding:40px;"><span class="spin" style="display:inline-block;">${getIcon("loader",20)}</span> Loading data from Google Sheets...</p>`),t&&(t.innerHTML=`<p style="text-align:center;padding:40px;"><span class="spin" style="display:inline-block;">${getIcon("loader",20)}</span> Loading dashboard...</p>`);try{const e=await loadFromGoogleSheets();e&&e.length>0?(state.collectedData=e.map(e=>{const t={...e};return t._id=e._id?"string"==typeof e._id&&parseInt(e._id)||e._id:Date.now(),t._synced=!0,Object.keys(t).forEach(e=>{const n=t[e];if(n&&"string"==typeof n){if(n.match(/^\d{4}-\d{2}-\d{2}T/)){const t=state.fields.find(t=>t.name===e);t&&["select","radio","checkbox"].includes(t.type)&&(t.options?.includes(n)||console.warn(`Possible date conversion issue in ${e}: ${n}`))}}}),t}),console.log("✓ Data loaded from Google Sheets")):console.log("No data in Sheets, using local data:",state.collectedData.length,"records")}catch(e){console.error("Could not load from Sheets:",e.message),console.log("Fallback to local data:",state.collectedData.length,"records")}renderDataContent(),renderDashboard(),updateConnectionStatus()}function renderDataContent(){const e=document.getElementById("dataContent");if(!e)return;const t=getOrderedFilterFields(),n=getFilteredData(),a=calculateAggregateData(),o=Object.keys(state.filters).filter(e=>state.filters[e]).length+(state.dateFilter.start||state.dateFilter.end?1:0);let s=`\n                <div class="filter-group">\n                    <label class="filter-label"><span class="inline-icon">${getIcon("calendar",12)}</span> From</label>\n                    <input type="date" class="filter-input" value="${state.dateFilter.start}" onchange="updateDateFilter('start', this.value)">\n                </div>\n                <div class="filter-group">\n                    <label class="filter-label"><span class="inline-icon">${getIcon("calendar",12)}</span> To</label>\n                    <input type="date" class="filter-input" value="${state.dateFilter.end}" onchange="updateDateFilter('end', this.value)">\n                </div>\n            `;t.forEach((e,t)=>{const n=[...new Set(state.collectedData.map(t=>t[e.name]).filter(Boolean))];s+=`\n                    <div class="filter-group with-arrows">\n                        <button class="filter-arrow-btn left" onclick="moveFilter('${e.name}','up')" title="Move Left">◀</button>\n                        <label class="filter-label">${escapeHtml(e.label)}</label>\n                        <select class="filter-select" onchange="updateFilter('${e.name}', this.value)">\n                            <option value="">All</option>\n                            ${n.map(t=>`<option value="${escapeHtml(t)}" ${state.filters[e.name]===t?"selected":""}>${escapeHtml(t)}</option>`).join("")}\n                        </select>\n                        <button class="filter-arrow-btn right" onclick="moveFilter('${e.name}','down')" title="Move Right">▶</button>\n                    </div>\n                `});const i=state.fields.filter(e=>["select","radio","yesno","text"].includes(e.type)&&"section"!==e.type),r=`\n                <div class="config-section" style="margin-bottom:15px;padding:12px;">\n                    <div style="display:flex;align-items:center;gap:15px;flex-wrap:wrap;">\n                        <div style="display:flex;align-items:center;gap:8px;">\n                            <span class="inline-icon">${getIcon("layers",14)}</span>\n                            <strong style="font-size:11px;">Aggregate By:</strong>\n                            <select class="filter-select" style="min-width:150px;" onchange="setAggregateColumn(this.value)">\n                                <option value="">-- Select Column --</option>\n                                ${i.map(e=>`<option value="${e.name}" ${state.settings.aggregateColumn===e.name?"selected":""}>${escapeHtml(e.label)}</option>`).join("")}\n                            </select>\n                        </div>\n                        ${state.settings.aggregateColumn?`<span style="font-size:10px;color:#28a745;"><span class="inline-icon">${getIcon("check-circle",12)}</span> Grouping by: ${escapeHtml(i.find(e=>e.name===state.settings.aggregateColumn)?.label||state.settings.aggregateColumn)}</span>`:'<span style="font-size:10px;color:#868e96;">Select a column to enable aggregate view</span>'}\n                    </div>\n                </div>\n            `;e.innerHTML=`\n                <div class="filter-panel">\n                    <div class="filter-header">\n                        <div class="filter-title"><span class="inline-icon">${getIcon("filter",14)}</span> Filters ${o>0?`<span class="filter-count">${o} active</span>`:""}</div>\n                        <button class="filter-btn clear" onclick="clearAllFilters()"><span class="inline-icon">${getIcon("trash-2",12)}</span> Clear</button>\n                    </div>\n                    <div class="filter-controls">${s}</div>\n                </div>\n                \n                ${r}\n                \n                <div class="data-view-tabs">\n                    <div class="data-view-tab ${"case"===state.currentDataView?"active":""}" onclick="switchDataView('case')"><span class="inline-icon">${getIcon("list",14)}</span> Case-Based (${n.length})</div>\n                    <div class="data-view-tab ${"aggregate"===state.currentDataView?"active aggregate":""}" onclick="switchDataView('aggregate')"><span class="inline-icon">${getIcon("bar-chart-3",14)}</span> Aggregate (${a.length})</div>\n                </div>\n                \n                <div id="dataTableContainer">${"case"===state.currentDataView?renderCaseTable(n):renderAggregateTable(a)}</div>\n                \n                <div style="margin-top:20px;display:flex;gap:10px;flex-wrap:wrap;">\n                    <button class="modal-btn primary" onclick="refreshData()"><span class="inline-icon">${getIcon("refresh-cw",14)}</span> Refresh</button>\n                    <button class="modal-btn success" onclick="downloadCSV()"><span class="inline-icon">${getIcon("download",14)}</span> Download CSV</button>\n                    ${getOfflineCount()>0?`<button class="modal-btn" style="background:#ffc107;color:#000;" onclick="syncOfflineData()"><span class="inline-icon">${getIcon("upload",14)}</span> Sync Offline (${getOfflineCount()})</button>`:""}\n                    ${state.dhis2.url?`<button class="modal-btn" style="background:#6f42c1;color:#fff;" onclick="syncCaseBased()"><span class="inline-icon">${getIcon("list",14)}</span> Sync Case-Based</button>`:""}\n                    ${state.dhis2.url?`<button class="modal-btn" style="background:#17a2b8;color:#fff;" onclick="syncAggregate()"><span class="inline-icon">${getIcon("bar-chart-3",14)}</span> Sync Aggregate</button>`:""}\n                </div>\n            `,initIcons()}function renderCaseTable(e){if(0===e.length)return'<p style="text-align:center;padding:40px;color:#868e96;"><span data-icon="inbox" data-size="20"></span> No records found</p>';const t=state.fields.filter(e=>"section"!==e.type);let n='<div style="overflow-x:auto;"><table class="data-table"><thead><tr><th>#</th><th><span data-icon="calendar" data-size="12"></span> Timestamp</th>';return t.slice(0,8).forEach(e=>n+=`<th>${escapeHtml(e.label)}</th>`),n+="<th>Status</th></tr></thead><tbody>",e.slice().reverse().forEach((a,o)=>{const s=a._synced?'<span class="sync-badge synced"><span data-icon="check" data-size="10"></span> Synced</span>':a._syncError?'<span class="sync-badge failed"><span data-icon="x" data-size="10"></span> Failed</span>':'<span class="sync-badge pending"><span data-icon="clock" data-size="10"></span> Pending</span>';n+=`<tr><td>${e.length-o}</td><td style="font-size:10px;">${new Date(a._timestamp).toLocaleString()}</td>`,t.slice(0,8).forEach(e=>n+=`<td>${escapeHtml(String(a[e.name]||"-").substring(0,25))}</td>`),n+=`<td>${s}</td></tr>`}),n+="</tbody></table></div>",n}function renderAggregateTable(e){if(0===e.length)return'<p style="text-align:center;padding:40px;color:#868e96;"><span data-icon="inbox" data-size="20"></span> No aggregate data available</p>';const t=state.dhis2.periodColumn,n=state.settings.aggregateColumn||state.dhis2.orgUnitColumn,a=[t,n].filter(Boolean),o=["phone","gps","email","text","textarea","date","time"],s=state.fields.filter(e=>"section"!==e.type&&!a.includes(e.name)&&!o.includes(e.type)),i=[],r=["select","radio","yesno","checkbox"];s.forEach(e=>{const t=fieldDefs[e.type];if(r.includes(e.type)){("yesno"===e.type?["Yes","No"]:e.options||[]).forEach(t=>{i.push({key:`${e.name}_${t}`,label:`${e.label} (${t})`,type:"categorical"})})}else"numeric"!==t?.category&&"number"!==e.type||i.push({key:e.name,label:`${e.label} (SUM)`,type:"numeric"})});const l=state.fields.find(e=>e.name===n),d=l?.label||"Group";let c='<div style="overflow-x:auto;"><table class="aggregate-table"><thead><tr>';return c+='<th style="position:sticky;left:0;background:#004080;z-index:2;"><span class="inline-icon">'+getIcon("layers",14)+"</span> "+escapeHtml(d)+"</th>",c+='<th><span class="inline-icon">'+getIcon("calendar",14)+"</span> Period</th>",c+='<th><span class="inline-icon">'+getIcon("bar-chart-3",14)+"</span> N</th>",i.forEach(e=>{const t="categorical"===e.type?"#0066cc":"#004080";c+=`<th style="background:${t};white-space:nowrap;font-size:11px;">${escapeHtml(e.label)}</th>`}),c+="</tr></thead><tbody>",e.forEach(e=>{c+="<tr>",c+=`<td style="position:sticky;left:0;background:#fff;z-index:1;font-weight:600;">${escapeHtml(e._group)}</td>`,c+=`<td>${escapeHtml(e._period)}</td>`,c+=`<td class="aggregate-value" style="font-weight:600;">${e._count}</td>`,i.forEach(t=>{const n=e[t.key];c+=`<td class="aggregate-value">${null!=n?n:0}</td>`}),c+="</tr>"}),c+="</tbody></table></div>",c}function renderDashboard(){const e=document.getElementById("dashboardContent");if(!e)return;const t=getOrderedFilterFields(),n=getFilteredData(),a=calculateAggregateData(),o=Object.keys(state.filters).filter(e=>state.filters[e]).length+(state.dateFilter.start||state.dateFilter.end?1:0);Object.values(state.chartInstances).forEach(e=>{e&&e.destroy()}),state.chartInstances={};const s=state.collectedData.filter(e=>e._synced).length,i=state.collectedData.filter(e=>!e._synced&&!e._syncError).length,r=state.dhis2.periodColumn,l=r?[...new Set(n.map(e=>e[r]).filter(Boolean))].length:0,d=state.settings.aggregateColumn||state.dhis2.orgUnitColumn,c=state.fields.find(e=>e.name===d),p=d?[...new Set(n.map(e=>e[d]).filter(Boolean))].length:0;let u=`\n                <div class="filter-group">\n                    <label class="filter-label"><span class="inline-icon">${getIcon("calendar",12)}</span> From</label>\n                    <input type="date" class="filter-input" value="${state.dateFilter.start}" onchange="updateDateFilter('start', this.value)">\n                </div>\n                <div class="filter-group">\n                    <label class="filter-label"><span class="inline-icon">${getIcon("calendar",12)}</span> To</label>\n                    <input type="date" class="filter-input" value="${state.dateFilter.end}" onchange="updateDateFilter('end', this.value)">\n                </div>\n            `;t.forEach((e,t)=>{const n=[...new Set(state.collectedData.map(t=>t[e.name]).filter(Boolean))];u+=`\n                    <div class="filter-group with-arrows">\n                        <button class="filter-arrow-btn left" onclick="moveFilter('${e.name}','up')" title="Move Left">◀</button>\n                        <label class="filter-label">${escapeHtml(e.label)}</label>\n                        <select class="filter-select" onchange="updateFilter('${e.name}', this.value)">\n                            <option value="">All</option>\n                            ${n.map(t=>`<option value="${escapeHtml(t)}" ${state.filters[e.name]===t?"selected":""}>${escapeHtml(t)}</option>`).join("")}\n                        </select>\n                        <button class="filter-arrow-btn right" onclick="moveFilter('${e.name}','down')" title="Move Right">▶</button>\n                    </div>\n                `});const g=["select","radio","yesno","checkbox"],h=state.fields.filter(e=>g.includes(e.type)&&e.name!==d&&e.name!==r),m=state.fields.filter(e=>"number"===e.type);let f="";h.forEach((e,t)=>{const a={};n.forEach(t=>{const n=t[e.name];n&&(a[n]=(a[n]||0)+1)}),Object.keys(a).length>0&&(f+=`\n                        <div class="chart-container">\n                            <h4><span class="inline-icon">${getIcon("bar-chart-3",16)}</span> ${escapeHtml(e.label)}</h4>\n                            <div class="chart-wrapper">\n                                <div class="chart-box"><canvas id="barChart_${t}"></canvas></div>\n                                <div class="chart-box"><canvas id="pieChart_${t}"></canvas></div>\n                            </div>\n                        </div>\n                    `)}),m.length>0&&a.length>0&&(f+=`\n                    <div class="chart-container">\n                        <h4><span data-icon="hash" data-size="14"></span> Numeric Summary (Aggregate)</h4>\n                        <div style="overflow-x:auto;">\n                            <table class="data-table">\n                                <thead><tr><th>Field</th><th>Total Sum</th><th>Average per Location</th><th>Min</th><th>Max</th></tr></thead>\n                                <tbody>\n                                    ${m.map(e=>{const t=a.map(t=>t[e.name]||0),n=t.reduce((e,t)=>e+t,0),o=t.length>0?(n/t.length).toFixed(2):0,s=t.length>0?Math.min(...t):0,i=t.length>0?Math.max(...t):0;return`<tr><td><strong>${escapeHtml(e.label)}</strong></td><td>${n}</td><td>${o}</td><td>${s}</td><td>${i}</td></tr>`}).join("")}\n                                </tbody>\n                            </table>\n                        </div>\n                    </div>\n                `),e.innerHTML=`\n                <div class="filter-panel">\n                    <div class="filter-header">\n                        <div class="filter-title"><span class="inline-icon">${getIcon("filter",14)}</span> Filters ${o>0?`<span class="filter-count">${o} active</span>`:""}</div>\n                        <button class="filter-btn clear" onclick="clearAllFilters()"><span class="inline-icon">${getIcon("trash-2",12)}</span> Clear</button>\n                    </div>\n                    <div class="filter-controls">${u}</div>\n                </div>\n                \n                <div class="dashboard-header">\n                    <img src="${state.settings.logo}" alt="Logo">\n                    <h2><span class="inline-icon">${getIcon("bar-chart-2",20)}</span> ${escapeHtml(state.settings.title)} - Dashboard</h2>\n                    <p>ICF-SL Data Analytics</p>\n                </div>\n                \n                <div class="dashboard-stats">\n                    <div class="stat-card"><div class="stat-value">${n.length}</div><div class="stat-label">Total Records</div></div>\n                    <div class="stat-card success"><div class="stat-value">${s}</div><div class="stat-label">Synced</div></div>\n                    <div class="stat-card warning"><div class="stat-value">${i}</div><div class="stat-label">Pending</div></div>\n                    ${r?`<div class="stat-card info"><div class="stat-value">${l}</div><div class="stat-label">Periods</div></div>`:""}\n                    ${d?`<div class="stat-card purple"><div class="stat-value">${p}</div><div class="stat-label">${escapeHtml(c?.label||"Groups")}</div></div>`:""}\n                    <div class="stat-card"><div class="stat-value">${a.length}</div><div class="stat-label">Aggregate Rows</div></div>\n                </div>\n                \n                ${f||'<div class="chart-container"><p style="text-align:center;color:#868e96;padding:30px;"><span class="inline-icon">'+getIcon("bar-chart-3",18)+"</span> Add categorical fields for charts</p></div>"}\n            `,setTimeout(()=>{const e=["#004080","#28a745","#dc3545","#ffc107","#17a2b8","#6f42c1","#fd7e14","#20c997","#e83e8c","#6c757d"];h.forEach((t,a)=>{const o={};if(n.forEach(e=>{const n=e[t.name];n&&(o[n]=(o[n]||0)+1)}),0===Object.keys(o).length)return;const s=Object.keys(o),i=Object.values(o),r=i.reduce((e,t)=>e+t,0),l=document.getElementById(`barChart_${a}`);l&&(state.chartInstances[`bar_${a}`]=new Chart(l,{type:"bar",data:{labels:s,datasets:[{label:"Count",data:i,backgroundColor:e.slice(0,s.length)}]},options:{responsive:!0,plugins:{legend:{display:!1},title:{display:!0,text:"Bar Chart",font:{family:"Oswald"}}},scales:{y:{beginAtZero:!0,ticks:{stepSize:1}}}}}));const d=document.getElementById(`pieChart_${a}`);d&&(state.chartInstances[`pie_${a}`]=new Chart(d,{type:"pie",data:{labels:s.map((e,t)=>`${e} (${(i[t]/r*100).toFixed(1)}%)`),datasets:[{data:i,backgroundColor:e.slice(0,s.length)}]},options:{responsive:!0,plugins:{legend:{position:"bottom",labels:{font:{family:"Oswald",size:10}}},title:{display:!0,text:"Pie Chart",font:{family:"Oswald"}}}}}))})},100)}function showTab(e,t){console.log("=== showTab called ===",e),document.querySelectorAll(".viewer-tab").forEach(e=>e.classList.remove("active")),document.querySelectorAll(".viewer-nav-btn").forEach(e=>e.classList.remove("active"));const n=document.getElementById("tab"+e.charAt(0).toUpperCase()+e.slice(1));console.log("Tab element ID:","tab"+e.charAt(0).toUpperCase()+e.slice(1)),console.log("Tab element found:",!!n),n&&n.classList.add("active"),t&&t.classList.add("active"),"data"===e&&(console.log("Rendering data tab..."),renderDataContent()),"dashboard"===e&&(console.log("Rendering dashboard tab..."),renderDashboard())}function goToPage(e,t=1){const n=document.querySelectorAll(".form-page"),a=n.length;let o=e,s=0;for(;s<a;){const e=document.querySelector(`.form-page[data-page="${o}"]`);if(e&&!e.classList.contains("section-hidden"))break;o+=t,o<0&&(o=0),o>=a&&(o=a-1),s++}n.forEach(e=>e.style.display="none");const i=document.querySelector(`.form-page[data-page="${o}"]`);i&&(i.style.display="block")}function validateCurrentPage(e){const t=document.querySelector(`.form-page[data-page="${e}"]`);if(!t)return!0;let n=!0,a=null;return t.querySelectorAll("[required]").forEach(e=>{if(null===e.offsetParent)return;e.style.borderColor="";const o=e.parentElement.querySelector(".field-error");o&&o.remove();let s="";if("checkbox"===e.type){const o=e.name,s=t.querySelectorAll(`input[name="${o}"]`);return void(Array.from(s).some(e=>e.checked)||(n=!1,a||(a=e),showFieldError(e,"Please select at least one option")))}if("radio"===e.type){const o=e.name,s=t.querySelectorAll(`input[name="${o}"]`);return void(Array.from(s).some(e=>e.checked)||(n=!1,a||(a=e),showFieldError(e,"Please select an option")))}s=e.value.trim(),s||(n=!1,a||(a=e),showFieldError(e,"This field is required"))}),a&&(a.scrollIntoView({behavior:"smooth",block:"center"}),a.focus()),n}function showFieldError(e,t){e.style.borderColor="#dc3545";const n=document.createElement("div");n.className="field-error",n.style.cssText="color:#dc3545;font-size:12px;margin-top:4px;",n.textContent=t,e.parentElement.appendChild(n)}function initCascades(){document.querySelectorAll(".cascade-container").forEach(e=>{const t=e.dataset.cascadeId,n=state.fields.find(e=>e.id===t);if(!n||!n.cascadeData||0===n.cascadeData.length)return;const a=n.cascadeColumns||[];if(0===a.length)return;const o=e.querySelector('select[data-level="0"]');if(o){[...new Set(n.cascadeData.map(e=>e[a[0]]).filter(Boolean))].sort().forEach(e=>{const t=document.createElement("option");t.value=e,t.textContent=e,o.appendChild(t)})}});const e={};state.fields.forEach(t=>{t.cascadeGroup&&(e[t.cascadeGroup]||(e[t.cascadeGroup]=[]),e[t.cascadeGroup].push(t))}),Object.keys(e).forEach(t=>{const n=e[t].sort((e,t)=>(e.cascadeLevel||0)-(t.cascadeLevel||0))[0];if(!n||!n.cascadeData||0===n.cascadeData.length)return;const a=document.querySelector(`select[data-cascade-group="${t}"][data-cascade-level="0"]`);if(a&&a.options.length<=1){const e=n.cascadeColumn;if(!e)return;[...new Set(n.cascadeData.map(t=>t[e]).filter(Boolean))].sort().forEach(e=>{const t=document.createElement("option");t.value=e,t.textContent=e,a.appendChild(t)})}})}function runCalculations(){const e=document.getElementById("viewerForm");if(!e)return;state.fields.filter(e=>"calculation"===e.type&&e.formula).forEach(t=>{const n=e.querySelector(`input[name="${t.name}"]`);if(!n)return;let a=t.formula;(a.match(/\{([^}]+)\}/g)||[]).forEach(t=>{const n=t.replace(/[{}]/g,""),o=e.querySelector(`[name="${n}"]`),s=o&&parseFloat(o.value)||0;a=a.replace(t,s)});try{const e=a.replace(/[^0-9+\-*/().%\s]/g,"");if(e.trim()){const t=Function('"use strict"; return ('+e+")")();n.value=isNaN(t)||!isFinite(t)?"":Math.round(100*t)/100}}catch(e){n.value="Error"}})}function updateOnlineStatus(){const e=document.getElementById("offlineIndicator");e&&(e.style.display=navigator.onLine?"none":"block")}window.addEventListener("online",()=>{JSON.parse(localStorage.getItem("icfOfflineData")||"[]").length>0&&(notify("Back online! Syncing offline data...","info"),setTimeout(syncOfflineData,1e3))}),window.addEventListener("online",updateConnectionStatus),window.addEventListener("offline",updateConnectionStatus),window.syncCaseBased=async function(){state.dhis2.url&&state.dhis2.username?(state.dhis2.connected=!0,clearLog(),await syncTrackerData()):notify("DHIS2 not configured","error")},window.syncAggregate=async function(){state.dhis2.url&&state.dhis2.username?(state.dhis2.connected=!0,clearLog(),await syncAggregateData()):notify("DHIS2 not configured","error")},window.updateFilter=function(e,t){t?state.filters[e]=t:delete state.filters[e],applyFilters()},window.updateDateFilter=function(e,t){state.dateFilter[e]=t,applyFilters()},window.clearAllFilters=function(){state.filters={},state.dateFilter={start:"",end:""},document.querySelectorAll(".filter-select, .filter-input").forEach(e=>e.value=""),applyFilters(),notify("Filters cleared")},window.moveFilter=function(e,t){const n=getFilterableFields().map(e=>e.name);0===state.filterOrder.length&&(state.filterOrder=[...n]),n.forEach(e=>{state.filterOrder.includes(e)||state.filterOrder.push(e)}),state.filterOrder=state.filterOrder.filter(e=>n.includes(e));const a=state.filterOrder.indexOf(e);-1!==a&&("up"===t&&a>0?[state.filterOrder[a],state.filterOrder[a-1]]=[state.filterOrder[a-1],state.filterOrder[a]]:"down"===t&&a<state.filterOrder.length-1&&([state.filterOrder[a],state.filterOrder[a+1]]=[state.filterOrder[a+1],state.filterOrder[a]]),saveToStorage(),renderDataContent(),renderDashboard())},window.downloadCascadeTemplate=function(){const e=XLSX.utils.book_new(),t=XLSX.utils.aoa_to_sheet([["Level_1","Level_2","Level_3","Level_4","UID"],["Eastern Region","Kailahun District","Luawa Chiefdom","Kailahun Gov Hospital","UID001"],["Eastern Region","Kailahun District","Luawa Chiefdom","Luawa CHC","UID002"],["Eastern Region","Kailahun District","Jawei Chiefdom","Daru CHC","UID003"],["Eastern Region","Kenema District","Nongowa Chiefdom","Kenema Gov Hospital","UID004"],["Southern Region","Bo District","Badjia Chiefdom","Ngelehun CHC","UID005"],["Southern Region","Bo District","Bagbwe Chiefdom","Barlie MCHP","UID006"],["Southern Region","Bonthe District","Jong Chiefdom","Mattru Hospital","UID007"],["Western Region","Western Urban","East 1","Connaught Hospital","UID008"],["Western Region","Western Rural","Koya Chiefdom","Waterloo CHC","UID009"]]);t["!cols"]=[{wch:18},{wch:18},{wch:18},{wch:22},{wch:10}],XLSX.utils.book_append_sheet(e,t,"CascadeData"),XLSX.writeFile(e,"cascade_template.xlsx"),notify("Template downloaded! Edit columns and data as needed.","success")},window.handleCascadeUpload=async function(e){const t=e.files[0];if(!t)return;const n=state.fields.find(e=>e.id===state.selectedFieldId);if(n&&"cascade"===n.type){try{const e=await t.arrayBuffer(),a=XLSX.read(e,{type:"array"}),o=a.SheetNames[0],s=a.Sheets[o],i=XLSX.utils.sheet_to_json(s,{header:1});if(i.length<2)return void notify("Excel file must have headers and at least one data row","error");const r=i[0].map(e=>String(e||"").trim()).filter(e=>e),l=i.slice(1).filter(e=>!(!e||!Array.isArray(e))&&e.some(e=>null!=e&&""!==e)).map(e=>{const t={};return r.forEach((n,a)=>{const o=Array.isArray(e)&&a<e.length?e[a]:null;t[n]=null!=o?String(o).trim():""}),t}),d="cascade_"+Date.now(),c=state.fields.findIndex(e=>e.id===n.id);state.fields.splice(c,1);const p=r.map((e,t)=>({id:d+"_"+t,type:"select",label:e,name:e.toLowerCase().replace(/\s+/g,"_"),required:!1,options:[],cascadeGroup:d,cascadeLevel:t,cascadeColumn:e,cascadeData:0===t?l:null,cascadeColumns:0===t?r:null}));state.fields.splice(c,0,...p),state.selectedFieldId=p[0].id,renderFields(),renderProperties(),saveToStorage(),notify(`Created ${r.length} linked cascade fields with ${l.length} data rows`,"success")}catch(e){console.error("Excel parse error:",e),notify("Error reading Excel file: "+e.message,"error")}e.value=""}},window.insertFieldRef=function(e){const t=document.getElementById("propFormula");if(t){const n=t.selectionStart||t.value.length,a=t.value.substring(0,n),o=t.value.substring(n);t.value=a+"{"+e+"}"+o,t.focus(),updateField("formula",t.value),updateFormulaPreview(t.value)}},window.insertFormulaText=function(e){const t=document.getElementById("propFormula");if(t){const n=t.selectionStart||t.value.length,a=t.value.substring(0,n),o=t.value.substring(n);t.value=a+e+o,t.focus(),updateField("formula",t.value),updateFormulaPreview(t.value)}},window.clearFormula=function(){const e=document.getElementById("propFormula");e&&(e.value="",updateField("formula",""),updateFormulaPreview(""))},window.updateFieldValidation=function(e,t){const n=state.fields.find(e=>e.id===state.selectedFieldId);n&&(["minLength","maxLength","exactLength","exactDigits","minDigits","maxDigits"].includes(e)?n[e]=""===t?null:parseInt(t):["noFutureDates","noPastDates","autoTime"].includes(e)?n[e]=t:n[e]=t||null,saveToStorage())},window.addLogicRule=function(e){const t=state.fields.find(e=>e.id===state.selectedFieldId);t&&(t.showLogic||(t.showLogic=[]),t.showLogic.push({action:e,connector:"AND",conditions:[{field:"",operator:"=",value:""}]}),saveToStorage(),renderProperties())},window.deleteLogicRule=function(e){const t=state.fields.find(e=>e.id===state.selectedFieldId);t&&t.showLogic&&(t.showLogic.splice(e,1),saveToStorage(),renderProperties())},window.addLogicCondition=function(e,t){const n=state.fields.find(e=>e.id===state.selectedFieldId);n&&n.showLogic&&n.showLogic[e]&&(n.showLogic[e].connector=t,n.showLogic[e].conditions.push({field:"",operator:"=",value:""}),saveToStorage(),renderProperties())},window.deleteLogicCondition=function(e,t){const n=state.fields.find(e=>e.id===state.selectedFieldId);n&&n.showLogic&&n.showLogic[e]&&(n.showLogic[e].conditions.length<=1?n.showLogic.splice(e,1):n.showLogic[e].conditions.splice(t,1),saveToStorage(),renderProperties())},window.updateLogicCondition=function(e,t,n,a){const o=state.fields.find(e=>e.id===state.selectedFieldId);if(!o||!o.showLogic||!o.showLogic[e])return;const s=o.showLogic[e].conditions[t];s&&(s[n]=a,"field"===n&&(s.operator="=",s.value="",s.min="",s.max=""),"operator"===n&&"between"===a&&(s.value=""),saveToStorage(),renderProperties())},window.addValidationRule=function(e){const t=state.fields.find(e=>e.id===state.selectedFieldId);t&&(t.validation||(t.validation=[]),t.validation.push({operator:">=",value:"",min:"",max:"",message:""}),saveToStorage(),renderProperties())},window.deleteValidationRule=function(e){const t=state.fields.find(e=>e.id===state.selectedFieldId);t&&t.validation&&(t.validation.splice(e,1),saveToStorage(),renderProperties())},window.updateValidationRule=function(e,t,n){const a=state.fields.find(e=>e.id===state.selectedFieldId);a&&a.validation&&a.validation[e]&&(a.validation[e][t]=n,"operator"===t&&"between"===n&&(a.validation[e].value=""),saveToStorage(),renderProperties())},window.saveDraft=function(){const e=document.getElementById("viewerForm");if(!e)return;const t=new FormData(e),n={};t.forEach((e,t)=>n[t]=e);if(!state.fields.some(e=>"section"!==e.type&&n[e.name]))return void notify("No data to save as draft","info");const a=prompt("Enter a name for this draft:","Draft "+(loadDrafts().length+1));if(!a)return;const o={_draftId:Date.now(),_draftName:a.trim(),_savedAt:(new Date).toISOString()};t.forEach((e,t)=>o[t]=e);const s=loadDrafts();s.push(o),saveDrafts(s),notify(`Draft "${a}" saved!`,"success"),renderDraftsPanel(),updateDraftsCount()},window.loadDraft=function(e){const t=loadDrafts().find(t=>t._draftId===e);if(!t)return;const n=document.getElementById("viewerForm");n&&(state.fields.forEach(e=>{if("section"===e.type)return;const a=t[e.name];if(void 0===a)return;const o=n.querySelector(`[name="${e.name}"]`);if(o)if("radio"===o.type){const t=n.querySelector(`input[name="${e.name}"][value="${a}"]`);t&&(t.checked=!0)}else if("checkbox"===o.type){const t=Array.isArray(a)?a:[a];n.querySelectorAll(`input[name="${e.name}"]`).forEach(e=>{e.checked=t.includes(e.value)})}else o.value=a}),n.dataset.draftId=e,notify("Draft loaded!","info"),goToPage(0),setTimeout(()=>applyFormLogic(),100))},window.deleteDraft=function(e){confirm("Delete this draft?")&&(removeDraft(e),notify("Draft deleted"),renderDraftsPanel(),updateDraftsCount())},window.toggleDraftsPanel=function(){const e=document.getElementById("draftsPanelWrapper");e&&(e.style.display="none"===e.style.display?"block":"none","block"===e.style.display&&renderDraftsPanel())},window.switchDataView=function(e){state.currentDataView=e,renderDataContent()},window.setAggregateColumn=function(e){state.settings.aggregateColumn=e,saveToStorage(),renderDataContent(),renderDashboard()},window.refreshData=async function(){notify("Refreshing..."),await loadViewerData(),notify("Refreshed!")},window.downloadCSV=function(){const e="aggregate"===state.currentDataView,t=e?calculateAggregateData():getFilteredData();if(0===t.length)return void notify("No data","error");const n=Object.keys(t[0]).filter(t=>e?"_group"===t||"_period"===t||"_count"===t||!t.startsWith("_"):!t.startsWith("_")||"_timestamp"===t);let a=n.join(",")+"\n";t.forEach(e=>{a+=n.map(t=>`"${String(e[t]||"").replace(/"/g,'""')}"`).join(",")+"\n"});const o=new Blob([a],{type:"text/csv"}),s=URL.createObjectURL(o),i=document.createElement("a");i.href=s,i.download=`${state.settings.title}_${state.currentDataView}_data.csv`,i.click(),URL.revokeObjectURL(s),notify("Downloaded!")},window.goToNextPage=function(e){validateCurrentPage(e)?goToPage(e+1,1):notify("Please fill in all required fields","error")},window.goToPrevPage=function(e){goToPage(e-1,-1)},window.handleCascadeSelect=function(e){const t=e.closest(".cascade-container"),n=t.dataset.cascadeId,a=state.fields.find(e=>e.id===n);if(!a||!a.cascadeData)return;const o=a.cascadeColumns||[],s=parseInt(e.dataset.level),i=e.value;for(let e=s+1;e<o.length;e++){const n=t.querySelector(`select[data-level="${e}"]`);n&&(n.innerHTML=`<option value="">-- Select ${o[e]} --</option>`,n.disabled=!0,n.value="")}const r=t.querySelector('input[type="hidden"]');if(r&&(r.value=""),!i)return;const l={};for(let e=0;e<=s;e++){const n=t.querySelector(`select[data-level="${e}"]`);n&&n.value&&(l[o[e]]=n.value)}const d=a.cascadeData.filter(e=>Object.keys(l).every(t=>e[t]===l[t]));if(s+1<o.length){const e=t.querySelector(`select[data-level="${s+1}"]`);if(e){const t=o[s+1];[...new Set(d.map(e=>e[t]).filter(Boolean))].sort().forEach(t=>{const n=document.createElement("option");n.value=t,n.textContent=t,e.appendChild(n)}),e.disabled=!1}}const c=t.dataset.valueColumn;if(s===o.length-1&&d.length>0){const e=d[0][c]||d[0][o[o.length-1]];r&&(r.value=e)}},window.handleCascadeChange=function(e){const t=e.dataset.cascadeGroup,n=parseInt(e.dataset.cascadeLevel)||0,a=e.value;if(!t)return;const o=state.fields.filter(e=>e.cascadeGroup===t).sort((e,t)=>(e.cascadeLevel||0)-(t.cascadeLevel||0)),s=o[0];if(!s||!s.cascadeData||0===s.cascadeData.length)return;const i=s.cascadeData;for(let e=n+1;e<o.length;e++){const n=document.querySelector(`select[data-cascade-group="${t}"][data-cascade-level="${e}"]`);if(n){const t=o[e]?.cascadeColumn||"";n.innerHTML=`<option value="">-- Select ${t} --</option>`,n.disabled=!0,n.value=""}}if(!a)return;const r={};for(let e=0;e<=n;e++){const n=document.querySelector(`select[data-cascade-group="${t}"][data-cascade-level="${e}"]`),a=o[e]?.cascadeColumn;n&&n.value&&a&&(r[a]=n.value)}const l=i.filter(e=>Object.keys(r).every(t=>e[t]===r[t]));if(n+1<o.length){const e=o[n+1],a=document.querySelector(`select[data-cascade-group="${t}"][data-cascade-level="${n+1}"]`);if(a&&e){const t=e.cascadeColumn;if(t){[...new Set(l.map(e=>e[t]).filter(Boolean))].sort().forEach(e=>{const t=document.createElement("option");t.value=e,t.textContent=e,a.appendChild(t)})}a.disabled=!1}}},window.captureGPS=function(e){const t=e.parentElement,n=t.querySelector(".gps-status"),a=t.querySelector('input[type="hidden"]');n.innerHTML='<span class="inline-icon">'+getIcon("loader",12)+"</span> Getting location...",navigator.geolocation?navigator.geolocation.getCurrentPosition(e=>{const t=`[${e.coords.latitude.toFixed(6)},${e.coords.longitude.toFixed(6)}]`;a.value=t,n.innerHTML='<span class="inline-icon" style="color:#28a745;">'+getIcon("check-circle",12)+"</span> "+t},e=>{n.innerHTML='<span class="inline-icon" style="color:#dc3545;">'+getIcon("x-circle",12)+"</span> "+e.message}):n.innerHTML='<span class="inline-icon" style="color:#dc3545;">'+getIcon("x-circle",12)+"</span> Not supported"},window.setRating=function(e,t){const n=e.parentElement;n.querySelectorAll("span").forEach((e,n)=>e.style.opacity=n<t?"1":"0.3"),n.querySelector("input").value=t},window.activeQRStream=null,window.startQRScanner=async function(e){const t=e.closest(".qr-scanner-container"),n=t.querySelector(".qr-preview"),a=t.querySelector(".qr-video"),o=t.querySelector(".qr-status"),s=t.querySelector('input[type="hidden"]'),i=t.querySelector(".qr-value");o.innerHTML='<span class="inline-icon">'+getIcon("loader",12)+"</span> Starting camera...",n.style.display="block";try{const t=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});if(a.srcObject=t,a.play(),window.activeQRStream=t,o.innerHTML='<span class="inline-icon" style="color:#17a2b8;">'+getIcon("scan",12)+"</span> Point camera at QR code or barcode...","BarcodeDetector"in window){const t=new BarcodeDetector({formats:["qr_code","ean_13","ean_8","code_128","code_39","code_93","upc_a","upc_e","itf","codabar"]}),n=async()=>{if(window.activeQRStream){try{const n=await t.detect(a);if(n.length>0){const t=n[0].rawValue;return s.value=t,i&&(i.textContent=t),o.innerHTML='<span class="inline-icon" style="color:#28a745;">'+getIcon("check-circle",12)+"</span> Scanned!",void stopQRScanner(e)}}catch(e){console.log("Scan error:",e)}window.activeQRStream&&requestAnimationFrame(n)}};n()}else o.innerHTML='<span class="inline-icon" style="color:#dc3545;">'+getIcon("x-circle",12)+"</span> Scanner not supported on this device"}catch(e){o.innerHTML='<span class="inline-icon" style="color:#dc3545;">'+getIcon("x-circle",12)+"</span> Camera error: "+e.message,n.style.display="none"}},window.stopQRScanner=function(e){const t=e.closest(".qr-scanner-container"),n=t.querySelector(".qr-preview"),a=t.querySelector(".qr-video");window.activeQRStream&&(window.activeQRStream.getTracks().forEach(e=>e.stop()),window.activeQRStream=null),a.srcObject=null,n.style.display="none"},window.addEventListener("online",()=>{updateOnlineStatus(),notify("Back online!","success"),syncOfflineData()}),window.addEventListener("offline",()=>{updateOnlineStatus(),notify("You are offline - data will be saved locally","warning")}),init(),initIcons(),updateOnlineStatus();</script></body></html>
